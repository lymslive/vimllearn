<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>8.2 使用异步任务</h1>
    <!-- ## 8.2 使用异步任务 -->
<p>注意：本节所介绍的功能要求 vim 编译包括 <code>+job</code> 特性。</p>
<h3 id="8-2-1-jian-dan-ren-wu-ti-yan">8.2.1 简单任务体验</h3>
<p>前文说到，Vim 的异步任务主要是针对外部命令的。那我们就先以最简单最常见的系统命
令 <code>ls</code> 为例，其功能是列出当前目录下的文件，若在 Windows 操作系统下或可用 <code>dir</code> 
命令代替。</p>
<p>首先请在 shell 中进入一个非空目录，便于实践，并在 shell 中执行如下命令：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">$</span><span> ls
</span></code></pre>
<p>然后启动 vim 中，在 vim 命令行中执行如下命令：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>:!ls
</span></code></pre>
<p>体验一下 vim 直接执行外部命令的现象。与在 shell 中执行几乎是一样的，只是将输出
打印到终端，供用户交互时查看。然而在用脚本编程中，我们一般希望将外部命令的输出
保存到某个变量，便于后续控制与利用。如此可用 <code>system()</code> 函数：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">g:dir_list</span><span> = </span><span style="color:#8fa1b3;">system</span><span>(</span><span style="color:#a3be8c;">&#39;ls&#39;</span><span>)
</span><span>: </span><span style="color:#96b5b4;">echo </span><span style="color:#bf616a;">g:dir_list
</span></code></pre>
<p>当然一般而言，<code>ls</code> 命令执行得足够快，在 VimL 脚本中能很快捕获到其输出。不过我
们暂时忽略外部命令的速率，再来看来如何用异步任务完成类似的任务。</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">OnWorking</span><span>(job, msg)
</span><span>    echomsg </span><span style="color:#a3be8c;">&#39;well work doing:&#39; </span><span style="color:#b48ead;">. </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>msg
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">g:dir_list </span><span style="color:#b48ead;">.</span><span>= </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>msg </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&quot;\n&quot;
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">DoneWork</span><span>(job)
</span><span>    echomsg </span><span style="color:#a3be8c;">&#39;well work done:&#39;
</span><span>    echomsg </span><span style="color:#bf616a;">g:dir_list
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">StartWork</span><span>()
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">g:dir_list</span><span> = </span><span style="color:#a3be8c;">&#39;&#39;
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:option</span><span> = {</span><span style="color:#a3be8c;">&#39;callback&#39;</span><span>: </span><span style="color:#a3be8c;">&#39;OnWorking&#39;</span><span>, </span><span style="color:#a3be8c;">&#39;close_cb&#39;</span><span>: </span><span style="color:#a3be8c;">&#39;DoneWork&#39;</span><span>}
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">g:job_ls</span><span> = </span><span style="color:#8fa1b3;">job_start</span><span>(</span><span style="color:#a3be8c;">&#39;ls&#39;</span><span>, </span><span style="color:#bf616a;">l:option</span><span>)
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>在这个示例中，函数中直接使用全局 <code>g:</code> 变量，并非良好编程规范，这里仅作说明目的
，便于在命令中测试观察。 在命令中输入 <code>:call StarWork()</code> 运行示例。</p>
<p>内置函数 <code>job_start()</code> 用于开启一个异步命令。其第一参数就如同 <code>system()</code> 函数
的参数，指定要运行的外部系统命令。第二个可选参数是个有诸多键的字典，用于配置或
控制该任务的行为。其中最重要的参数就是设置回调函数，在该示例中指定了两个回调函
数。一个是 <code>OnWrking()</code> 在工作进行时调用，每当所执行的任务有输出时就会被调用，
输出会通过第二参数传入回调函数；另一个是 <code>DoneWork()</code> ，在工作完成时调用。当然
应该知道，这两个函数名是我们任意自定义的，名字不重要，关键的魔法是键名，
<code>callback</code> 与 <code>close_cb</code> 标识了对应的函数（引用）在适当的机会被调用。</p>
<p>这两个回调函数为求简单，忽略了第一个作为任务标识的参数，并且仍利用全局变量
<code>g:dir_list</code> ，在工作进行时将外部输出收集（串接）起来，最后在工作完成时一次性
地将其完整地用 VimL 打印出来，或为其他更有价值的利用。这里用 <code>echomsg</code> 而不是
<code>echo</code> 命令是为了能在随后（通过 <code>:message</code> ）查看消息历史记录。不过要注意，虽
然 <code>g:dir_list</code> 在串接时添加了回车符变成多行文本，但 <code>echomsg</code> 仍将其当作一行
输出，于是回车符会被其他可打印符号（<code>^@</code>）代替。可手动执行 <code>:echo g:dir_list</code>
再确认它是多行文本，或用 <code>split()</code> 函数将其分隔到列表中。</p>
<p>另一点要注意的是，并非每次 <code>job_start()</code> 启动任务都得注册这两个回调，根据实际
工作任务情况可在其中一个（或更多）回调函数中处理感兴趣的信息。甚至如果只是想让
某个外部命令在后台默默运行，不关心任何反馈的话，也可以不注册任何回调函数。譬如
在后台用 <code>ctags</code> 更新索引文件。只不过提供回调的话，会使异步任务更有交互感与确
认感，让用户知道后台命令确实在执行了。</p>
<h3 id="8-2-2-job-xuan-xiang-ji-qi-ta-xiang-guan-han-shu">8.2.2 job 选项及其他相关函数</h3>
<p><code>job_start()</code> 的第二参数支持相当多的选项，详情请见 <code>:help job-options</code> ，这里
择其要点解释相关概念。帮助主题中所列的选项，不仅给这个 <code>job_start()</code> 函数使用，
也供更通用的底层“通道” <code>ch_open()</code> 利用，后者在下一节继续介绍。现在只需理解，
任务（<code>job</code>）是通道（<code>channel</code>）的一种特例或具体应用。</p>
<p>任务采用管道（<code>pipe</code>）将外部命令与 vim 联接起来，那就涉及标准输入、标准输出与
标准错误输出这三套件，在其间的消息传递都采用所谓 <code>NL</code> 模式，可以理解为输入输出
都按回车分行的字符串。如果某个输出/输入端是有格式的消息字符串（如 json），则可
通过 <code>in_mode</code> <code>out_mode</code> <code>err_mode</code> 分别设定。不过在大多数情况下，使用默认的
<code>NL</code> 模式就适合，且理解更为自然，当然这实际上取决于所调用的外部命令的需求。</p>
<p>本节开始的示例所谓 <code>callback</code> 回调，其实能同时捕获标准输出与标准错误输出，也就
是假设外部命令直接在 <code>shell</code> 中执行会打印到屏幕终端的所有可见信息。如果想更精
细地区分两者，那就使用 <code>out_cb</code> 与 <code>err_cb</code> 这两种回调，各司其职。</p>
<p>与 <code>close_cb</code> 类似的回调，还有个 <code>exit_cb</code> 回调。从字面上理解，前者是任务关闭
时调用，后者是退出时被调用。<code>exit_cb</code> 回调函数比 <code>close_cb</code> 可多接收一个参数，
表示任务的状态。</p>
<p>任务管道使用输入输出还可以重定向到文件，或在 vim 中打开的一个 buffer，使用
<code>in_io</code> <code>out_io</code> <code>err_io</code> 及相关的选项设置。如果捕获输出不是最终目的，就可避免
在回调函数中将输出保存至 VimL 变量中，直接设置 <code>out_io</code> 输出至 buffer 中呈现更
为直观。</p>
<p>例如，有这么一个命令 <code>tail -f</code> 可用于监控持续增长的日志文件。如果要从 vim 调用
它，在支持异步特性之前，若用 <code>system()</code> 函数，它永远不会返回，那便无用。然而用
<code>job_start()</code> 启动它，再将 <code>out_io</code> 设置为一个 buffer ，就可以达到目的，直接在
vim 中查看增长中的日志。</p>
<p>当然了，还是使用回调函数的工作流更常见，毕竟编程控制上更灵活。如果最终仍想在某
个 vim buffer 中展示输出，quickfix 或 localist 或许也是个更好的选择。譬如异步
执行 <code>grep</code> （或其他更佳的搜索工具），将结果放在 quickfix 中也适于跳转。</p>
<p><code>job_start()</code> 也是有返回值的，返回一个标记，代表这个启动的任务，能传递给其他几
个任务相关的函数，以指明操作哪个任务。<code>job_stop()</code> 停止指定任务，如果启动的外
部命令是设计为死循环永不终止的，也许在 VimL 中就有必要用该函数显式终止任务了。
<code>job_status()</code> 用于查询一个任务的状态：fail 表示任务根本就没成功启动；run 表示
任务正常进行中；dead 表示任务跑完了。<code>job_info()</code> 则可查询有关任务更详细的信息
。</p>
<p>一般来说，任务的选项是要在启动时设置，但也有些选项可以在启动之后，还处于 run
状态时，使用 <code>job_setoptions()</code> 补充选项。这运用场景就有些受限了。最后，还有个
函数 <code>job_getchannel()</code> 用于获得任务底层的通道。</p>
<h3 id="8-2-3-tong-yong-yi-bu-cha-jian-asyncrun">8.2.3 通用异步插件 asyncrun</h3>
<p><code>job</code> 选项与细节繁多，除了帮助文档，另一个绝好的学习方式是参考优秀插件的实现与运
用。这里隆重推荐 <a href="https://github.com/skywind3000/asyncrun.vim">asyncrun.vim</a> ，
出自国人网名“韦一笑”大神。如果只是使用，它已经封装得很好了，直接使用 <code>AsyncRun</code> 
命令即可。如果是想学习异步编程，则该插件也足够轻量，只有一个单文件，也非常适合
参考学习。</p>
<p>比如，浏览大概后直接搜索 <code>job_start</code> 看它是如何启动异步任务的，摘录关键代码如
下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span> = {}
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;callback&#39;</span><span>] = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;s:AsyncRun_Job_OnCallback&#39;</span><span>)
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;close_cb&#39;</span><span>] = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;s:AsyncRun_Job_OnClose&#39;</span><span>)
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;exit_cb&#39;</span><span>] = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;s:AsyncRun_Job_OnExit&#39;</span><span>)
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;out_io&#39;</span><span>] = </span><span style="color:#a3be8c;">&#39;pipe&#39;
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;err_io&#39;</span><span>] = </span><span style="color:#a3be8c;">&#39;out&#39;
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;in_io&#39;</span><span>] = </span><span style="color:#a3be8c;">&#39;null&#39;
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;out_mode&#39;</span><span>] = </span><span style="color:#a3be8c;">&#39;nl&#39;
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;err_mode&#39;</span><span>] = </span><span style="color:#a3be8c;">&#39;nl&#39;
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;stoponexit&#39;</span><span>] = </span><span style="color:#a3be8c;">&#39;term&#39;
</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">g:asyncrun_stop </span><span style="color:#b48ead;">!= </span><span style="color:#a3be8c;">&#39;&#39;
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;stoponexit&#39;</span><span>] = </span><span style="color:#bf616a;">g:asyncrun_stop
</span><span style="color:#b48ead;">endif
</span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">s:async_info</span><span style="color:#b48ead;">.</span><span>range &gt; </span><span style="color:#d08770;">0
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;in_io&#39;</span><span>] = </span><span style="color:#a3be8c;">&#39;buffer&#39;
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;in_mode&#39;</span><span>] = </span><span style="color:#a3be8c;">&#39;nl&#39;
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;in_buf&#39;</span><span>] = </span><span style="color:#bf616a;">s:async_info</span><span style="color:#b48ead;">.</span><span>range_buf
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;in_top&#39;</span><span>] = </span><span style="color:#bf616a;">s:async_info</span><span style="color:#b48ead;">.</span><span>range_top
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:options</span><span>[</span><span style="color:#a3be8c;">&#39;in_bot&#39;</span><span>] = </span><span style="color:#bf616a;">s:async_info</span><span style="color:#b48ead;">.</span><span>range_bot
</span><span style="color:#b48ead;">endif
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:async_job</span><span> = </span><span style="color:#8fa1b3;">job_start</span><span>(</span><span style="color:#bf616a;">l:args</span><span>, </span><span style="color:#bf616a;">l:options</span><span>)
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:success</span><span> = (</span><span style="color:#8fa1b3;">job_status</span><span>(</span><span style="color:#bf616a;">s:async_job</span><span>) </span><span style="color:#b48ead;">!= </span><span style="color:#a3be8c;">&#39;fail&#39;</span><span>)? </span><span style="color:#d08770;">1</span><span> : </span><span style="color:#d08770;">0
</span></code></pre>
<p>可见，它首先是详细构建选项字典，关键的回调函数显然是引用脚本私有函数的。注意在
那个条件分支中设定 <code>in_io</code> 标准输入选项，那是在指定选区时运行 <code>:'&lt;,'&gt;AysncRun</code>
时传入的，把当前 buffer 选定的行供给任务的标准输入。在 <code>job_start()</code> 之后，再
立即调用 <code>job_status()</code> ，可判断任务是否成功启动过。</p>
<p>然后按图索骥，跟踪赋给选项的变量从哪里来，回调函数处理又到哪里去（也正是添加到
<code>quickfix</code> 窗口中）。除此之后，就如常规的 VimL 编程了。</p>
<p>你可以利用该插件体验一下在 vim 中直接执行 <code>make</code> 编译或 <code>grep</code> 搜索：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: AsyncRun make
</span><span>: AsyncRun grep </span><span style="color:#b48ead;">...
</span></code></pre>
<p>对比体验一下在 vim7 之前没有异步支持时只能用类似如下的命令：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>:! make
</span><span>:! grep </span><span style="color:#b48ead;">...
</span></code></pre>
<h3 id="8-2-4-xiao-jie">8.2.4 小结</h3>
<p>异步任务只是 vim8 开始引入的新机制，为解决某些问题尤其是调用外部耗时命令时提供
另一种编程模式。要真正利用好异步机制，自然还取决于整体的 VimL 编程技术，比如如
何有效地管理变量与函数这种基础水平。不过，如果有在其他语言编写过异步回调的经验
，改用 VimL 编写异步任务也是类似的思想，就更容易上手些。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/"><</a>
    

            </div>

            <div class="next-link">
                
    
        <a class="next" href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">></a>
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
