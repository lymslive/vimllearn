<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>8.4 使用配置内置终端</h1>
    <!-- ## 8.4 使用配置内置终端 -->
<h3 id="8-4-1-shi-yong-yi-bu-de-liang-ge-fang-mian">8.4.1 使用异步的两个方面</h3>
<p>本章讨论的是 vim 的异步特性，其实这包含两个方面。其一如何利用 VimL 编程控制异
步任务，（写插件）实现特定的功能。前三节都是围绕这个话题的，从简单到复杂介绍了
vim 提供的三种异步机制，定时器、任务与通道。那可能有点抽象或晦涩，需要与具体的
插件功能结合起来才更好理解，但是基于本书的定位，也不便介绍与解读太复杂的插件。</p>
<p>其二是如何更好地使用 vim 新版本自身提供的异步功能，典型的就是内置终端。作为普
通用户，相对于开发，运用可能是更简单有趣的。本节就是打算跳出复杂的异步编程的曲
折过程，调剂一下，重新回到简单常规的 VimL 调教与定制内置终端，使之更符合个性习
惯，成为日常使用的利器。</p>
<p>当然，这依然是引导性质或经验之谈，详细文档请看 <code>:help terminal</code> 。</p>
<h3 id="8-4-2-nei-zhi-zhong-duan-de-qi-dong">8.4.2 内置终端的启动</h3>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: terminal
</span><span>: terminal bash
</span><span>: terminal python
</span></code></pre>
<p>用 <code>:terminal</code> 命令开启内置终端。其实广义来讲，它可以接受外部命令参数，在内置
终端中运行任意的外部命令，譬如打开一个 python 解释器。默认无参数时就执行
<code>&amp;shell</code> 指定的程序，比如 <code>bash</code> 。</p>
<p>不过一般地，我们提到内置终端，就是指狭义上的在 vim 里面运行一个 shell 。它会横
向分裂一个半屏窗口，在这个特殊的窗口就几乎与外面运行的 shell 一样的操作与功能
，包括比如 <code>.bashrc</code> 的 shell 配置。</p>
<p><code>:terminal</code> 除了可以指定外部命令参数外，还可以接受许多选项，控制诸如内置终端的
窗口大小、位置等各种选项。你可以将自己的偏好启动选项封装起来，自定义一个函数、
命令或快捷键。</p>
<p>此外，除了 vim 命令，还有个 vim 函数 <code>term_start()</code> 用于在编程逻辑中启动一个内
置终端，用法就如 <code>job_start()</code> 一样，给予灵活控制，按需启动终端。</p>
<h3 id="8-4-3-zhong-duan-mo-shi-de-kuai-jie-jian-ying-she">8.4.3 终端模式的快捷键映射</h3>
<p>在打开的内置终端窗口，为了能像外部 shell 那样使用 shell 本身的快捷键，Vim 禁用
了绝大部分快捷键。虽然在内置终端窗口中可以键入 shell 命令，但那不是 vim 的插入
模式也不是命令行模式，所以 <code>imap</code> 与 <code>cmap</code> 都不生效，当然更不可能是普通模式了
。 事实上，Vim 为此专门新定义了一种特殊模式，叫“终端任务”（<code>Terminal-Job</code>）模
式，不妨简称终端模块。如果要为终端模式自定义快捷键，应该用 <code>tmap</code> 系列命令。</p>
<p>不过在动手之前，还是要了解 vim 已经保留了一个特殊键用来切换回 vim 的普通模式；
而且由于前叙原因，也仅保留了一个键。这个键由选项 <code>&amp;termwinkey</code> 给出，默认也是
<code>&lt;C-W&gt;</code> ，因为它的本意正是如何使用 <code>:wincmd</code> 切出终端窗口。于是 <code>&lt;C-W&gt;</code> 引导的
快捷键在终端窗口与普通窗口保持一致的含义，并且附带两个扩展：</p>
<ul>
<li><code>&lt;C-W&gt;w</code> 切到下一窗口，<code>&lt;C-W&gt;W</code> 切到上一窗口，<code>&lt;C-W&gt;p</code> 切到之前所在窗口……</li>
<li><code>&lt;C-W&gt;n</code> 或 <code>&lt;C-W&gt;&lt;C-N&gt;</code> 终端窗口切到普通模式（可以用 hkl 移动了）</li>
<li><code>&lt;C-W&gt;:</code> 从终端窗口进入 vim 命令行，（否则按冒号只是在 shell 提示符后输入冒
号呢）</li>
</ul>
<p>如果不喜欢 <code>&lt;C-W&gt;</code> 这个引导键——比如说因为 <code>&lt;C-W&gt;</code> 在 shell 中是删除前面一个词
的快捷键，故想将 <code>&lt;C-W&gt;</code> 键传给 shell ——那么可以设置 <code>&amp;termwinkey</code> 更换。但一
般不建议修改，保持 Vim 内换窗口操作一致性较为重要，况且换任何键都可能会与
shell 冲突，总之是需要权衡。</p>
<p>从终端的任务模式回到普通模式略为麻烦，要按 <code>&lt;C-W&gt;&lt;C-N&gt;</code> （在已经按下 <code>&lt;C-W&gt;</code>
的情况下，<code>&lt;C-N&gt;</code> 多按或少按那个 <code>ctrl</code> 键差别不大了）。为什么不保留 <code>&lt;Esc&gt;</code>
键回到普通模式呢？大概是 vim 想兼容更多的终端，有些终端用 <code>&lt;Ecs&gt;</code> 作为转义符。
就个人使用经验而言，在 shell 中会经常用到 <code>&lt;Ecs&gt;.</code> （接一个点）快捷键输入上一
条命令最后一个词。不过权衡之下，可以重定义 <code>&lt;Esc&gt;</code> 回到普通模式：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#96b5b4;">tnoremap </span><span>&lt;Esc&gt; &lt;C-\&gt;&lt;C-N&gt;
</span><span style="color:#96b5b4;">tnoremap </span><span>&lt;C-W&gt;b &lt;C-\&gt;&lt;C-N&gt;&lt;C-B&gt;
</span><span style="color:#96b5b4;">tnoremap </span><span>&lt;C-W&gt;n &lt;C-W&gt;:tabnext&lt;CR&gt;
</span><span style="color:#96b5b4;">tnoremap </span><span>&lt;C-W&gt;N &lt;C-W&gt;:tabNext&lt;CR&gt;
</span><span style="color:#96b5b4;">tnoremap </span><span>&lt;C-W&gt;</span><span style="color:#d08770;">1 </span><span>&lt;C-W&gt;:</span><span style="color:#d08770;">1</span><span>tabNext&lt;CR&gt;
</span><span style="color:#96b5b4;">tnoremap </span><span>&lt;C-W&gt;</span><span style="color:#d08770;">2 </span><span>&lt;C-W&gt;:</span><span style="color:#d08770;">2</span><span>tabNext&lt;CR&gt;
</span><span style="color:#b48ead;">...
</span></code></pre>
<p>除了 <code>&lt;Esc&gt;</code> 键外，我还定义了其他几个快捷键。比如使用终端时需要经常上翻查看结
果，就在 <code>&lt;C-W&gt;</code> 引导键后加个 <code>b</code> ，回到普通模式的同时上翻一页。然后我自己用
tabpage （标签页）比较多，所以也用 <code>&lt;C-W&gt;</code> 加数字切到特定的标签页中。当然，明
白了 <code>tnoremap</code> 之后，就能像 <code>nnoremap</code> 一样按自己习惯重定义快捷键了。</p>
<p>另外，按特定方式启动终端也可以自定义方便的快捷键，不过我推荐另一种思路，短命令
，例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#96b5b4;">command</span><span>! -nargs=</span><span style="color:#b48ead;">*</span><span> TT </span><span style="color:#96b5b4;">tab</span><span> terminal &lt;args&gt;
</span><span style="color:#96b5b4;">command</span><span>! -nargs=</span><span style="color:#b48ead;">*</span><span> TV vertical terminal &lt;args&gt;
</span></code></pre>
<p>这意思是用 <code>:TT</code> 命令在另一个标签页打开终端，用 <code>:TV</code> 按纵向分割窗口打开终端。
可以将其想象为 <code>&lt;mapleader&gt;</code> 是 <code>:</code> ，而且冒号本来就要按下 <code>shift</code> 键，再接一
两个大写字母也顺手，只不过最后还要多按 <code>&lt;CR&gt;</code> 回车确认执行命令。然而这另有个好
处是还可以随时增加其他命令行参数（传给 <code>:terminal</code> ），这种灵活性是普通模式下
的快捷键不能达成的。因此，“短命令”适合于替代那些“次常用”的快捷键，毕竟键盘布局
的快捷键资源以及个人的记忆习惯是有限的。</p>
<p>既然内置终端的启动方式可以定制，那么就想如何能在启动终端时才自动定义那些 <code>tmap</code>
快捷键呢？毕竟 <code>tmap</code> 在平时是用不上，也未必是每次打开 vim 都会用到内置终端，
将 <code>tmap</code> （及其他与终端相关的设置）直接写在全局 <code>vimrc</code> 有点“浪费”。vim 显然
也想到了这个需求，很贴心地增加了一个自动命令事件，<code>TerminalOpen</code> 就会在打开内
置终端窗口时触发，于是可将如下事件写在某个合适的事件组（<code>augroup</code>）中：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#96b5b4;">autocmd</span><span>! TerminalOpen </span><span style="color:#b48ead;">*</span><span> call </span><span style="color:#8fa1b3;">OnTermialOpen</span><span>()
</span></code></pre>
<p>将你想要定制内置终端的代码都写在 <code>OnTerminalOpen()</code> 函数中，当然使用 <code>#</code> 形式
的自动加载函数会更好。</p>
<h3 id="8-4-4-nei-zhi-zhong-duan-yu-vim-jiao-hu">8.4.4 内置终端与 vim 交互</h3>
<p>所谓交互，自然是分两方面的。其中从内置终端（的任务中）向 vim 发起交互的需求，
可能来自一个有趣的“哲学”问题：可不可以在内置终端中输入 <code>$ vim file</code> 再启一个
vim 编辑文件呢。那自然是可以的，但在实用中那显得有点愚蠢，不够优雅。于是，就需
要一个机制，从内置终端中向开启它的“宿主” vim 发送消息，令其打开某个文件。</p>
<p>于是 vim 就有了这么个约定（据说来自 emacs），在内置终端运行的程序，只要向标
准输出打印如下序列：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>&lt;Esc&gt;]51;[&quot;drop&quot;, &quot;filenmae&quot;]&lt;07&gt;
</span></code></pre>
<p>实际上就会将 <code>[&quot;drop&quot;, &quot;filenmae&quot;]</code> 传递给宿主 vim ，然后 vim 就知道将该消息解
释为执行 <code>:drop filename</code> 命令。<code>:drop</code> 命令其实与 <code>:edit</code> 命令类似，就是打开
一个文件，只不过如果文件已被打开，就会跳到相应的目标窗口。<code>:drop</code> 命令也就是随
内置终端版本一起增加的，可见它的原意就是想解决这个痛点。</p>
<p><code>Esc</code> 字符是终端的转义符，在 VimL 中固然可以用 <code>&lt;Esc&gt;</code> 表示，但在其他语言（如
C 语言）中，则一般用 <code>\e</code> 表示，或直接用其 ASCII 码（ <code>\x1B</code> 或 <code>\033</code> 即十进
制的 27）表示。</p>
<p>例如，可以在 <code>~/bin/</code> 目录下写个简单的 <code>drop.sh</code> 脚本：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#65737e;">#! /bin/bash
</span><span style="color:#96b5b4;">echo </span><span style="color:#bf616a;">-e </span><span>&quot;</span><span style="color:#a3be8c;">\e]51;[</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">drop</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">, </span><span style="color:#96b5b4;">\&quot;</span><span>$</span><span style="color:#bf616a;">1</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">]\x07</span><span>&quot;
</span></code></pre>
<p>注意传给 vim 的消息要求是 json 模式（见前一节的通道模式），<code>drop</code> 与文件名参数
须按 json 标准用双引号括起。在多数语言或脚本中如果用双引号括起整个序列字符串，
就得将里面的 json 字符串的双引号用 <code>\&quot;</code> 转义。可以用其他任何语言写这个 drop 脚
本，例如等效的 perl 脚本（<code>dorp.pl</code>）可以如下：</p>
<pre data-lang="perl" style="background-color:#2b303b;color:#c0c5ce;" class="language-perl "><code class="language-perl" data-lang="perl"><span style="color:#65737e;">#! /usr/bin/env perl
</span><span style="color:#b48ead;">my </span><span>$</span><span style="color:#bf616a;">filename </span><span>= </span><span style="color:#96b5b4;">shift</span><span>;
</span><span style="color:#96b5b4;">print qq</span><span>{</span><span style="color:#96b5b4;">\x</span><span style="color:#a3be8c;">1B]51;[&quot;drop&quot;, &quot;</span><span>$</span><span style="color:#bf616a;">filename</span><span style="color:#a3be8c;">&quot;]</span><span style="color:#96b5b4;">\x</span><span style="color:#a3be8c;">07</span><span>};
</span></code></pre>
<p>然后为了使用习惯，可以再在 <code>~/bin/</code> 中建个 <code>drop</code> 软链接，指向实用的 drop 脚本
，如：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">$</span><span> chmod +x drop.pl
</span><span style="color:#bf616a;">$</span><span> ln</span><span style="color:#bf616a;"> -s</span><span> drop.pl drop
</span></code></pre>
<p>如果 <code>~/bin</code> 在环境变量 <code>PATH</code> 中，则在 vim 的内置终端中，执行如下命令：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">vim-shell</span><span> $ drop file
</span></code></pre>
<p>就能在宿主 vim 中用 <code>:drop</code> 打开相应的文件。不过这还有个问题。我们在 shell 中
给任何命令输入文件名参数，一般都是当前目录下的文件名。但是 vim 内置终端的当前
目录，很可能与宿主 vim 的当前目录并不相同，于是 drop 命令可能会失效，所以在传
递消息中应该使用绝对路径，以保证能找到正确的文件。为此，可将原来的
<code>~/bin/drop.pl</code> 改为如下：</p>
<pre data-lang="perl" style="background-color:#2b303b;color:#c0c5ce;" class="language-perl "><code class="language-perl" data-lang="perl"><span style="color:#65737e;">#! /usr/bin/env perl
</span><span style="color:#b48ead;">use </span><span>Cwd &#39;</span><span style="color:#a3be8c;">abs_path</span><span>&#39;;
</span><span style="color:#b48ead;">my </span><span>$</span><span style="color:#bf616a;">filename </span><span>= </span><span style="color:#96b5b4;">shift </span><span>or </span><span style="color:#b48ead;">die </span><span>&quot;</span><span style="color:#a3be8c;">usage: dorp filename</span><span>&quot;;
</span><span style="color:#b48ead;">my </span><span>$</span><span style="color:#bf616a;">filepath </span><span>= </span><span style="color:#bf616a;">abs_path</span><span>($</span><span style="color:#bf616a;">filename</span><span>);
</span><span style="color:#96b5b4;">exec </span><span>&quot;</span><span style="color:#a3be8c;">vim </span><span>$</span><span style="color:#bf616a;">filepath</span><span>&quot; </span><span style="color:#b48ead;">unless </span><span>$</span><span style="color:#bf616a;">ENV</span><span>{</span><span style="color:#d08770;">VIM</span><span>};
</span><span style="color:#96b5b4;">print qq</span><span>{</span><span style="color:#96b5b4;">\x</span><span style="color:#a3be8c;">1B]51;[&quot;drop&quot;, &quot;</span><span>$</span><span style="color:#bf616a;">filepath</span><span style="color:#a3be8c;">&quot;]</span><span style="color:#96b5b4;">\x</span><span style="color:#a3be8c;">07</span><span>};
</span></code></pre>
<p>主要改动是利用语言的相关模块获取文件绝对路径，并稍微保护判断下是否是否输入了文
件名参数。另一个改动是倒数第二行 <code>exec ... unless</code> 语句。只有在 vim 的内置终端
才会向宿主 vim 发 drop 消息，如果是从外部普通 shell 使用该脚本，那就会改为启动
vim （进程覆盖当前进程）打开命令行指定的文件，而最后一行再也没机会执行了。从
vim 中启动的内置终端会继承 vim 进程的环境变量，至少它会有 <code>$VIM</code> 这个环境变量
（可以用 <code>:echo $VIM</code> 查看），据此可以判断是内置终端还是外部终端。</p>
<p>当然，如果你熟悉 python ，用 python 写个 <code>drop.py</code> 也是容易的。</p>
<p>在 <code>&lt;Esc&gt;51;[msg]&lt;07&gt;</code> 转义序列中向 vim 传递的消息，除了支持 <code>:dorp</code> 命令，还
支持 <code>:call</code> 命令调用特殊的以 <code>Tapi_</code> 开头的自定义函数（限定函数名规范是为安全
起见）。消息形如 <code>[&quot;call&quot;, &quot;Tapi_funcname&quot;, [argument-list]]</code> 。自定义函数约定
接受两个参数，与内置终端窗口关联的 buffer 编号，以及一个参数，所以如果业务逻辑
需要多个参数，就只能将它们打包在一个列表或字典类型的变量，当作一个参数传入。
Vim 开放这么个接口提供灵活扩展的可能，具体能做什么那当然是用户的实现了。</p>
<h3 id="8-4-5-vim-yu-nei-zhi-zhong-duan-jiao-hu">8.4.5 vim 与内置终端交互</h3>
<p>交互的另一方面，是 vim 向内置终端发消息。</p>
<p>显示，内置终端也是个任务，有着底层的通道，所以始终可以尝试使用上节介绍的
<code>ch_sendraw()</code> 等函数。然而对于内置终端，没必要使用底层的函数，vim 提供更高
层函数 <code>term_sendkeys()</code> 直接向内置终端发送一个字符串，效果如同在终端提示符下
手动键入。注意该函数与 <code>feedkeys()</code> 的区别，后者是相当于向 vim 键入字符串，会
被 vim 截获，并受 <code>tmap</code> 映射影响；而前者是直接向内置终端键入，不受 <code>tmap</code> 影
响。</p>
<p>试验一下，在打开内置终端的窗口中，使用 <code>&lt;C-W&gt;:</code> 进入命令行，输入：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: call </span><span style="color:#8fa1b3;">feedkeys</span><span>(</span><span style="color:#a3be8c;">&#39;ls&#39;</span><span>)
</span></code></pre>
<p>回车执行后，会在内置终端的提示符之后显示 <code>ls</code> 这两个字符，那就是相当于用户通过
vim 界面向内置终端敲了两个字符，但还没敲回车真正发送给内置终端运行。你可以继续
编辑这个命令，比如使用退格键删除之，或在其后增加选项 <code>-l</code> ，然后再按一次回车，
内置终端才能响应执行这个 <code>ls</code> 命令。然后，再 <code>&lt;C-W&gt;:</code> 试试输入：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: call </span><span style="color:#8fa1b3;">term_sendkeys</span><span>(</span><span style="color:#a3be8c;">&#39;&#39;</span><span>, </span><span style="color:#a3be8c;">&#39;ls&#39;</span><span>)
</span></code></pre>
<p>发现效果似乎还是一样，<code>ls</code> 这两字符停在内置终端提示符之后等待执行。需要将回车
键与合在这两个函数的参数中，才是通知内置终端立即执行：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: call </span><span style="color:#8fa1b3;">feedkeys</span><span>(</span><span style="color:#a3be8c;">&#39;ls&#39; </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&quot;\&lt;CR&gt;&quot;</span><span>)
</span><span>: call </span><span style="color:#8fa1b3;">term_sendkeys</span><span>(</span><span style="color:#a3be8c;">&#39;&#39;</span><span>, </span><span style="color:#a3be8c;">&#39;ls&#39; </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&quot;\&lt;CR&gt;&quot;</span><span>)
</span></code></pre>
<p>注意，回车键 <code>&lt;CR&gt;</code> 需要双引号转义。并且 <code>term_sendkeys()</code> 函数要求第一个参数
是指定内置终端的 buffer 编号，空值表示当前内置终端。从用户角度看，如果不涉及（
少量的）被 <code>tmap</code> 映射的键序列，用这两个函数的效果基本相同，但为了安全起见以及
语义明确，向内置终端发消息时，最好用 <code>term_sendkeys()</code> 函数。</p>
<p>在上一节介绍的 ZFVimTerminal 插件有个特性，是从 vim 的命令行中向模拟终端发送命
令。我们也可以借鉴这个思路，实现从 vim 命令行中向内置终端发送命令。当然了，从
内置终端窗口本身再用 <code>&lt;C-W&gt;:</code> 进入命令行输命令就有点多此一举了，反而麻烦。所以
需求应该是从任何一个普通 buffer 窗口，按 <code>:</code> 后在命令行向内置终端发送命令，避
免需要跳到内置终端的麻烦；当内置终端不存在时，显然应该打开一个新的内置终端。</p>
<p>为此，可以封装一个函数，并定义命令调用该函数，大致如下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#96b5b4;">command</span><span>! -nargs=</span><span style="color:#b48ead;">*</span><span> -bang TC call </span><span style="color:#8fa1b3;">useterm#shell#SendShellCmd</span><span>(&lt;bang&gt;</span><span style="color:#d08770;">0</span><span>, &lt;q-args&gt;)
</span><span style="color:#96b5b4;">command</span><span>! -nargs=</span><span style="color:#b48ead;">*</span><span> TCD call </span><span style="color:#8fa1b3;">useterm#shell#SendShellCmd</span><span>(</span><span style="color:#d08770;">0</span><span>, </span><span style="color:#a3be8c;">&#39;cd &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;%:p:h&#39;</span><span>))
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">useterm#shell#SendShellCmd</span><span>(bang, cmd) abort
</span><span style="color:#65737e;">    &quot; save current window
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>bang
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:tab</span><span> = </span><span style="color:#8fa1b3;">tabpagenr</span><span>()
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:win</span><span> = </span><span style="color:#8fa1b3;">winnr</span><span>()
</span><span>    </span><span style="color:#b48ead;">endif
</span><span>
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:found</span><span> = </span><span style="color:#8fa1b3;">useterm#shell#GotoTermWin</span><span>(</span><span style="color:#bf616a;">&amp;shell</span><span>)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#8fa1b3;">empty</span><span>(</span><span style="color:#bf616a;">l:found</span><span>)
</span><span>        :terminal
</span><span>    </span><span style="color:#b48ead;">endif
</span><span>    </span><span style="color:#b48ead;">if</span><span> !</span><span style="color:#8fa1b3;">empty</span><span>(</span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>cmd)
</span><span>        call </span><span style="color:#8fa1b3;">term_sendkeys</span><span>(</span><span style="color:#a3be8c;">&#39;&#39;</span><span>, </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>cmd </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&quot;\&lt;CR&gt;&quot;</span><span>)
</span><span style="color:#65737e;">        &quot; into insert mode to force redraw terminal window
</span><span>        normal! i
</span><span>    </span><span style="color:#b48ead;">endif
</span><span>
</span><span style="color:#65737e;">    &quot; back to origin window
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>bang
</span><span>        </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">l:tab </span><span style="color:#b48ead;">!= </span><span style="color:#d08770;">0 </span><span style="color:#b48ead;">&amp;&amp; </span><span style="color:#bf616a;">l:tab </span><span style="color:#b48ead;">!= </span><span style="color:#8fa1b3;">tabpagenr</span><span>()
</span><span>            </span><span style="color:#96b5b4;">execute </span><span style="color:#bf616a;">l:tab </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39;tabnext&#39;
</span><span>        </span><span style="color:#b48ead;">endif
</span><span>        </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">l:win </span><span style="color:#b48ead;">!= </span><span style="color:#d08770;">0 </span><span style="color:#b48ead;">&amp;&amp; </span><span style="color:#bf616a;">l:win </span><span style="color:#b48ead;">!= </span><span style="color:#8fa1b3;">winnr</span><span>()
</span><span>            </span><span style="color:#96b5b4;">execute </span><span style="color:#bf616a;">l:win </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39;wincmd w&#39;
</span><span>        </span><span style="color:#b48ead;">endif
</span><span>    </span><span style="color:#b48ead;">endif
</span><span style="color:#b48ead;">endfunction </span><span style="color:#65737e;">&quot;}}}
</span></code></pre>
<p>这里，仍然按短命令思想，定义 <code>:TC</code> 用于在内置终端中执行任意命令，就是将其参数
用 <code>term_sendkes()</code> 函数转发给内置终端，并自动添加了回车键。<code>:TC!</code> 加叹号修
饰的话，会回到原来的普通窗口。用 <code>:TCD</code> 跳到内置终端窗口，并自动将内置终端的当
前目录切到原来编辑文件所在目录（就是自动执行 <code>cd</code> 命令啦）。因为 <code>TCD</code> 的用意
就是切到内置窗口，并开始在指定目录下与终端进行交互工作，那肯定是不必跳回原来的
，所以传给实现函数的第一个参数写定为 <code>0</code> 。</p>
<p>查找并切到终端窗口的函数，这里不再列出，主要是通过 <code>&amp;buftype</code> 选项值是否为
<code>terminal</code> 来判断。有兴趣的可以到这个地址查看详细代码：
<a href="https://github.com/lymslive/autoplug/tree/master/autoload/useterm">https://github.com/lymslive/autoplug/tree/master/autoload/useterm</a> 。
如果不习惯短命令，或担心命名名冲突，尽可自行改自己觉得满意的足够长的命名名，或
者再定义个快捷键映射。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/"><</a>
    

            </div>

            <div class="next-link">
                
    
        
        
        
        
            
            
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
                    
                
            
        
            
            
                <a class="next" href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">></a>
                
                
            
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
        
            
            
            
        
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
