<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>9.3 Perl 语言接口开发</h1>
    <!-- ## 9.3\* Perl 语言接口开发 -->
<p>本节将专门讲一讲 <code>if_perl</code> 接口的开发指导与实践经验，虽然只讲 perl ，但其基本
思路对于其他语言接口也可互为参照。</p>
<h3 id="9-3-1-viml-diao-yong-perl-jie-kou-de-ji-ben-liu-cheng">9.3.1 VimL 调用 perl 接口的基本流程</h3>
<p>典型地，假如要使用（perl）语言接口实现某个较为复杂的功能或插件，其调用流程大概
可归纳如下：</p>
<ol>
<li>定义快捷键映射，<code>nnoremap</code> ，这不一定必要，可能直接使用命令也方便；</li>
<li>快捷键调用自定义命令，<code>command</code>；</li>
<li>vim 自定义命令调用 vim 自定义函数；</li>
<li>在 vim 函数中使用 <code>:perl</code> 命令调用 perl 函数；</li>
<li>在 perl 函数中实现业务运算，可能有更长的调用链或引入其他模块；</li>
<li>在 perl 函数使用 VIM 模块将运算结果或其他效果反馈回 vim 。</li>
</ol>
<p>在以上流程中，前三步是是纯 VimL 编程（细究起来，前两步准备动作还只是使用 vim
），第 5 步是纯 perl 编程，而第 4 步与第 6 步就是 VimL 与 perl 的接口过渡。接
口的使用只能按标准规定，打通一种可能，而要直接实现有意义的功能，重点还是回归到
第 5 与第 3 步两门语言的掌握程度上。</p>
<p>整个流程是同步的，当 perl 代码执行完毕后，堆栈上溯，一直回到第 1 步的命令完成
，才算一条 vim 的 <code>Ex</code> 全部完成，然后 vim 继续响应等待用户的按键。</p>
<p>但凡编程，要有作用域的意识，在这第 4 步中，首先是在 VimL 的函数的局部作用域中
，首次进入的 perl 代码，是在 perl 的 <code>main</code> 命名空间。如果在 perl 的后续调用链
中，进入了其他命名空间，再想引用本次 vim 命令（第 2 步）或之前 vim 命令中在
perl <code>main</code> 命名空间定义的变量，就得显式加前缀 <code>main::</code> 或简写 <code>::</code> 也可。在
perl 代码中，使用 VIM 模块，只能直接影响 vim 的全局变量，它无法获知调用 <code>:perl</code> 
命令所处的函数作用域或脚本作用域。如果有这个需求，请约定使用的全局变量，并在
<code>:perl</code> 代码同步返回时，及时从被影响的全局变量更新局部变量保存下来。</p>
<p>另一个基本意识是有关程序的输入输出。从 <code>:perl</code> 开始执行的代码，它的标准输出被
重定向到 vim 的消息区。所以如果打印简单字符，<code>:perl print</code> 与 <code>:echo</code> 效果差不
多。在这里执行的 perl 不应试图从标准输入读取数据，如果需要输入，可以打开文件的
方式（如临时文件，或确定的目标文件），或者利用 VIM 模块直接读取 buffer 内容。</p>
<h3 id="9-3-2-perl-dai-ma-yu-viml-dai-ma-jie-ou">9.3.2 Perl 代码与 VimL 代码解耦</h3>
<p>虽然语言接口允许你将两种语言混用写在一起，但当真正想实现一些较复杂功能时，将两
种语言的代码分别保存在独立的 <code>*.vim</code> 或 <code>*.pl</code> 是更好的代码维护与项目管理方式。
而且也尽量将使用了 <code>VIM</code> 模块的 perl 脚本与未使用 <code>VIM</code> 模块的代码分开。</p>
<p>因为 <code>VIM</code> 模块只能是从 vim 执行的 perl 代码才可用。将那些未使用 <code>VIM</code> 模块的
纯数据运算逻辑的 perl 代码独立开来，方便独立测试，也便于将其复用在非 vim 环境
下的常规 perl 脚本开发中。使用了 <code>VIM</code> 模块的 perl 代码，只方便在 vim 环境下测
试。如果一定要在外部独立测试调试，只能自己提供一个简易模拟版的 <code>VIM.pm</code> ，将在
脚本用到的 <code>VIM::</code> 方法都实现出来（比如就打印调试信息之类）。</p>
<p>如下代码段可以判断 perl 是否运行在 vim 环境（是否通过 <code>:perl</code> 调用的）：</p>
<pre data-lang="perl" style="background-color:#2b303b;color:#c0c5ce;" class="language-perl "><code class="language-perl" data-lang="perl"><span style="color:#b48ead;">package </span><span>main;
</span><span style="color:#b48ead;">our </span><span>$</span><span style="color:#bf616a;">InsideVim </span><span>= </span><span style="color:#d08770;">0</span><span>;
</span><span>{
</span><span>    </span><span style="color:#96b5b4;">eval </span><span>{ </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">Eval</span><span>(</span><span style="color:#d08770;">1</span><span>); };
</span><span>    $</span><span style="color:#bf616a;">InsideVim </span><span>= </span><span style="color:#d08770;">1 </span><span style="color:#b48ead;">unless </span><span>$</span><span style="color:#bf616a;">@</span><span>;
</span><span>}
</span></code></pre>
<p>perl 的 <code>eval</code> 语句块，有类似的 <code>try ... catch</code> 的功能，就是尝试执行 <code>VIM</code> 模
块的随便一个有效的方法，最简单就是 <code>VIM::Eval(1)</code> 了。如果不是从 vim 环境执行
，<code>eval</code> 会出错，出错信息保存在 <code>$@</code> 变量中。如果确实在 vim 环境中，<code>eval</code> 正
常执行，<code>$@</code> 为空，<code>unless</code> 是条件取反，变量 <code>$InsideVim</code> 被置为 1 标记之。</p>
<p>然后就可以根据 <code>$InsideVim</code> 的值来做分支判断了。如果代码只设计在 vim 环境中使
用，当 <code>$InsideVim</code> 为假值时可直接 return 或 exit 。如果特意还是想在非 vim 环
境下通过测试，那就可以在 <code>$InsideVim</code> 为假时引用自写的简易调试版 <code>VIM.pm</code> 。</p>
<p>只为调试用的模拟 <code>VIM</code> 模块大致结构可以如下：</p>
<pre data-lang="perl" style="background-color:#2b303b;color:#c0c5ce;" class="language-perl "><code class="language-perl" data-lang="perl"><span style="color:#65737e;"># File: VIM.pm
</span><span style="color:#b48ead;">package </span><span>VIM;
</span><span>
</span><span style="color:#b48ead;">sub </span><span style="color:#8fa1b3;">DoCommand</span><span>{
</span><span>    </span><span style="color:#b48ead;">my </span><span>$</span><span style="color:#bf616a;">cmd </span><span>= </span><span style="color:#96b5b4;">shift</span><span>;
</span><span>    </span><span style="color:#96b5b4;">print </span><span>&quot;</span><span style="color:#a3be8c;">Will do Vim Ex Command: </span><span>$</span><span style="color:#bf616a;">cmd</span><span style="color:#96b5b4;">\n</span><span>&quot;;
</span><span>}
</span><span>
</span><span style="color:#b48ead;">sub </span><span style="color:#8fa1b3;">Eval</span><span>{
</span><span>    </span><span style="color:#b48ead;">my </span><span>$</span><span style="color:#bf616a;">expr </span><span>= </span><span style="color:#96b5b4;">shift</span><span>;
</span><span>    </span><span style="color:#96b5b4;">print </span><span>&quot;</span><span style="color:#a3be8c;">Will eval Vim expression: </span><span>$</span><span style="color:#bf616a;">expr</span><span style="color:#96b5b4;">\n</span><span>&quot;;
</span><span>    </span><span style="color:#b48ead;">return </span><span>$</span><span style="color:#bf616a;">expr</span><span>;
</span><span>}
</span></code></pre>
<p>也许还应该为 <code>Eval()</code> 函数添加自适应列表环境与标量环境的返回值，还有 Buffer 与
Window 对象的方法，模拟实现都会更复杂。故没必要求全，只根据实际情况，待测试的
脚本用到哪些方法，首先让脚本能编译能运行，再考虑进一步模拟精度的必要性。当然最
可靠的还是在 vim 中整合起来测试效果，只是在 vim 只能交互地手动测试，有时略有不
便。</p>
<p>顺便提一下，使用 <code>if_perl</code> 时，不必显式声明 <code>use VIM;</code> 就能在相关代码中使用
<code>VIM</code> 模块。但使用 <code>if_python</code> ，还是要显式声明 <code>import vim</code> 的。</p>
<h3 id="9-3-3-perl-yu-viml-shu-ju-jiao-huan-de-ji-chong-fang-shi">9.3.3 Perl 与 VimL 数据交换的几种方式</h3>
<p>首先，简单的 perl 代码，如果 print 至标准输出的，在被 vim 调用时是打印到消息区
的，因而可以用重定向消息的方法，将 perl 的标准输出内容捕获至 vim 变量中。例如
，专门写个 <code>ifperl.vim</code> 存些基本工具函数，如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; File: ifperl.vim
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">s:execute</span><span>(</span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>code) abort
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:perl</span><span> = </span><span style="color:#a3be8c;">&#39;perl &#39; </span><span style="color:#b48ead;">.  </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>code
</span><span>    redir =&gt; </span><span style="color:#bf616a;">l:ifstdout
</span><span>    silent! </span><span style="color:#96b5b4;">execute </span><span style="color:#bf616a;">l:perl
</span><span>    redir END
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">l:ifstdout
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>这个函数将封装执行一段 perl 代码，将其标准输出当作一个变量返回（为简明起见，省
略了错误等特殊情况处理）。一般更推荐调用 perl 函数，如此利用 <code>s:execute()</code> 也
很容易封装函数调用：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">s:call</span><span>(func, </span><span style="color:#b48ead;">...</span><span>) abort
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:args</span><span> = </span><span style="color:#8fa1b3;">join</span><span>(</span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span style="color:#d08770;">000</span><span>, </span><span style="color:#a3be8c;">&#39;,&#39;</span><span>)
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:code</span><span> = </span><span style="color:#8fa1b3;">printf</span><span>(</span><span style="color:#a3be8c;">&#39;%s(%s);&#39;</span><span>, </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>func, </span><span style="color:#bf616a;">l:args</span><span>)
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">s:execute</span><span>(</span><span style="color:#bf616a;">l:code</span><span>)
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>实际上，在 vim 命令行向 perl 函数传参数还得注意引号问题，这里也从略。然后，模
拟 <code>:pyfile</code> 实现并未内置支持的 <code>:perlfile</code> 功能，也可简单封装成一个函数，如果
也想关注执行一个 <code>*.pl</code> 可能的输出，可以改用上面的 <code>s:execute()</code> 函数：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">s:require</span><span>(file) abort
</span><span>    </span><span style="color:#96b5b4;">execute </span><span style="color:#8fa1b3;">printf</span><span>(</span><span style="color:#a3be8c;">&#39;perl require(&quot;%s&quot;);&#39;</span><span>, </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>file)
</span><span style="color:#b48ead;">endfunction
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">s:use</span><span>(pm) abort
</span><span>    </span><span style="color:#96b5b4;">execute </span><span style="color:#8fa1b3;">printf</span><span>(</span><span style="color:#a3be8c;">&#39;perl use &quot;%s&quot;;&#39;</span><span>, </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>pm)
</span><span style="color:#b48ead;">endfunction
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">s:uselib</span><span>(path) abort
</span><span>    </span><span style="color:#96b5b4;">execute </span><span style="color:#8fa1b3;">printf</span><span>(</span><span style="color:#a3be8c;">&#39;perl use lib(&quot;%s&quot;);&#39;</span><span>, </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>path)
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>注意，在 perl 中，<code>require</code> 与 <code>use</code> 语句有区别，各有用途。但都涉及搜索路径，
在程序中推荐用 <code>use lib</code> 动态添加。可以将用于 vim 调用的 perl 脚本收集在一个目
录（或专门的插件目录），并用 <code>use lib</code> 添加这个目录，便于 vim 使用。</p>
<p>其次，如果要用到的 perl 脚本，主要是一些工具函数，要利用其返回值的，而不是打印
到标准输出的。这种情况下，若强行在 perl 处加一层打印函数，在 vim 处重定向消息
，那是比较低效也不优雅的。另一个可考虑的替代的办法是专门设计几个全局变量槽让
perl 访问。例如；</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; File: ifperl.vim
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">g:useperl</span><span>#ifperl#scalar = </span><span style="color:#a3be8c;">&#39;&#39;
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">g:useperl</span><span>#ifperl#list = []
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">g:useperl</span><span>#ifperl#dict = {}
</span></code></pre>
<pre data-lang="perl" style="background-color:#2b303b;color:#c0c5ce;" class="language-perl "><code class="language-perl" data-lang="perl"><span style="color:#65737e;"># File: ifperl.pl
</span><span style="color:#b48ead;">sub </span><span style="color:#8fa1b3;">ToVimScalar
</span><span>{
</span><span>    </span><span style="color:#b48ead;">my </span><span>($</span><span style="color:#bf616a;">val</span><span>) = @</span><span style="color:#bf616a;">_</span><span>;
</span><span>    </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">DoCommand</span><span>(&quot;</span><span style="color:#a3be8c;">let g:useperl#ifperl#scalar = &#39;</span><span>$</span><span style="color:#bf616a;">val</span><span style="color:#a3be8c;">&#39;</span><span>&quot;);
</span><span>}
</span><span style="color:#b48ead;">sub </span><span style="color:#8fa1b3;">ToVimList
</span><span>{
</span><span>    </span><span style="color:#b48ead;">my </span><span>($</span><span style="color:#bf616a;">array_ref</span><span>) = @</span><span style="color:#bf616a;">_</span><span>;
</span><span>    </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">DoCommand</span><span>(&quot;</span><span style="color:#a3be8c;">let g:useperl#ifperl#list = []</span><span>&quot;);
</span><span>    </span><span style="color:#b48ead;">foreach my </span><span>$</span><span style="color:#bf616a;">val </span><span>(@$</span><span style="color:#bf616a;">array_ref</span><span>) {
</span><span>        </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">DoCommand</span><span>(&quot;</span><span style="color:#a3be8c;">call add(g:useperl#ifperl#list, &#39;</span><span>$</span><span style="color:#bf616a;">val</span><span style="color:#a3be8c;">&#39;)</span><span>&quot;);
</span><span>    }
</span><span>}
</span><span style="color:#b48ead;">sub </span><span style="color:#8fa1b3;">ToVimDict
</span><span>{
</span><span>    </span><span style="color:#b48ead;">my </span><span>($</span><span style="color:#bf616a;">hash_ref</span><span>) = @</span><span style="color:#bf616a;">_</span><span>;
</span><span>    </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">DoCommand</span><span>(&quot;</span><span style="color:#a3be8c;">let g:useperl#ifperl#dict = {}</span><span>&quot;);
</span><span>    </span><span style="color:#b48ead;">foreach my </span><span>$</span><span style="color:#bf616a;">key </span><span>(</span><span style="color:#96b5b4;">keys </span><span>%$</span><span style="color:#bf616a;">hash_ref</span><span>) {
</span><span>        </span><span style="color:#b48ead;">my </span><span>$</span><span style="color:#bf616a;">val </span><span>= $</span><span style="color:#bf616a;">hash_ref</span><span>-&gt;{$</span><span style="color:#bf616a;">key</span><span>};
</span><span>        </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">DoCommand</span><span>(&quot;</span><span style="color:#a3be8c;">let g:useperl#ifperl#dict[&#39;</span><span>$</span><span style="color:#bf616a;">key</span><span style="color:#a3be8c;">&#39;] = &#39;</span><span>$</span><span style="color:#bf616a;">val</span><span style="color:#a3be8c;">&#39;</span><span>&quot;);
</span><span>    }
</span><span>}
</span></code></pre>
<p>在 perl 中的三种数据类型，标量、列表、散列，分别可对应 VimL 变量的字符串、列表
与字典，并且字符串在可能的情况下都可当作数字使用。当 perl 里的数据需要发往
VimL 时，临时借助事先规定好的这几个全局变量做缓存，只多调用一层转接函数，不影
响原来 perl 函数的使用方式。</p>
<p>最后，其实要考虑的问题，是否真有必要将 perl 数据发还 VimL 。在协作完成一个功能
时，得盘算好哪部分必须在 VimL 处完成，哪部分可集中在 perl 处完成，没必要的中间
结果就别传回 VimL 处理了。</p>
<p>如果真要从 perl 频繁传出大量文本，自己用变量接收也不如用 VIM 内部的 Buffer 方
法有效率。例如，也专门设计一个 buffer，取名 <code>IFPERL.buf</code> ，在 perl 中将需要查
看的文本直接附加到这个 buffer 的末尾：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; File: ifperl.vim
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">g:useperl</span><span>#ifperl#buffer = </span><span style="color:#a3be8c;">&#39;IFPERL.buf&#39;
</span></code></pre>
<pre data-lang="perl" style="background-color:#2b303b;color:#c0c5ce;" class="language-perl "><code class="language-perl" data-lang="perl"><span style="color:#65737e;"># File: ifperl.pl
</span><span style="color:#b48ead;">sub </span><span style="color:#8fa1b3;">ToVimBuffer
</span><span>{
</span><span>    </span><span style="color:#b48ead;">my </span><span>$</span><span style="color:#bf616a;">bufname </span><span>= </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">Eval</span><span>(&#39;</span><span style="color:#a3be8c;">g:useperl#ifperl#buffer</span><span>&#39;);
</span><span>    </span><span style="color:#b48ead;">my </span><span>$</span><span style="color:#bf616a;">buf </span><span>= (</span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">Buffers</span><span>($</span><span style="color:#bf616a;">bufname</span><span>))[</span><span style="color:#d08770;">0</span><span>];
</span><span>    $</span><span style="color:#bf616a;">buf</span><span>-&gt;</span><span style="color:#bf616a;">Append</span><span>($</span><span style="color:#bf616a;">buf</span><span>-&gt;</span><span style="color:#bf616a;">Count</span><span>(), @</span><span style="color:#bf616a;">_</span><span>);
</span><span>}
</span></code></pre>
<p>这里直接将 <code>ToVimBuffer()</code> 函数的参数全部传给 <code>Append()</code> ，便支持同时添加多行
（字符串列表）或一行（标量字符串）至 vim buffer 中。须提醒的是 <code>Append()</code> 方法
的第一参数，不能使用 <code>'$'</code> 表示最后一行，只能是数字，因为这是在 perl 代码中，
<code>'$'</code> 没有特殊行号意义，当作普通字符串转化为数字时，就是 <code>0</code> ，结果就会添加到
buffer 最前面而不是最后面。</p>
<p>这种策略也适于记录被 vim 调用的 perl 代码执行过程的日志，直接发到某个 vim
buffer 中查看。在开发调试时有奇效，比写日志文件更有效，然后由用户再决定有无必
要保存日志。当然，完整的日志功能需要更灵活的控制，如在生产中就应该关闭，不打扰
原则。</p>
<h3 id="9-3-4-xiao-jie">9.3.4 小结</h3>
<p>使用 <code>if_perl</code> 接口混合编程的一个实用示例可参考这个插件：
<a href="https://github.com/lymslive/useperl">useperl</a> 。本节上述引用的代码段也多是从该
插件简化而来的。该插件目前主要利用了 <code>if_perl</code> 实现 perl 语言编写补全，理论上
利用 vim 内嵌的 perl 解释器可达到语义理解级别，只是在具体实现细节上还比较初步
，可能不甚完善。</p>
<p>然后说明一个事实，vim 支持多种语言接口，直接原因并非 VimL 本身设计多厉害（vim
的厉害之处更在其他整体综合上），而是因为那些脚本语言设计良好，方便嵌入其他程序
。例如，perl 与 python 都可提供 C/C++ 扩展，而 vim 就是个 C 语言写的应用程序；
还有 lua 语言最初设计目的就是便于嵌入到其他更大型的程序或服务上。所以 vim 利用
这些脚本语言的开发接口，编入它们的解释器，原非大惊小怪。也许，vim 还正想借这些
语言弥补自 VimL 脚本的不足。</p>
<p>那么，有了这些语言接口，是否就弱化了 VimL 脚本的意义了呢。那也不尽然，有些功能
还是适合用 VimL 来实现，尤其是涉及用户界面接口部分，如快捷键 <code>noremap</code> 与自定
义命令 <code>command</code> 还有 GUI 版本的菜单 <code>menu</code> 。此外，VimL 兼容与移植性更好，毕
竟其他语言接口不是默认编译选项。使用统一的官方 VimL 语言更有利于用户的交流与融
合。</p>
<p>所以，随着 vim 的进化与发展， VimL 语言也应该稳步发展，这将成为 vim 文化与社区
不可或缺的一部分。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/"><</a>
    

            </div>

            <div class="next-link">
                
    
        
        
        
        
            
            
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
                    
                
            
        
            
            
                <a class="next" href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">></a>
                
                
            
            
                
            
                
            
                
            
        
            
            
            
        
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
