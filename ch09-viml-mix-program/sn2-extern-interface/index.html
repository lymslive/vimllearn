<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>9.2 外部语言接口编程</h1>
    <!-- ## 9.2 外部语言接口编程 -->
<h3 id="9-2-1-yu-yan-jie-kou-jie-shao">9.2.1 语言接口介绍</h3>
<p>Vim 支持其他诸多语言接口。这意味着，你不仅可以写 VimL 脚本，也可以使用被支持的
语言脚本。这就相当于在 vim 中内嵌了另一种语言的解释器。当然你不能完全像其他语
言的解释器来使用 vim ，毕竟还是遵守 vim 制定的一些规范，那就是 vim 为该语言提
供的接口。</p>
<p>在 Vim 帮助首页，专门有一段 Interfaces 的目录，列出了 Vim 所支持的语言接口，大
都以 <code>if_lang.txt</code> 命名，其中 <code>lang</code> 后缀指某个具体的（脚本）语言。笔者较熟悉
的脚本语言有 lua、python、perl ，而其他如 ruby、tcl 较少了解。因而在本章打算简
要介绍下 <code>if_lua</code> <code>if_python</code> 与 <code>if_perl</code> 这几个语言接口。（因 python 有两个
版本，故在帮助文档中其实用 <code>if_pyth.txt</code> 命名，避免 python 狭义地指 python2，
不过本文仍习惯使用 python 统称）</p>
<p>一些功能复杂的插件，为了规避 VimL 语言的不足，都倾向于按语言接口采用其他语言来
完成一部分或主要功能。比如，<a href="https://github.com/Shougo/unite.vim">unite</a> 就采
用了 <code>if_lua</code> 接口，后来的升级版 <a href="https://github.com/Shougo/denite.nvim">denite</a>
则采用 <code>if_python</code> 接口，另外推荐一个插件 <a href="https://github.com/Yggdroot/LeaderF">LeaderF</a>
也是用 <code>if_python</code> 写的。这都是不错的实际项目源码，想深入学习的可以参考。</p>
<p>不过采用 <code>if_perl</code> 接口的现代插件较少，笔者鲜有看到。但是笔者偏爱 perl ，所以
在本章剩余篇幅将重点以 <code>if_perl</code> 为主，也算略微弥补一点空白。而且， Vim 为各语
言提供的接口大同小异，思路是一致的。介绍一种语言接口，也期望读者能举一反三。真
要用好某种语言接口，除了要仔细学习 vim 相关的 <code>if_lang.txt</code> 文档，还需要对目标
语言掌握良好，才能方便地在两种环境中来回游弋。</p>
<h3 id="9-2-2-zi-ding-yi-bian-yi-vim-zhi-chi-yu-yan-jie-kou">9.2.2 自定义编译 vim 支持语言接口</h3>
<p>默认安装的 vim 一般不支持语言接口，需要自己重新从源码编译安装。这也其实很简单
，只要修改一些编译配置即可。首先从 vim <a href="https://www.vim.org/">官网</a>或其 github
<a href="https://github.com/vim/vim">镜像</a>下载源代码包，解压后进入 <code>src/</code> 子目录，
<code>vi Makefile</code> 查找并取消如下几行注释：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>CONF_OPT_LUA = --enable-luainterp
</span><span>CONF_OPT_PERL = --enable-perlinterp
</span><span>CONF_OPT_PYTHON = --enable-pythoninterp
</span></code></pre>
<p>原来这几行是被 <code>#</code> 注释的，表示相关语言接口是被禁用的，你所需做的只是删去 <code>#</code>
符号启用功能。当然每个语言接口在 <code>Makefile</code> 都提供了好几个不同的（被注释）选项
备用，各有不同的含义，典型的如动态链接或静态链接。上面示例是打开静态链接编译选
项，含 <code>=dynamic</code> 的表示动态链接编译选项。你只需打开（取消注释）其中一条选项，
一般建议用静态链接编译。动态链接只是减少最后编译出的 vim 程序的大小，或许也略
微减少 vim 运行时所需的内存。在硬盘与内存都便宜的情况下，这都不算问题，用静态
链接可减少依赖，避免版本不兼容的麻烦。</p>
<p>不过 python 语言接口分 python2 与 python3 两个选项，它们既像一个语言又像两个语
言。打开 python3 接口的编译选项是 <code>--enable-python3interp</code> 。注意，你不能同时
打开 python2 与 python3 的静态编译选项，如果想同时支持，只能都用动态链接编译选
项。除非你有绝对理由想同时使用 python2 与 python3 ，还是建议你只使用其中之一。
而且 python2 都是历史原因，以后的趋势都应该都是转向 python3 。</p>
<p>在自定义安装 vim 时，还有个选项推荐打开，就是安装到个人家目录下，不安装到系统
默认的路径下，也就不影响系统其他用户使用的 vim 。只要指定 <code>prefix</code> 即可，一般
也就是打开（取消注释）如下这行：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>prefix = $(HOME)
</span></code></pre>
<p>然后，就可以按 Unix/Linux 源码编译安装程序的标准三部曲执行如下命令了：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">$</span><span> make configure
</span><span style="color:#bf616a;">$</span><span> make
</span><span style="color:#bf616a;">$</span><span> make install
</span></code></pre>
<p>如果你运气足够好，应该直接 make 成功的。如果 make 失败，最可能的原因是系统没有
安装相应的语言开发包，请用系统包管理工具（<code>yum</code> 或 <code>apt-get</code>）安装语言开发包，
如 <code>perl-dev</code> ，注意有些系统为语言开发包名的命名后缀不同，也可能是 <code>perl-devel</code> 。
安装好了所需语言开发包（及可能的其他依赖），再重新 <code>confire</code> <code>make</code> 应该就能成
功了。</p>
<p>在编译成功之后，<code>make install</code> 安装之前，最好检查一下新编译的 vim 是否满足你所
需的特性。执行如下命令：</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">$</span><span> ./vim</span><span style="color:#bf616a;"> --version
</span></code></pre>
<p>在 <code>vim</code> 命令之前添加 <code>./</code> 表示使用当前目录（<code>src/</code> 编译时目录）的 vim 程序，
否则可能会查找到系统原来的 vim 程序。如果打印的版本信息，包含 <code>+perl</code> （或
<code>+lua</code> <code>+python</code>），就表示成功编进了相应的语言接口。当然，你也可以直接不带参数
地启动 <code>./vim</code> 体验一下，并可在 vim 的命令行查看如下命令的输出：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: version
</span><span>: </span><span style="color:#96b5b4;">echo </span><span style="color:#8fa1b3;">has</span><span>(</span><span style="color:#a3be8c;">&#39;perl&#39;</span><span>)
</span><span>: </span><span style="color:#96b5b4;">echo </span><span style="color:#8fa1b3;">has</span><span>(</span><span style="color:#a3be8c;">&#39;python&#39;</span><span>)
</span><span>: </span><span style="color:#96b5b4;">echo </span><span style="color:#8fa1b3;">has</span><span>(</span><span style="color:#a3be8c;">&#39;python3&#39;</span><span>)
</span></code></pre>
<p><code>:version</code> 命令与 shell 命令参数 <code>--version</code> 的输出基本类似。<code>has()</code> 函数用于
检测当前 vim 是否支持某项特性，如果支持返回真值（<code>1</code>），否则假值（<code>0</code>）。
<code>has()</code> 函数也经常用于 VimL 脚本尤其是插件开发中，为了兼容性判断，根据是否支持
某项特性执行不同的代码。</p>
<p>确认无误后，就可以 <code>make install</code> 安装。所谓安装也不外是将刚才编译好的 vim 程
序及其他运行时文件与手册页等文件，复制到相应的目录中。安装的根目录取决于之前
<code>$prefix</code> 选项，如果按之前指导选择了 <code>$(HOME)</code> ，那 vim 就会安装到 <code>~/bin/vim</code>
中。一般建议将个人家目录下的 <code>~/bin</code> 添加到环境变量 <code>$PATH</code> 之前，这样在 shell
启动命令时，首先查找 <code>~/bin</code> 目录下的程序。</p>
<p>当然了，在你决定手动编译 vim 之前，最好在目前默认使用的 vim 中用 <code>:version</code> 与
<code>has()</code> 检测下它是否已经支持相应的特性了，如果已经支持，那就可跳过这里介绍的手
动编译流程了。</p>
<h3 id="9-2-3-yu-yan-jie-kou-de-ji-ben-ming-ling">9.2.3 语言接口的基本命令</h3>
<p>测试某个语言接口是否真的能正常工作，也可直接以相应语言名作为 vim 的命令，执行
一条目标语言的简单语句，例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: perl print $^V
</span><span>: perl print </span><span style="color:#a3be8c;">&#39;Hello world!&#39;
</span><span>: </span><span style="color:#96b5b4;">lua </span><span style="color:#8fa1b3;">print</span><span>(</span><span style="color:#a3be8c;">&#39;Hello world!&#39;</span><span>)
</span><span>: python print </span><span style="color:#a3be8c;">&#39;Hello world!&#39;
</span><span>: python</span><span style="color:#d08770;">3</span><span> print </span><span style="color:#a3be8c;">&#39;Hello world!&#39;
</span></code></pre>
<p>其中第一条语句是打印 <code>if_perl</code> 接口使用的 perl 版本，其后就是使用不同语句打印
喜闻乐见的 <code>Hello world!</code> 了。</p>
<p>语言名如 <code>:perl</code> 也就是相应语言接口的最基本接口命令了，可见它们保持着高度的一
致性，vim 调用相应的语言解释器执行其参数所代表的代码段，所不同的只是各语言的语
法文法了。下面，如无特殊情况，为行文精简，就基本只以 <code>if_perl</code> 为例说明了。</p>
<p>基本命令 <code>:perl</code> 只适合在命令行执行简短的一行 perl 语句（当然，对于 perl 语言，
单行语句也可以很强大）。如果要执行一大块 perl 语句，短合在脚本中用 <code>here</code> 文档
语法，即 VimL 也像许多语言一样支持 <code>&lt;&lt; EOF</code> 标记：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>perl &lt;&lt; EOF
</span><span>print $^V; # 打印版本号
</span><span>print </span><span style="color:#a3be8c;">&quot;$_\n&quot; </span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">@INC</span><span>; # 打印所有模块搜索路径
</span><span>print </span><span style="color:#a3be8c;">&quot;$_ = $ENV{$_}&quot; </span><span style="color:#b48ead;">for</span><span> sort keys </span><span style="color:#b48ead;">%</span><span>ENV; # 打印所有环境变量
</span><span>EOF
</span></code></pre>
<p><code>EOF</code> 只是约定俗成的标记，其实可以是任意字符串标记，甚至可以省略默认就是单个点
<code>.</code> 号。Vim 会从下一行开始读入，直到匹配某行只包含 <code>EOF</code> 标记，将这块内容（长
串字符串）送给 <code>:perl</code> 命令作为参数。换用其他标记的理由，一般是内容本身包含
<code>EOF</code> 避免误解。</p>
<p>不过良好的实践，不推荐将 <code>perl &lt;&lt; EOF</code> 裸写在某个 <code>*.vim</code> 脚本文件中，而应该封
装在一个 VimL 函数中，最好再用 <code>if has</code> 判断保护，如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">PerlFunc</span><span>()
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#8fa1b3;">has</span><span>(</span><span style="color:#a3be8c;">&#39;perl&#39;</span><span>)
</span><span>        perl &lt;&lt; EOF
</span><span>        print $^V;
</span><span>        print </span><span style="color:#a3be8c;">&quot;$_\n&quot; </span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">@INC</span><span>;
</span><span>        print </span><span style="color:#a3be8c;">&quot;$_ = $ENV{$_}&quot; </span><span style="color:#b48ead;">for</span><span> sort keys </span><span style="color:#b48ead;">%</span><span>ENV;
</span><span>EOF
</span><span>    </span><span style="color:#b48ead;">endif
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>注意：<code>EOF</code> 不能缩进，只能顶格写，即整行只能有 <code>EOF</code> 才表示 <code>here</code> 文档结束。
这样封装之后，更能提高代码的健壮性与兼容性。然后就可按普通 VimL 函数一样调用了
<code>:call PerlFunc()</code> 。</p>
<p>当然，每次都写 <code>if has</code> 判断可能有点繁琐，那么可以将这个判断保护提升到更大的范
围内，如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">if </span><span style="color:#8fa1b3;">has</span><span>(</span><span style="color:#a3be8c;">&#39;perl&#39;</span><span>)
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">PerlFunc1</span><span>()
</span><span>    perl code;
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">PerlFunc2</span><span>()
</span><span>    perl code;
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#b48ead;">endif
</span></code></pre>
<p>或者将所有利用到语言接口的代码收集到一个脚本，然后在最开始判断：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">if</span><span> !</span><span style="color:#8fa1b3;">has</span><span>(</span><span style="color:#a3be8c;">&#39;perl&#39;</span><span>)
</span><span>    finish
</span><span style="color:#b48ead;">endif
</span></code></pre>
<p>在 <code>if_lua</code> 或 <code>if_python</code> 接口中，还提供执行整个独立的 <code>*.lua</code> 或 <code>*.py</code> 脚本
文件的命令，如下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>:luafile script</span><span style="color:#b48ead;">.</span><span style="color:#96b5b4;">lua
</span><span>:pyfile script</span><span style="color:#b48ead;">.</span><span>py
</span></code></pre>
<p>但是比较奇怪，<code>if_perl</code> 并没有类似的 <code>:perlfile</code> 命令，要实现类似功能，可以用
<code>:perl require &quot;script.pl&quot;</code> 命令，并且要注意 <code>perl</code> 的模块搜索路径问题。而在
<code>:luafile</code> 或 <code>:pyfile</code> 命令中，查寻命令行中提供的脚本文件，还是 vim 的工作，
取决于 vim 的搜索路径。</p>
<p>另外一个很有用的命令是 <code>:perldo</code> ， 它会遍历指定当前 buffer 范围的每一行（默认
是 <code>1,$</code> ），将 perl 的默认变量 <code>$_</code> 设为遍历到的那行文本（不包括回车换行符）
，如果 <code>:perldo</code> 命令参数的代码段修改了 <code>$_</code> ，它就会替换“当前”行文本。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>:perldo s</span><span style="color:#96b5b4;">/regexp/</span><span>replace/g
</span><span>:</span><span style="color:#b48ead;">%</span><span>s</span><span style="color:#96b5b4;">/regexp/</span><span>replace/g
</span></code></pre>
<p>上面两行语句其实是一样的意义，都是执行全文正则替换，只不过第一行 <code>:perldo</code> 采
用 perl 风格的正则语法，它实际执行的是 perl 语句；第二行 <code>:%s</code> 就是执行 VimL
自己的正则替换。如果你想体会 perl 正则与 VimL 正则有什么异同，或对 perl 正则比
较熟悉，觉得某些情况下用 perl 正则更舒服，就可以用 <code>:perldo s</code> 代替 <code>%s</code> 试试
。</p>
<p>当然，<code>:perldo</code> 所能做的事情远不只 <code>s</code> 替换，<code>s</code> 在 perl 语言中只是一个操作符
。perl 语言的单行语句非常强大，尤其是支持后置 <code>if/for/while</code> 的条件判断或循环
，这就取决于用户的 perl 语言造诣了。</p>
<p>不过 <code>:perldo</code> 命令，与上一节介绍的过滤器机制略有不同，尝试用它实现给文本行编
号的功能，最初的想法可能是：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>:perldo $_ = </span><span style="color:#a3be8c;">&quot;$. $_&quot;
</span></code></pre>
<p>但这不能达到要求，<code>$.</code> 在 <code>:perldo</code> 遍历的每一行中都输出 <code>0</code> ，这说明 perl 并
没有把文本行当成标准输入（或其他输入文件）处理，并没有给 <code>$.</code> 变量自动赋值。改
成如下语句能达到编号需求：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>:perldo $_ = ++$i </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&quot; $_&quot;
</span></code></pre>
<p>看起来有点像 perl 的黑魔法，其实不过是借助了一个变量 <code>$i</code> ，未定义变量当作数字
用时被初始化 <code>0</code> ，然后也支持像 C 语言的前置 <code>++i</code> 语法，然后又将该数字通过点
号 <code>.</code> 与一个字符串连接，代表行号的数字自动转化为字符串。这样创建使用的 <code>$i</code>
将是 perl 的全局变量，在执行完这条语句后，可以再用如下语句：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>:perl print $i
</span></code></pre>
<p>查看 <code>$i</code> 的值，可见它仍保留着最后累加到的行号值。如果再次执行上面的 <code>:perldo</code> 
语句对文本行编号，那起始编号就不对了。需要手动 <code>:perl $i = 0</code> 重置编号。但这也
正意味着，如果要求编号从任意值开始，上述 <code>:perldo</code> 语句就很容易适应。</p>
<p>在 lua 或 python 语言接口中，也有类似 <code>:perldo</code> 的命令。但是它们没有类似 <code>$_</code>
默认变量的机制，<code>:luado</code> 与 <code>:pydo</code> 实际是在循环中为每行隐含调用一个函数，传入
<code>line</code> 与 <code>linenr</code> 参数代表“当前”行文本与行号，然后在参数的代码段中可以利用这
两个参数进行操作，并可用 <code>return</code> 返回一个字符串，取代“当前”行。在写法上没
perl 那么简洁，而且在单行语句中不像函数的地方使用 <code>return</code> 也多少有点违和与出
戏感。</p>
<h3 id="9-2-4-mu-biao-yu-yan-fang-wen-vim">9.2.4 目标语言访问 VIM</h3>
<p>显然，如果使用一种语言接口，只是换一门语言自嗨诸如打印 <code>Hello world</code> 这种是没
有前途的。决定使用一种语言接口时，总是期望能利用那种语言更强大的能力，如更快的
运算速率或更丰富的标准库第三方库功能，完成一系列数据与业务逻辑处理后，最终还是要
通过某种形式反馈到 vim ，对 vim 有所影响才是。</p>
<p>为此，<code>if_lua</code> 与 <code>if_python</code> 都提供了专门的 <code>vim</code> 模块，在目标语言中将 vim 视
为一个逻辑对象，可从那语言代码中直接访问、控制 vim ，如设置 vim 内 buffer 的
文本，执行 vim 的 Ex 命令等。<code>if_perl</code> 也提供类似的模块，名叫 <code>VIM</code>，使用语法
与常规点号调用方法不同而已，perl 使用 <code>::</code> 与 <code>-&gt;</code> 符号。</p>
<p>以 <code>if_perl</code> 为为例，其 VIM 模块提供了如下实用接口：</p>
<ul>
<li><code>VIM::DoCommand({cmd})</code> 从 perl 代码中执行 vim 的 Ex 命令；</li>
<li><code>VIM::SetOption({arg})</code> 设置 vim 的选项，相当于执行 <code>:set</code> 命令；</li>
<li><code>VIM::Msg({msg}, {group}?)</code> 显示消息，相当于 <code>:echo</code> ，但可以指定高亮颜色；</li>
<li><code>VIM::Eval({expr})</code> 在 perl 代码中计算一个 vim 的表达式；</li>
<li><code>VIM::Buffers([{bn}...])</code> 返回 vim 的 buffer 列表或个数；</li>
<li><code>VIM::Windows([{wn}...])</code> 返回 vim 的窗口表表或个数。</li>
</ul>
<p>其中，前三个接口方法只是执行 vim 的命令，perl 代码中不再关注其返回值。后三个方
法是计算与 vim 相关的表达式，需要获得并利用其返回值。而 perl 语言的表达式是有
上下文语境的概念的。</p>
<p><code>VIM::Eval()</code> 方法在标量环境中获得一个 vim 表达式的值，并转化为 perl 的一个标
量值。所谓 vim 表达式，比如 <code>@x</code> 表示 vim 寄存器 <code>x</code> 的内容，<code>&amp;x</code> 表示 vim 的
<code>x</code> 的选项值。当然简单的 <code>1+2</code> 也是 vim 的表达式，但这种平凡的表达式直接在
perl 代码中求值也是一样的意义，没必要使用 <code>VIM::Eval()</code> 了。Vim 中的环境变量
<code>$X</code> 也与 perl 中 <code>$ENV{X}</code> 等值。 perl 的标量值具体地讲就是数字或字符串。但如
果该方法在列表语境中求值，则结果也是一个列表，特别地是二元列表：</p>
<pre data-lang="perl" style="background-color:#2b303b;color:#c0c5ce;" class="language-perl "><code class="language-perl" data-lang="perl"><span>($</span><span style="color:#bf616a;">success</span><span>, $</span><span style="color:#bf616a;">value</span><span>) = </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">Eval</span><span>(...);
</span><span>@</span><span style="color:#bf616a;">result </span><span>= </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">Eval</span><span>(...);
</span><span style="color:#b48ead;">if</span><span>($</span><span style="color:#bf616a;">result</span><span>[</span><span style="color:#d08770;">0</span><span>]) { </span><span style="color:#bf616a;">make_use_of </span><span>$</span><span style="color:#bf616a;">result</span><span>[</span><span style="color:#d08770;">1</span><span>] };
</span></code></pre>
<p>返回结果的第一个值表示 <code>Eval</code> 求值是否成功，毕竟参数给定的 vim 表达式有可能非
法，如果成功，第二值才是实际可靠的求值结果。如果确信求值有意义，可直接用标量变
量接收 <code>VIM::Eval()</code> 的返回值，那就是求值结果，可简化写法，省略成功与否的判断
。</p>
<p><code>VIM::Buffers()</code> 与 <code>VIM::Windows()</code> 的上下文语境就更易理解了，它符合 perl 的
上下文习惯：本来是数组的变量，在标量上下文表示数组的大小。所以不带参数的
<code>VIM::Buffers()</code> 返回所有 buffer 的列表，或在标量语境下返回 buffer 数量。如果
提供参数（可以一个或多个），就根据参数筛选 buffer 列表。如果想获取某个特定的
buffer，也得通过在列表结果中取索引，例如：</p>
<pre data-lang="perl" style="background-color:#2b303b;color:#c0c5ce;" class="language-perl "><code class="language-perl" data-lang="perl"><span>$</span><span style="color:#bf616a;">mybuf </span><span>= (</span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">Buffers</span><span>(&#39;</span><span style="color:#a3be8c;">file.name</span><span>&#39;))[</span><span style="color:#d08770;">0</span><span>]
</span></code></pre>
<p>你得保证 <code>file.name</code> 至少匹配一个 buffer，否则返回空列表，再对空列表取索引 <code>[0]</code>
是未定义的值。而且一般建议参数给精确，能且只能匹配一个 buffer ，否则如果匹配多
个，按 vim 的 <code>bufname()</code> 函数的行为，在歧义时也返回空。如果给的参数是表示
buffer 编号的数字，一般能保证唯一，只要是有效的 buffer 编号。给这个方法传多个
参数时，就返回相应参数个数的 buffer 列表，例如：</p>
<pre data-lang="perl" style="background-color:#2b303b;color:#c0c5ce;" class="language-perl "><code class="language-perl" data-lang="perl"><span>@</span><span style="color:#bf616a;">buf </span><span>= </span><span style="color:#bf616a;">VIM</span><span>::</span><span style="color:#bf616a;">Buffers</span><span>(</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">4</span><span>, &#39;</span><span style="color:#a3be8c;">file.name</span><span>&#39;, &#39;</span><span style="color:#a3be8c;">file2.name</span><span>&#39;)
</span></code></pre>
<p>就将取得一系列指定的 buffer 对象，存入于 <code>@buf</code> 数组中。</p>
<p>一旦获得 buffer 对象，就可以用对象的方法，操作它所代表的相应的 vim buffer：</p>
<ul>
<li><code>Buffer-&gt;Name()</code> 获得 buffer 的文件名；</li>
<li><code>Buffer-&gt;Number()</code> 获得 buffer 编号；</li>
<li><code>Buffer-&gt;Count()</code> 获得 buffer 的文本行数；</li>
<li><code>Buffer-&gt;Get({lnum}, {lnum}?, ...)</code> 获取 buffer 内的一行或多行文本；</li>
<li><code>Buffer-&gt;Delete({lnum}, {lnum}?)</code> 删除一行或一个范围内的所有行；</li>
<li><code>Buffer-&gt;Append({lnum}, {line}, {line}?, ...)</code> 添加一行多多行文本；</li>
<li><code>Buffer-&gt;Set({lnum}, {line}, {line}?, ...)</code> 替换一行或多行文本；</li>
</ul>
<p>Window 对象也有自己的方法，请查阅相应文档，这里就不再罗列了。此外，还提供两个
全局变量用于操作当前 buffer 与当前窗口：</p>
<ul>
<li><code>$main::curbuf</code> 表示当前 buffer ；</li>
<li><code>$main::curwin</code> 表示当前窗口。</li>
</ul>
<p>由于 <code>:perl</code> 命令执行的 perl 代码，就默认在 <code>main</code> 的命名空间（包）内，所以一
般情况下可简写为 <code>$curbuf</code> 与 <code>$curwin</code> 。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/"><</a>
    

            </div>

            <div class="next-link">
                
    
        <a class="next" href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">></a>
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
