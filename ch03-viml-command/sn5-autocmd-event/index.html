<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>3.5 自动命令与事件</h1>
    <!-- ## 3.5\* 自动命令与事件 -->
<p>前面章节介绍了自定义快捷键（<code>:map</code>）与自定义命令（<code>:command</code>），这都是响应玩家
的主动输入而快速做些有用的工作。这也算是对 Vim 的 UI 设计吧。谁说只有图形界面
才算 UI 呢，况且在 gVim 中的自定义菜单，也确实与自定义命令或映射很相似呀。</p>
<p>本节要介绍的自动命令，却是让 Vim 在某些事件发生时自动做些工作，而不必再手动激
活命令了。当然了，自动命令在生效前，也是需要定义的。</p>
<h3 id="zi-dong-ming-ling-de-ding-yi-yu-fa">自动命令的定义语法</h3>
<p>自动命令用 <code>:autocmd</code> 这个内置命令定义，它至少要求三个参数：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">autocmd</span><span> {event} {pat} {cmd}
</span></code></pre>
<ul>
<li><code>{event}</code> 就是 Vim 预设的可以监测到的事件，比如读写文件，切换窗口等。</li>
<li><code>{pat}</code> 这是模式条件的意思，一般指是否匹配当前文件。</li>
<li><code>{cmd}</code> 就是事件发生且满足条件时，要自动执行的命令。</li>
</ul>
<p>在一个命令中可以有多个事件，事件名用逗号分开，且逗号前后不能有空格。模式也可能
以逗号分隔为多个模式。因为<code>{event}</code> 与 <code>{pat}</code> 都相当于是 <code>:autocmd</code> 的单个参
数，其内不能有空格。但最后部分 <code>{cmd}</code> 可以有空格。</p>
<p>一般情况下，<code>{cmd}</code> 就是合法的 ex 命令，将它拷贝到命令行也能手动执行那种。不过
<code>{cmd}</code> 中可能含有一些特殊标记 <code>&lt;&gt;</code> ，在执行前会替换成实际值，这才大大增加了自
动命令的灵活性，而非只能执行静态命令。</p>
<p>在 vim 内部，相当于为每个事件 <code>{event}</code> 维护了一个列表，每当用 <code>:autocmd</code> 为该
事件定义了一个自动命令，就将这个命令加到列表中。然后每当事件发生，就遍历这个命
令列表，如果它满足相应的 <code>{pat}</code> 条件，就会执行这个 <code>{cmd}</code> 命令。</p>
<p>因此，每发生一个事件，vim 都可能自动执行许多命令。就比如文件类型检测与语法高亮
着色，就是通过自动命令实现的。当你安装一些复杂插件，可能会自动执行更多的命令。
而我们自己用 <code>:autocmd</code> 定义的自动命令，只是添加在原来的命令列表之后，做些自定
义的额外工作。</p>
<p>与此前的 <code>:map</code> 与 <code>:command</code> 一样，退化的 <code>:autocmd</code> 是查询功能：</p>
<ul>
<li><code>:autocmd {event} {pat}</code> 列出与事件及模式相关的自动命令。</li>
<li><code>:autocmd * {pat}</code> 列出满足某个模式的所有事件的自动命令。</li>
<li><code>:autocmd {event}</code> 列出与某事件相关的所有自动命令，不论模式。</li>
<li><code>:autocmd {event} *</code> 与 <code>:autocmd {event}</code> 等效，<code>*</code> 就表示匹配所有。</li>
<li><code>:autocmd</code> 列出所有自动命令。</li>
</ul>
<p>叹号修饰的 <code>:autocmd!</code> 命令用于删除自动命令，参数意义与退化命令一样：</p>
<ul>
<li><code>:autocmd! {event} {pat}</code> 根据事件与模式删除自动命令。</li>
<li><code>:autocmd! * {pat}</code> 只根据模式条件删除自动命令。</li>
<li><code>:autocmd! {event}</code> 只根据事件删除命令。</li>
<li><code>:autocmd! {event} *</code> 只根据事件删除命令。</li>
<li><code>:autocmd!</code> 删除所有自动命令。</li>
</ul>
<p>但是，叹号也可以修饰完整的非退化的 <code>:autocmd</code> ，就如定义自定义模式一样：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">autocmd</span><span>! {event} {pat} {cmd}
</span></code></pre>
<p>它表示先将满足事件 <code>{event}</code> 与模式 <code>{pat}</code> 的所有自动命令删除，然后添加自动命
令 <code>{cmd}</code> 。因此这是覆盖式的定义自动命令，此后，在满足相应事件与模式时，就只
会执行这一个自动命令了。依前文介绍，在定义命令与函数时建议用覆盖式的叹号修饰命
令 <code>:command!</code> 与 <code>:function!</code>。但对于自动命令，还是慎重用覆盖式的 <code>:autocmd!</code>
，因为可能无法从本条语句判断会覆盖掉什么自动命令。</p>
<h3 id="zi-dong-ming-ling-zu">自动命令组</h3>
<p>自动命令组 <code>augroup</code> 是组织管理自动命令的有效手段。为理解自动命令组是有必要的
，先回顾上一小节所介绍的自动命令机制，在未利用命令组的情况下，会发生什么不良后
果。</p>
<p>因为 <code>:autocmd</code> 定义自动命令时是将其添加到自动命令列表末尾的，所以如果在脚本如
<code>vimrc</code> 中定义了自动命令，随后又重新加载了该脚本，那自动命令列表中就会出现两项
重复的自动命令了。对于某些“安全”的自动命令，重复执行不外是浪费效率而已，但有些
自动命令在第二次执行却有可能引发错误呢。</p>
<p>其次，用 <code>:autocmd!</code> 删除自动命令时，它是删除<em>所有</em>自动命令。即使加了事件与模
式两个限制条件，也无法避免影响扩大化，因为别的插件或 Vim 官方插件也可能为相同
的事件与模式定义的一些有用的自动命令啊。</p>
<p>为了解决这个管理问题，引入了自动命令组的概念。自动命令组名字是用以标记一个自动
命令组的符号，取名规则就按 VimL 变量名的规范吧（虽然帮助文档中说似乎可以用任意
字符串作为组名，除了空白字符），不要用奇怪的字符，同时也是大小写敏感的。然后两
个特殊的自动命令组名 <code>END</code> 与 <code>end</code> 是保留的，有着特殊意义。</p>
<p>在不发生理解歧义下，我们就用自动命令组名表示一个自动命令组吧，且在本节中，不妨
用“组名”来作为自动命令组名的简写吧。</p>
<p>于是，在定义自动命令的 <code>:autocmd</code> 命令中，还支持一个可选的组名参数，它紧接命令
之后，而在 <code>{envent}</code> 事件之前：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">autocmd</span><span> [group] {event} {pat} {cmd}
</span></code></pre>
<p>正因为组名是 <code>:autocmd</code> 的第一个参数，可有可无，当省略时，第一个参数就是事件名
了。所以我们选取组名时，还要避免与事件名（这是 Vim 预设的范围集）重名，以避免歧
义。</p>
<p>在定义自动命令时，如果指定了 <code>[group]</code> 组名参数，就表示将所定义的自动命令添
加到这个自动命令组中。你可以认为每个组都为不同事件维护了不同的自动命令列表，同
一事件在不同组内关联着各自不同的命令列表。</p>
<p>对于删除自动命令的 <code>:autocmd!</code> 变异命令，也同样支持在第一个参数中插入可选的组
名。在指定组名后，就表示只删除该组内的自动命令（当然可再限定事件与模式）。</p>
<p>那么，在缺省组名参数时，<code>:autocmd</code> 与 <code>:autocmd!</code> 又怎样工作的呢。其实它是针对
当前组添加或删除自动命令的。那么当前组又是什么东西呢？它是用 <code>:augroup</code> 命令选
定的：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">augroup</span><span> {name}
</span></code></pre>
<p>在执行这个命令之后，<code>{name}</code> 就是当前组名了。当 <code>{name}</code> 组名此前尚不存在时，
也会自动创建一个组，然后再选择这个组作为当前组。此后 <code>:autocmd</code> 或 <code>:autocmd!</code>
若不指定组名参数，就用 <code>{name}</code> 替代了。</p>
<p>那么，在第一次使用 <code>:augroup</code> 选定当前组名之前，当前组又是什么呢？那就是默认组
（default group）了。默认组没有名字，你要把它想象为空字符串也行。或者形式地说
，默认组名是 <code>END</code> 或 <code>end</code>，因为在以下命令表示选择默认组名：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">augroup</span><span> END
</span></code></pre>
<p>因此，在脚本中定义自动命令的一般规范是这样的：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">augroup</span><span> SPECIFIC_GROUP
</span><span>    </span><span style="color:#96b5b4;">autocmd</span><span>!
</span><span>    </span><span style="color:#96b5b4;">autocmd</span><span> {event} {pat} {cmd}
</span><span style="color:#b48ead;">augroup</span><span> END
</span></code></pre>
<p>首先选定一个组，紧接着用 <code>:autocmd!</code> 删除该组内原来所有旧的自动命令，然后用
<code>:autocmd</code> 重新定义新的自动命令，可能有多条 <code>:autocmd</code> 自动命令，最后用 <code>END</code>
选回默认的（无名）组。这样，即使这个脚本重新加载，这个组内的自动命令也正是在这
块脚本内所能看到的这些自动命令了。</p>
<p>当然了，你的组名不要别的组冲突。建议依据脚本文件名或插件名定义组名，且用大写字
母，因为组名很重要，但其实又不必写很多次，故用大写字母表示合适。而且，尽量把自定
义命令写在一块，不要分散。</p>
<p>这样，在组内定义的自动命令就有了局部特性，相当于局部自动命令，而在组外的（无名
默认组）自动命令，就相当于全局自动命令。在编程的任何时刻，都尽量用局部的东西，
少用全局的东西。就自动命令而言，除了直接在命令行临时测试下什么自动命令，在脚本
插件中，永远不在默认的无名“全局”组定义自动命令。</p>
<p>另外提一点，退化的查询命令 <code>:autocmd</code> 在缺省组名参数时，不是依据当前组，而是列
出所有组内的自动命令。这与定义或删除自动命令时的缺省行为不同。这也好理解，因为
只是查询，还是希望尽可能查出更多，而修改操作，却要尽可能缩小影响范围。</p>
<p>还有，组名只影响定义与删除自动命令的操作，但不影响事件触发自动命令。即不管定义
在哪个组内，事件触发时，并且检测满足模式后，就能执行相应的自动命令。</p>
<h3 id="shi-yong-shi-jian">使用事件</h3>
<p>Vim 会监测大量事件，详细列表请查看文档 <code>:help autocmd-events</code>，这里只介绍几种
常用的事件。事件名不分大小写，然而建议按文档中的名字使用事件。</p>
<ul>
<li>读事件。有很多相似但略有细微差别的事件，<code>BufNewFile</code> 指创建新文件，<code>BufRead</code>
指读入文件。一般用这两个就可以了。若有更多控制需求，可用 <code>BufReadPre</code> 与
<code>BufReadPost</code>，这些事件一般会在 <code>:edit</code> 等命令时触发。若用 <code>:read</code> 命令，可
触发 <code>FileReadPre</code> 与 <code>FileReadPost</code> 事件。</li>
<li>写事件。<code>:w</code> 写入当前文件时触发 <code>BufWrite</code> 事件，部分写入（如 <code>'&lt;,'&gt;w file</code>
）则触发 <code>FileWrite</code> 事件。</li>
<li>窗口事件。新建窗口触发 <code>WinNew</code>，进入窗口触发 <code>WinEnter</code>，离开窗口前触发
<code>WinLeave</code> 事件。</li>
<li>标签页事件。类似窗口事件有 <code>TabNew</code> <code>TabEnter</code> <code>TabLeave</code>。</li>
<li>整个编辑器启动与离开事件：<code>VimEnter</code> <code>VimLeave</code>。</li>
<li>文件类型事件，当 <code>&amp;filetype</code> 选项被设置时触发 <code>FileType</code>。</li>
</ul>
<p>举些例子。为了方便，直接在命令行中定义自动事件了，只为简单测试。不过首先也创建
一个组吧，比如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">augroup</span><span> TEST
</span><span>: </span><span style="color:#b48ead;">augroup</span><span> END
</span></code></pre>
<p>在这里，先是创建并选定 <code>TEST</code> 为当前组，然后什么也没干又用 <code>END</code> 选回默认组。
此后我们定义自动命令时都将显式地指这在 <code>TEST</code> 组上操作。你也可以先不用
<code>:augroup END</code>，保持当前组为 <code>TEST</code>，只为了想在之后的 <code>:autocmd</code> 缺省组名？但
是在命令行操作中说不定会触发加载其他插件，这样就会改变当前组名了。所以为了原子
操作的独立性，还是先选回默认组吧，也避免后来忘了执行 <code>:augroup END</code>。</p>
<p>然后定义一个自动命令：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">autocmd</span><span> TEST BufNewFile,BufRead </span><span style="color:#b48ead;">*</span><span> echomsg </span><span style="color:#a3be8c;">&#39;hello world!&#39;
</span></code></pre>
<p>这里显式指定在 <code>TEST</code> 组内定义自动命令，<code>:autocmd</code> 只能使用已存在的组，所以我
们之前才要用 <code>:augroup TEST</code> 然后又 <code>:augroup END</code> 的“空操作”。<code>BufNewFile</code> 与
<code>BufRead</code> 经常同时用，这样不管是打开编辑已存在的文件，还是新建文件都能触发。在
<code>{pat}</code> 部分我们先简单用 <code>*</code> 表示匹配所有。最后的 <code>{cmd}</code> 部分仅是打印一条消息
。</p>
<p>现在请试试打开另一个文件，或切换另一个 buffer，看看会不会打出“Hello World!”的
消息。如果消息被其他后续消息覆盖而看不到，请用 <code>:message</code> 打开消息区（可能还须
用 <code>G</code> 翻到最后）再看是否有这个记录。</p>
<p>再定义另一个自动命令，在打开 vim 脚本文件中显示不同的消息：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">autocmd</span><span> TEST BufNewFile,BufRead </span><span style="color:#b48ead;">*.</span><span>vim echomsg </span><span style="color:#a3be8c;">&#39;hello vim!&#39;
</span></code></pre>
<p>然后用 <code>:e $MYVIMRC</code> 打开你的启动配置文件，看看有什么欢迎消息？似乎仍是打印“
Hello World!”，而不是“Hello vim!”？那么请用 <code>:echo $MYVIMRC</code> 查看下你的配置文
件是哪个文件，一般应该是 <code>~/.vimrc</code> 或 <code>~/.vim/vimrc</code>，它并不是以 <code>.vim</code> 作为
后缀的文件名呢。所以不能匹配 <code>*.vim</code> 这个模式。</p>
<p>那么手动打开一个确实以 <code>.vim</code> 为后缀的文件再试试看吧，或者新建一个 vim 文件 <code>:e none.vim</code>。不出意外的话，你应该会看到两条消息，“Hello World!”与“Hello vim!”都
打印了，因为它确实同时满足刚才定义的两个自动命令啊，所以两个都执行了。然后再试
试 <code>:e none.VIM</code>，新建一个文件以大写的 <code>.VIM</code> 为后缀名。这也不会触发“Hello
vim!”，可见文件模式是区别大小写的，它未能匹配到 <code>.VIM</code>。关于模式的细节，下一小
节再详叙。</p>
<p>为了避免消息太多，我们先把刚才两个自动命令删除了，再定义另外一个自动命令：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">autocmd</span><span>! TEST
</span><span>: </span><span style="color:#96b5b4;">autocmd</span><span> TEST BufNewFile,BufRead </span><span style="color:#b48ead;">*</span><span> echomsg </span><span style="color:#a3be8c;">&#39;hello &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;afile&gt;&#39;</span><span>)
</span></code></pre>
<p>这里，<code>&lt;afile&gt;</code> 表示在触发自动命令时，所匹配的那个文件名（一般是当前文件名）。
再试试打开文件，会打印什么欢迎消息？</p>
<p>切记：在用 <code>autocmd!</code> 删除命令时，要加上组名 <code>TEST</code>，否则可能会删去一些定义在
默认组的自动命令。</p>
<p>写文件事件也一样定义自动命令：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">autocmd</span><span> TEST BufWrite </span><span style="color:#b48ead;">*</span><span> echomsg </span><span style="color:#a3be8c;">&#39;bye &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;afile&gt;&#39;</span><span>)
</span></code></pre>
<p>然后随便编辑一个文件，用 <code>:w</code> 写入，是否能预期的“bye ...”消息。很可能看不到的
。因为 <code>BufWrite</code> 事件是在开始写的时刻触发，然后写完后 vim 一般会自动再打印另
一条消息显示写入多少字节。消息被覆盖了！但用 <code>:message</code> 再翻到末尾应该就能看到
了。那么我们把事件改为写之后试试：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">autocmd</span><span> TEST BufWritePost </span><span style="color:#b48ead;">*</span><span> echomsg </span><span style="color:#a3be8c;">&#39;goodbye &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;afile&gt;&#39;</span><span>)
</span></code></pre>
<p>再看看写文件时会提示什么消息。顺便说一下，<code>BufWritePre</code> 事件与 <code>BufWrite</code> 其实
是等效的。如果没有特殊需要，建议用 <code>BufWrite</code> 比较简便。</p>
<p>然后再举个切换窗口的自动事件：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">autocmd</span><span> TEST WinEnter </span><span style="color:#b48ead;">*</span><span> echomsg </span><span style="color:#a3be8c;">&#39;Enter Window: &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">winnr</span><span>()
</span><span>: </span><span style="color:#96b5b4;">autocmd</span><span> TEST WinLeave </span><span style="color:#b48ead;">*</span><span> echomsg </span><span style="color:#a3be8c;">&#39;Leave Window: &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">winnr</span><span>()
</span></code></pre>
<p>这里 <code>winnr()</code> 函数将取得当前窗口编号。定义完这两个自动事件后，请将你的 vim 分
裂出多个窗口，在窗口间切换，以及关闭多余窗口，看看会有什么消息提示（用
<code>:message</code> <code>G</code> 确认消息）。由此你应该能得到结论，切换窗口时先触发 <code>WinLeave</code>
事件，再触发 <code>WinEnter</code> 事件。</p>
<p>其他事件就不一一举例了，请自行对感兴趣的事件进行测试。然后在实际写插件或脚本时
，若想实现某个自动功能，先查阅文档，找个合适的事件，理解它的触发时机。如果 Vim
没有提供合适的事件，可能自动命令就无能为力了。不过幸运的是，Vim 已经提供了大量
的事件，应该能满足绝大部分需求了。或者，当你功夫足够深时，可以从近似的事件入手
进而曲线救国。</p>
<p>再次提醒，如果是在脚本中定义自动命令，请按以下规范写：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; save in somefile.vim
</span><span style="color:#b48ead;">augroup</span><span> TEST
</span><span>    </span><span style="color:#96b5b4;">autocmd</span><span>!
</span><span>    </span><span style="color:#96b5b4;">autocmd </span><span>BufNewFile,BufRead </span><span style="color:#b48ead;">*</span><span> echomsg </span><span style="color:#a3be8c;">&#39;hello &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;afile&gt;&#39;</span><span>)
</span><span>    </span><span style="color:#96b5b4;">autocmd</span><span> BufWrite </span><span style="color:#b48ead;">*</span><span> echomsg </span><span style="color:#a3be8c;">&#39;bye &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;afile&gt;&#39;</span><span>)
</span><span>    </span><span style="color:#96b5b4;">autocmd</span><span> BufWritePost </span><span style="color:#b48ead;">*</span><span> echomsg </span><span style="color:#a3be8c;">&#39;goodbye &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;afile&gt;&#39;</span><span>)
</span><span style="color:#b48ead;">augroup</span><span> END
</span></code></pre>
<p>在 <code>:augroup</code> 块内不必再指定 <code>TEST</code> 组名了，虽然也可以在每个 <code>:autocmd</code> 命令重
复加上这个组名，但是建议省略。因为万一以后因为某种原因要改组名，却忘记了同步修
改里面的每个组名，那就麻烦了。</p>
<p>所以，把 <code>:augroup</code> 与 <code>:augroup END</code> 当作像 <code>:function!</code> 与 <code>:endfunction</code> 一
样的独立单元块吧。只不过里面的命令不是由显式的 <code>:call</code> 调用，而是 vim 根据事件
自动调用了。于是，很显然地，自动命令组名应像（全局）函数名一样，不要与其他组名
冲突。</p>
<p>在实用的自动命令中，<code>{cmd}</code> 部分一般是调用一个工作函数，以简化 <code>:autocmd</code> 的语
法，而把复杂的逻辑实现放在函数中。特殊标记如 <code>&lt;afile&gt;</code> 表示匹配的文件名，在触
发自动命令时才展开。但有个例外，<code>&lt;sfile&gt;</code> 表示的是定义该自动命令时所在脚本文件
（假设你不是把自动命令放在函数中定义，一般应该是这样）。同时，在 <code>{cmd}</code> 部分
也可以用 <code>&lt;SID&gt;</code> 表示当前定义脚本范围的元素，比如 <code>s:Function</code>。</p>
<h3 id="wen-jian-mo-shi">文件模式</h3>
<p>定义自动命令时 <code>:autocmd</code> 的第二参数（可选组名除外），即 <code>{pat}</code> 是文件模式的
意思。它不同于正则表达式，而像是操作系统的文件名通配符。即 <code>*</code> 表示任意字符，
<code>?</code> 表示单个字符。详细符号意义请查看 <code>:help file-pattern</code>。这里只强调几点需要
注意的地方：</p>
<ul>
<li>逗号表示多个模式的或意义。如 <code>*.c,*.h,*cpp</code> 表示 <code>c/c++</code> 文件。</li>
<li>如果模式中没有路径分隔符 <code>/</code>，则只匹配文件名。</li>
<li>如果模式中包含 <code>/</code> 则要匹配文件全路径名。如 <code>/vim/src/*.c</code> 只匹配位于
<code>/vim/src/</code> 目录下的 c 文件，这可能是 Vim 源代码的工程文件。而 <code>*/src/*.c</code>
则匹配任意目录下的子目录 <code>src/</code> 内的 c 文件，可能表示任意一 c 语言工程内的源
文件。</li>
<li>一些命令如 <code>:edit </code> 会将其参数内的环境变量（如<code>$MYVIMRC</code>）与特殊寄存器（如
<code>%</code> 与 <code>#</code>）展开，则在将实际文件名展开后再匹配自动命令中的文件模式。</li>
</ul>
<p>如果文件模式 <code>{pat}</code> 用一个特殊参数 <code>&lt;buffer&gt;</code> 代替，则表示定义了一个只局部于
特定 buffer 的自动命令。这又有几个变种：</p>
<ul>
<li><code>&lt;buffer&gt;</code> 所定义的自动命令影响当前 buffer，即只有在当前 buffer 才能触发。</li>
<li><code>&lt;buffer=N&gt;</code> 这里 <code>N</code> 是一个数字，表示只影响编号为 <code>N</code> 的 buffer。用 <code>:ls</code>
命令或 <code>bufnr()</code> 函数可以查看 buffer 的编号，那算是唯一不变的 id。</li>
<li><code>&lt;buffer=abuf&gt;</code> 这里的 <code>&lt;abuf&gt;</code> 是在触发自动命令时的特殊标记，如同 <code>&lt;afile&gt;</code>
表示触发的文件，而 <code>&lt;abuf&gt;</code> 表示触发的 buffer 编号。这个参数只在当自动命令中
定义另一个自动命令时有用。</li>
</ul>
<p>例如，<code>:autocmd BufNewFile * autocmd CursorHold &lt;buffer=abuf&gt;  echo 'hold'</code> 表
示每当新建一个文件（<code>BufNewFile</code>事件）时，就为该文件 buffer 定义一个自动命令，
该自动命令的意图是每当 <code>CursorHold</code> 事件触发（光标停留一段时间），就打印一个消
息。</p>
<p>相对之下，<code>&lt;buffer&gt;</code> 参数更简单易懂，如该参数能满足局部自动命令的要求，优先使
用这个吧。例如，将 <code>:autocmd {event} &lt;buffer&gt;</code> 命令放在某个函数内，先通过其他
命令切换到正确的 buffer 内，再调用这个函数为该 buffer 定义局部自动命令。由于这
已经是局部自动命令了，加不加组名的影响都不那么大了。</p>
<h3 id="qi-ta-ti-shi">其他提示</h3>
<ul>
<li>自动命令是相对高级的功能，可用 <code>has('autocmd')</code> 判断你的 Vim 版本是否已编译
了这个功能，或 <code>:version</code> 看输出是否有 <code>+autocmd</code>。</li>
<li>文件类型检测的自动命令定义在 <code>filetypedetect</code> 组内，当你想创造新文件类型时，
也可往这个组内添加自动命令，如  <code>:autocmd filetypedetect *.xyx setfiletype xfile</code>。但没事不要误用 <code>:autocmd!</code> 删除这个组内的其他自动命令。</li>
<li>嵌套的自动命令。默认情况下，自动命令中使用的命令如 <code>:e</code> <code>:w</code> 不再继续触发读
写事件，但是加上 <code>nested</code> 可选参数，可允许嵌套。如 <code>:autocmd {event} {pat} nested {cmd}</code> 使得在执行 <code>{cmd}</code> 时有可能继续触发自动命令（不过有最大嵌套层
数限制，除非必要，慎用）。<code>nested</code> 可选参数应位于 <code>{cmd}</code> 之前，只有保持
<code>{cmd}</code> 在最后部分，才方便在自动命令使用必要的空格啊。</li>
<li>自动命令也可以手动调用，当你觉得有这需求时再去查文档吧， <code>:doautocmd</code> 与
<code>:doautoall</code>。</li>
<li>太多自动命令有可能降低效率，因此有个选项 <code>&amp;eventignore</code> 可以指定忽略某些事件
。这不会删除自动命令，但有些事件不会触发了，相应自动命令也就不会执行了。在一
个命令之前附加 <code>:noautocmd {cmd}</code> 可临时使得本次执行 <code>{cmd}</code> 时不会触发自动命
令。如 <code>:noautocmd w</code> 在这次写入过程中，不会触发写事件。</li>
</ul>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch03-viml-command/"><</a>
    

            </div>

            <div class="next-link">
                
    
        <a class="next" href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">></a>
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
