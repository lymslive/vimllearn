<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>3.4 execute 与 normal</h1>
    <!-- ## 3.4 execute 与 normal -->
<p>为什么这两个命令值得单独拿出来讲，因为它们使得其他大部分 Vim 基本命令变得可编
程，用 VimL 编程。不仅是更高层次上的流程控制，更可以控制单个命令的执行，控制所
要执行的命令或参数。简单地说，就是可利用 VimL 语言的一切特性，拼接并生成将要执
行的 ex 命令，然后真正执行它。</p>
<ul>
<li><code>:execute</code> 将 VimL 的字符串（值）当作命令执行。</li>
<li><code>:normal</code> 用 ex 命令的方式执行普通命令。</li>
</ul>
<h3 id="ji-ben-shi-yi-execute">基本释义：execute</h3>
<p>还是通过例子来说明。<code>:execute 'map x y'</code> 相当于直接执行命令 <code>:map x y</code>。当然这
似乎没什么用，多套层 <code>:execute</code> 似乎写起来还更复杂。但是我们可以这样写：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> lhs = </span><span style="color:#a3be8c;">&#39;x&#39;
</span><span>: </span><span style="color:#96b5b4;">let</span><span> rhs = </span><span style="color:#a3be8c;">&#39;y&#39;
</span><span>: </span><span style="color:#96b5b4;">execute </span><span style="color:#a3be8c;">&#39;map &#39; </span><span style="color:#b48ead;">.</span><span> lhs </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39; &#39; </span><span style="color:#b48ead;">.</span><span> rhs
</span></code></pre>
<p>似乎还更复杂了是不？然而，这背后的思想在于，<code>lhs</code> 与 <code>rhs</code> 都是变量，我们可以
根据需求计算出它们值，然后再定义相应的映射。这就可以灵活地动态地执行 ex 命令了
。一般情况下，我们会把 <code>:execute</code> 命令写在脚本或函数中，比如写个叫
<code>s:BuildMap()</code> 的函数封装一下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">s:BuildMap</span><span>() abort
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:lhs</span><span> = </span><span style="color:#a3be8c;">&#39;x&#39;
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:rhs</span><span> = </span><span style="color:#a3be8c;">&#39;y&#39;
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:map</span><span> = </span><span style="color:#a3be8c;">&#39;nnoremap&#39;
</span><span>    </span><span style="color:#96b5b4;">execute </span><span style="color:#bf616a;">l:map </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39; &#39; </span><span style="color:#b48ead;">. </span><span style="color:#bf616a;">l:lhs </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39; &#39; </span><span style="color:#b48ead;">. </span><span style="color:#bf616a;">l:rhs
</span><span style="color:#65737e;">    &quot; 或者下面这行语句等效
</span><span>    </span><span style="color:#96b5b4;">execute </span><span style="color:#bf616a;">l:map l:lhs l:rhs
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p><code>:execute {expr}</code> 这是 <code>:execute</code> 的正式语法，它后面接一个表达式。vim 首先计
算出这个表达式的值，一般期望它是个字符串，如果不是字符串也会自动转为字符串。然
后执行这个字符串。</p>
<p>事实上它可以跟多个表达式，<code>:execute {expr1} {expr2}</code>，vim 会先求出各个表达式的
值，再拼接成一个字符串，中间有个空格。如果你不确定这个自动拼接机制，或者不想在
相邻表达式之间多加个空格，则可以用 VimL 的字符串连接操作符，一个点号 <code>.</code>，这样
就可以自己把握要或不要这个空格了。</p>
<p>在上个示例中，我们将函数内的局部变量直接赋值了（常量字符串），这仅为说明
<code>:execute</code> 的用法特征。更好的封装做法是利用函数参数，例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">s:BuildMap</span><span>(</span><span style="color:#96b5b4;">map</span><span>, lhs, rhs) abort
</span><span>    </span><span style="color:#96b5b4;">execute a</span><span style="color:#b48ead;">:</span><span style="color:#96b5b4;">map a</span><span style="color:#b48ead;">:</span><span>lhs </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>rhs
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>把函数体简化为一条语句了。当然更健壮的做法应该先检测一下 <code>a:map</code> 参数是否为合法
的映射命令，以避免一些灾难错误。而且真正的映射命令可能还不止由这三部分组成，还
可能有很多类似 <code>&lt;buffer&gt;</code> 这样的特殊参数呢，不过这里暂不考虑了。</p>
<p>当把眼光向外拓展，函数参数怎么来？那就把 VimL 当作普通脚本语言（类似 python
perl lua 这种脚本思想），根据需求计算变量的值，传递参数调用函数就可以了。</p>
<h3 id="ji-ben-shi-yi-normal">基本释义：normal</h3>
<p>那么 <code>:normal</code> 命令又有何妙用。因为 VimL 本质上只是 ex 命令的组合，原则上在
vim 脚本中只能使用 ex 命令。但是 Vim 的基本模式是普通模式，有很多基本操作在普
通模式用普通命令可以很方便地达成，但在 ex 命令行模式（或脚本中）却可能一时找不
到对应的命令来实现相同功能，或者可以实现却写起来麻烦。</p>
<p>这时 <code>:normal {commands}</code> 命令就来帮忙了。它将其后的 <code>{commands}</code> 参数当成是在
普通模式下按下的字符（键）序列来解释。比如我们知道在普通模式下用 <code>gg</code> 跳到首行，
用 <code>G</code> 跳到末行。可有什么 ex 命令来完成这任务吗？有肯定有，至少可以调用函数
<code>cursor()</code> 来放置光标，但是用 <code>:normal</code> 似乎更简明：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: normal gg
</span><span>: normal G
</span></code></pre>
<p>要注意与 <code>:execute</code> 命令不同的是，<code>:normal</code> 的参数 <code>{command}</code> 它不是个表达式
，它就表示字面上看到的字符。如果写成 <code>:normal &quot;gg&quot;</code> 反而错了，因为在普通模式下
，前两个字符（按键）<code>&quot;g</code> 是取寄存器 <code>g</code> 的意思呢。</p>
<p><code>:normal! {commands}</code> 的叹号变种，表示后面的 <code>{commands}</code> 不受映射的影响。因为
正常用户使用 vim 时都会在 <code>vimrc</code> 中定义相当多的映射，所以 <code>:normal</code> 命令会
继续根据映射来再次查寻将要执行的（普通）命令。这往往使得结果不可预测，所以一般
情况下建议使用 <code>:normal!</code> 而非 <code>:normal</code>。</p>
<p>不过，使用 <code>:normal</code> 还是有些限制的，毕竟不能完全像普通模式那样的使用效果。最重
要的一点是 <code>:normal</code> 命令必须完整。如果命令不完整，vim 自动在最后添加 <code>&lt;Esc&gt;</code>
或 <code>&lt;Ctrl-c&gt;</code> 返回普通模式，以保持完整性。完整性不太好定义，那就举例说几个不完
整的：</p>
<ul>
<li>操作符在等待文本对象时不完整。如果执行 <code>:normal! d</code> 什么事都不会发生。因为在
普通模式下 <code>d</code> 会等待用户继续输入文本对象。而用 <code>:normal</code> 来执行时，就无从等
待，结果就是像按下 <code>d</code> 后又按下 <code>&lt;Esc&gt;</code> 取消了。但是 <code>:normal! dd</code> 能正确完
成删除一行的操作。</li>
<li>用 <code>:normal</code> 命令进入插入模式操作后，会自动 <code>&lt;Esc&gt;</code> 回到普通模式，不会停留在
插入模式。例如 <code>:normal! Ainsert something</code> 会在当前行末增加一些字符串，但是
整个命令结束后，不能期望它还在插入模式，它会回到普通模式。</li>
<li>在 <code>:normal</code> 后面用冒号进入命令行模式并输入一些命令，却不能以想当然的方式执
行。比如输入 <code>:normal! :map</code> 后按回车，它并不会执行 <code>:map</code> 命令列出映射。因
为它相当于在命令行输入 <code>:map</code> 后按 <code>&lt;Ctrl-c&gt;</code> 取消了，并不是按回车执行了。你
必须用个技巧将回车符添加到 <code>:map</code> 之后才行，直接按回车是执行 <code>:normal!</code> 这条
命令的意思。这样输入：<code>:normal! :map^M</code> 再按回车就可以了，其中 <code>^M</code> 表示回车
符，通过按 <code>&lt;C-v&gt;&lt;CR&gt;</code>两个键才能输入。</li>
</ul>
<p>总之，<code>:normal</code> 命令执行完毕后，会保证仍回到普通模式。也因此不能通过 <code>Q</code> 键进
入 <code>Ex 模式</code>。</p>
<h3 id="execute-normal-lian-yong">execute + normal 联用</h3>
<p>正如上面看到，<code>:normal</code> 命令后的参数（普通命令按键序列），只适于可打印字符，对
于特殊字符，须用 <code>&lt;C-v&gt;</code> 转义后才能输入，这不太方便。但是可用 <code>:execute</code> 命令
再套一层，因为它接收的字符串表达式，当用双引号引起字符串时，特殊字符可用 <code>\</code> 转
义。比如为解决上面那个难题 <code>:normal! :map</code>：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">execute </span><span style="color:#a3be8c;">&#39;normal! &#39; </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&quot;:map\&lt;CR&gt;&quot;
</span></code></pre>
<p>但是，<code>execute + normal</code> 的基友组合，远不止是为了输入特殊字符这么简单。
<code>:execute</code> 还可以使 <code>:normal</code> 也用上变量。例如，我们可以用 <code>5gg</code> 来跳到第 5 行
，用 <code>:normal</code> 命令也能跳到特定行：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: normal! </span><span style="color:#d08770;">5</span><span>gg
</span><span>: normal! </span><span style="color:#d08770;">10</span><span>gg
</span></code></pre>
<p>然而，你无法直接动态地改变 5 或 10 这个数字，借且 <code>:execute</code> 就可以了：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> count = </span><span style="color:#d08770;">15
</span><span>: </span><span style="color:#96b5b4;">execute </span><span style="color:#a3be8c;">&#39;normal! &#39; </span><span style="color:#b48ead;">.</span><span> count </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39;gg&#39;
</span></code></pre>
<p>再举个例子，在第 1.2 节，我们在普通模式下生成了一个满屏尽是 “Hello world!” 的
文章，回顾如下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#d08770;">20</span><span>aHello World!&lt;ESC&gt;
</span><span>yy
</span><span style="color:#d08770;">99</span><span>p
</span></code></pre>
<p>现在，我们用 VimL 语言编程的思路，利用 <code>execute + normal</code> 重新生成。既是编程，
封装成函数才好：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">HelloWorld</span><span>(row, col) abort
</span><span>    normal G
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:word</span><span> = </span><span style="color:#a3be8c;">&#39;Hello World!&#39;
</span><span>    </span><span style="color:#b48ead;">for</span><span> i </span><span style="color:#b48ead;">in </span><span style="color:#8fa1b3;">range</span><span>(</span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>row)
</span><span>        normal! o
</span><span>        </span><span style="color:#96b5b4;">execute </span><span style="color:#a3be8c;">&#39;normal! &#39; </span><span style="color:#b48ead;">. </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>col </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39;a&#39; </span><span style="color:#b48ead;">. </span><span style="color:#bf616a;">l:word
</span><span>    </span><span style="color:#b48ead;">endfor
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>函数接收两个参数，分别表示生成多少行，与每行多少个“Hello World!”。在函数体中，
<code>:normal! G</code> 先将光标定位到当前 buffer 末尾，以便在末尾插入许多 “Hello World!”
。然后对每一行循环，每行循环中，先用 <code>o</code> 命令打开新行，再用 <code>:execute</code> 拼接重
复多次的 <code>a</code> 命令。</p>
<p>你可以用函数调用命令 <code>:call HelloWorld(100,20)</code> 来达到 1.2 节的效果，并且可调
用行列数生成不同规模的“Hello World!”。</p>
<h3 id="yong-execute-ding-yi-ming-ling">*用 execute 定义命令</h3>
<p>在上一节中，我们推荐了一种定义命令的常用范式：<code>call WorkFunc(&lt;f-args&gt;)</code>。这里
再介绍另一种定义命令的有趣范式：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>:</span><span style="color:#96b5b4;">command</span><span>! {cmd} </span><span style="color:#96b5b4;">execute </span><span style="color:#8fa1b3;">ParseFunc</span><span>(&lt;q-args&gt;)
</span></code></pre>
<p>形式上只是把 <code>:call</code> 命令换成了 <code>:execute</code> 命令。将自定义命令 <code>{cmd}</code> 的所有参
数打包传给函数 <code>ParseFunc()</code>，期望它返回一个字符串，再用 <code>:execute</code> 执行它。</p>
<p>这另有什么妙用呢？一般情况下，用 <code>:execute</code> 可能只想到用它来执行常规的 ex 命令
，但是也并不妨碍它用于执行 VimL 的特殊语法命令。例如，<code>:let</code> 命令只能一次创建
一个变量，下面这种“连等号”的语法是错误的：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> x = y = z = </span><span style="color:#d08770;">1
</span></code></pre>
<p>但我们可以试着自定义一个 <code>:LET</code> 命令，让它允许这个语法：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; File: ~/.vim/vimllearn/clet.vim
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">ParseLet</span><span>(args)
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:lsMatch</span><span> = </span><span style="color:#8fa1b3;">split</span><span>(</span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>args, </span><span style="color:#a3be8c;">&#39;\s*=\s*&#39;</span><span>)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#8fa1b3;">len</span><span>(</span><span style="color:#bf616a;">l:lsMatch</span><span>) &lt; </span><span style="color:#d08770;">2
</span><span>        </span><span style="color:#b48ead;">return </span><span style="color:#a3be8c;">&#39;&#39;
</span><span>    </span><span style="color:#b48ead;">endif
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:value</span><span> = </span><span style="color:#8fa1b3;">remove</span><span>(</span><span style="color:#bf616a;">l:lsMatch</span><span>, </span><span style="color:#d08770;">-1</span><span>)
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:lsCmd</span><span> = []
</span><span>    </span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">l:var </span><span style="color:#b48ead;">in </span><span style="color:#bf616a;">l:lsMatch
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:cmd</span><span> = </span><span style="color:#a3be8c;">&#39;let &#39; </span><span style="color:#b48ead;">. </span><span style="color:#bf616a;">l:var </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39; = &#39; </span><span style="color:#b48ead;">. </span><span style="color:#bf616a;">l:value
</span><span>        call </span><span style="color:#8fa1b3;">add</span><span>(</span><span style="color:#bf616a;">l:lsCmd</span><span>, </span><span style="color:#bf616a;">l:cmd</span><span>)
</span><span>    </span><span style="color:#b48ead;">endfor
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">join</span><span>(</span><span style="color:#bf616a;">l:lsCmd</span><span>, </span><span style="color:#a3be8c;">&#39; | &#39;</span><span>)
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#96b5b4;">command</span><span>! -nargs=+ LET </span><span style="color:#96b5b4;">execute </span><span style="color:#8fa1b3;">ParseLet</span><span>(&lt;q-args&gt;)
</span></code></pre>
<p>这代码有点长，适合保存在脚本文件中再 <code>:source</code>。先解释下函数 <code>ParseLet()</code> 的意
思：它首先将输入参数按等号（两边允许空格）分隔成几部分；将最后部分当作是值，其
余每部分当作一个变量，然后构造命令用 <code>:let</code> 为每个变量赋相同的值；最后将几个赋
值语句用 <code>|</code> 连接并返回，<code>|</code> 是在同一行分隔多个语句的意思。</p>
<p>有了 <code>ParseLet</code> 函数后，再定义一个命令 <code>:LET</code>，现在就可以尝试下连续赋值了：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: LET x = y = z = </span><span style="color:#d08770;">1
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> x
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> y z
</span><span>: </span><span style="color:#96b5b4;">echo </span><span style="color:#8fa1b3;">ParseLet</span><span>(</span><span style="color:#a3be8c;">&#39;x = y = z = 1&#39;</span><span>)
</span></code></pre>
<p>可见 <code>x</code> <code>y</code> <code>z</code> 三个变量都已经被赋值为 <code>1</code> 了。最后一个 <code>:echo</code> 语句是为了显
示 <code>:LET</code> 如何工作的，实质上它转化为 <code>let x=1 | let y=1 | let z=1</code> 多个赋值语
句了。</p>
<p>那么，新定义的 <code>:LET</code> 能否正确处理变量的作用域呢，我们写个函数测试一下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">TestLet</span><span>()
</span><span>    LET </span><span style="color:#bf616a;">l:x</span><span> = y = z = </span><span style="color:#a3be8c;">&#39;abc&#39;
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;l:x =&#39; </span><span style="color:#bf616a;">l:x </span><span style="color:#a3be8c;">&#39;x =&#39;</span><span> x
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;l:y =&#39; </span><span style="color:#bf616a;">l:y </span><span style="color:#a3be8c;">&#39;y =&#39;</span><span> y
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;l:z =&#39; </span><span style="color:#bf616a;">l:z </span><span style="color:#a3be8c;">&#39;z =&#39;</span><span> z
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>call </span><span style="color:#8fa1b3;">TestLet</span><span>()
</span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;x =&#39;</span><span> x </span><span style="color:#a3be8c;">&#39;y =&#39;</span><span> y </span><span style="color:#a3be8c;">&#39;z =&#39;</span><span> z
</span></code></pre>
<p>我们在函数中也定义了 <code>x</code> <code>y</code> <code>z</code> 这三个局部变量。结果表明，用 <code>:LET</code> 定义的局
部变量与全局变量也互不冲突的，可放心使用。</p>
<p>不过，<code>:execute</code> 命令毕竟还是有所限制的。只适合用于定义一些简单的“宏命令”，并
不能妄图重定义一些复杂的语法结构。而且，<code>:execute</code> 的效率也不高。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch03-viml-command/"><</a>
    

            </div>

            <div class="next-link">
                
    
        <a class="next" href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">></a>
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
