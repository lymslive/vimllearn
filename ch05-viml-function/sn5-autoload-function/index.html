<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>5.5 自动函数</h1>
    <!-- ## 5.5 自动函数 -->
<p>自动加载函数（<code>:h autoload-functions</code>）自 Vim7 版本就支持了。不过它涉及的机制
就不仅仅是函数本身了，所以放在本章之末再讨论。其实自动加载机制已经在第一章就作
为 VimL 语言的一个特点介绍过了，请回头复习一下，在那里已经将自动函数的加载流程
描叙的比较细致了。</p>
<p>本节继续讲解有关自动函数的定义与使用。</p>
<h3 id="han-shu-wei-ding-yi-shi-jian">函数未定义事件</h3>
<p>自动加载函数的作用是，当安装的插件比较多时，不应该在启动 Vim 时全部加载（通过
vimrc <code>:source</code> 调用或放在 <code>plugin/</code> 目录下），而应只在需要用到时才加载。当然
，自定义命令与映射，相当于面向用户操作的 UI，那是应该在一开始就加载好（保证有
定义）。但是复杂功能的命令与映射，往往是调用函数完成实际功能的，然后所调用的函
数又可能只是个入口函数，其中又会涉及一堆相关功能的函数。那么这些函数的定义就可
以延后加载，只在首次用到时触发加载，就能达到优化 Vim 启动速度的命令。</p>
<p>在 Vim7 版本之前，用户可以利用 <code>FuncUndefined</code> 这个自动事件来实现延后加载脚本
的目的。例如，假设在任一 <code>&amp;rtp</code> 目录下的 <code>plug/</code> 中有如下脚本：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; &gt;File: ~/.vim/plugin/delaytwice.vim
</span><span>
</span><span style="color:#b48ead;">if</span><span> !</span><span style="color:#8fa1b3;">exists</span><span>(</span><span style="color:#a3be8c;">&#39;s:load_first&#39;</span><span>)
</span><span>    </span><span style="color:#96b5b4;">command </span><span>-nargs=</span><span style="color:#b48ead;">*</span><span> MYcmd  call </span><span style="color:#8fa1b3;">DT_foo</span><span>(&lt;f-args&gt;)
</span><span>    </span><span style="color:#96b5b4;">nnoremap </span><span>&lt;F12&gt; :call </span><span style="color:#8fa1b3;">DT_foo</span><span>()&lt;CR&gt;
</span><span>    </span><span style="color:#96b5b4;">execute </span><span style="color:#a3be8c;">&#39;autocmd FuncUndefined DT_* source &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;sfile&gt;&#39;</span><span>)
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:load_first</span><span> = </span><span style="color:#d08770;">1
</span><span>    finish
</span><span style="color:#b48ead;">endif
</span><span>
</span><span style="color:#b48ead;">if </span><span style="color:#8fa1b3;">exists</span><span>(</span><span style="color:#a3be8c;">&#39;s:load_second&#39;</span><span>)
</span><span>    finish
</span><span style="color:#b48ead;">endif
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">DT_foo</span><span>() abort
</span><span style="color:#65737e;">    &quot; TODO:
</span><span style="color:#b48ead;">endfunction
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">DT_bar</span><span>() abort
</span><span style="color:#65737e;">    &quot; TODO:
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:load_second</span><span> = </span><span style="color:#d08770;">1
</span></code></pre>
<p>这个脚本将分两步加载。首先，由于它位于 <code>plugin/</code> 子目录，故在 Vim 启动时就会读
取。在这第一次加载时，会进入 <code>if !exists('s:load_first')</code> 分支，该分支应该很短
，只定义了命令与映射，并用一个 <code>s:</code> 变量标记已加载过一次后直接结束。关键是定义
了自动事件 <code>FuncUndefined</code>，此后当调用了未定义函数且该函数名匹配 <code>DT_*</code> ，就会
重新加载这个脚本。第二次加载时，会跳过 <code>if !exists('s:load_first')</code> 分支，继续
加载后续代码，完成相应函数的定义。</p>
<p>后面那个 <code>if exists('s:load_second')</code> 分支，是为了避免第三次或更多次的加载。对
于其他普通脚本，也可用这个机制防止重复加载，不过仅为实现延时加载，这个分支是
不必要的。一般地，如果脚本中主要是用 <code>:function!</code> 命令定义一些函数，重复加载也
没有太大坏处，毕竟重复定义而覆盖的函数与原来的是一样。但是若脚本中需要维护某些
<code>s:</code> 局部变量（尤其是较复杂的字典对象）的状态，重复加载脚本就会导致这些变量的
重新初始化，可能就不是想要的，这就需要避免加载。这与延时加载是两个理念，延时加
载是有意地设计为加载第二次。</p>
<p>实际上，这延时加载的两部分，可以分别写在不同的两个脚本中。这对于非常大的脚本，
可能还能进一步提高 Vim 启动速度。因为按上例，写在一个脚本中，虽然 vim 不必解释
后半部分的代码，但毕竟首先还是要打开整个脚本文件的。因此，将第一部分定义的命令
、映射与自动事件放在 <code>plugin/</code> 目录下，令其在 Vim 启动时就加载。第二部分的函数
定义（主体内容，长）放在另一个目录下，只要不会被 vim 在启动阶段读取就可，例如
不妨就放在 <code>autoload/</code> 子目录下。拆分结果示例如下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; &gt;File: ~/.vim/plugin/delaytwice.vim
</span><span style="color:#96b5b4;">command </span><span>-nargs=</span><span style="color:#b48ead;">*</span><span> MYcmd  call </span><span style="color:#8fa1b3;">DT_foo</span><span>(&lt;f-args&gt;)
</span><span style="color:#96b5b4;">nnoremap </span><span>&lt;F12&gt; :call </span><span style="color:#8fa1b3;">DT_foo</span><span>()&lt;CR&gt;
</span><span style="color:#96b5b4;">execute </span><span style="color:#a3be8c;">&#39;autocmd FuncUndefined DT_* source &#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;~/.vim/autoload/delaytwice.vim&#39;</span><span>)
</span></code></pre>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; &gt;File: ~/.vim/autoload/delaytwice.vim
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">DT_foo</span><span>() abort
</span><span style="color:#65737e;">    &quot; TODO:
</span><span style="color:#b48ead;">endfunction
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">DT_bar</span><span>() abort
</span><span style="color:#65737e;">    &quot; TODO:
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>不过在拆分时，有一行代码要注意作相应修改。就是在定义 <code>FuncUndefined</code> 事件时，
需要加载正确的（另一个）文件路径。上例是硬编码写入了对应的全路径。而在前面的单
文件的版本中，可用 <code>&lt;sfile&gt;</code> 表示本脚本文件名。当然，在后面这个拆分版本中，若
按某种规范存在相对路径中，也是可以避名硬编码的，如用以下语句代替：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;sfile&gt;:p:h&#39;</span><span>) </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39;/../autoload/&#39; </span><span style="color:#b48ead;">. </span><span style="color:#8fa1b3;">expand</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;sfile&gt;:p:t&#39;</span><span>)
</span></code></pre>
<p>此外还须说明的是，用这种（手动）延时加载方案时，所定义的函数名最好用统一的前缀
（或后缀），方便在定义 <code>FuncUndefined</code> 事件时指定相应的模式匹配，尽量使该匹配
不扩大影响，也能保证所用函数能正确延时加载到。</p>
<p>自 Vim7 版本后，有了自动延时加载机制，就不必用户自己实现手动延时加载方案了。不
过以上的手动延时方案，有助于理解 Vim 的自动加载机制。另外单文件版本的示例可能
仍有意义，不那么复杂的脚本若不想拆分多个文件，就可按此例用 <code>FuncUndefined</code> 事
件实现。</p>
<h3 id="zi-dong-jia-zai-han-shu-de-ding-yi">自动加载函数的定义</h3>
<p>自动加载机制，与上节讨论的拆分版的延时加载方案示例类似，不过有以下几点不同：</p>
<ul>
<li>不必再写 <code>FuncUndefined</code> 事件；</li>
<li>将函数名前缀的 <code>DT_</code> 改为 <code>DT#</code></li>
<li>将定义函数的那个脚本文件名也改为 <code>autoload/DT.vim</code></li>
</ul>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; &gt;File: ~/.vim/plugin/delaytwice.vim
</span><span style="color:#96b5b4;">command </span><span>-nargs=</span><span style="color:#b48ead;">*</span><span> MYcmd  call </span><span style="color:#8fa1b3;">DT#foo</span><span>(&lt;f-args&gt;)
</span><span style="color:#96b5b4;">nnoremap </span><span>&lt;F12&gt; :call </span><span style="color:#8fa1b3;">DT#foo</span><span>()&lt;CR&gt;
</span></code></pre>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; &gt;File: ~/.vim/autoload/DT.vim
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">DT#foo</span><span>() abort
</span><span style="color:#65737e;">    &quot; TODO:
</span><span style="color:#b48ead;">endfunction
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">DT#bar</span><span>() abort
</span><span style="color:#65737e;">    &quot; TODO:
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>这样就可以了，不必再关注 <code>DT#foo()</code> 函数有没有定义，什么时刻定义，在任何地方直
接使用就可以了。vim 能自动识别函数名中间包含 <code>#</code> 符号的函数，当作自动加载函数
处理，将 <code>#</code> 符号之前的部分视为脚本文件名，在函数未定义时，自动到 <code>&amp;rtp</code> 的
<code>autoload/</code> 子目录下查找。</p>
<p>所以关键是要让函数名的 <code>#</code> 前缀与文件名保持一致，也可以不改 <code>delaytwice.vim</code>
的文件名，而将函数名改为 <code>delaytwice#foo()</code>。这种函数名的首字符允许是小写，毕
竟全局函数名首字母大写的规则，主要是为了避免与内置函数冲突。</p>
<p>自动加载函数名中可以有多个 <code>#</code> 符号分隔，对应于 <code>autoload/</code> 子目录下各级路径：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>{</span><span style="color:#bf616a;">&amp;rtp</span><span>}</span><span style="color:#96b5b4;">/autoload/</span><span>sub</span><span style="color:#d08770;">1</span><span style="color:#96b5b4;">/sub2/</span><span>filename</span><span style="color:#b48ead;">.</span><span>vim
</span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">sub1#sub2#filename#func_name</span><span>()
</span></code></pre>
<p>当 vim 加载含有 <code>#</code> 函数定义的脚本文件时，如果发现函数名前缀与文件路径不相符，
就会报错，即无法顺利完成该函数的定义。不过事实上它只检查是否在 <code>autoload/</code> 目
录下的相对路径，至于 <code>autoload/</code> 之上的父目录是否在 <code>&amp;rtp</code> 中并不强制检测。因
为在正式应用环境下，该脚本文件已经是从 <code>&amp;rtp</code> 中搜索到的。而另一方面，在开发测
试时，你只要建立相应的目录层次，把文件扔到（某个工程） <code>autoload/</code> 子目录下，
即使暂没把工程目录加到 <code>&amp;rtp</code> 下，在编辑这个脚本时，也可以用 <code>:source %</code> 加载
当前文件进行测试，并不会因为它还不在 <code>&amp;rtp</code> 中就失败。</p>
<p>当有了 <code>#</code> 函数的自动加载机制，那是否可以与 <code>FuncUndefined</code> 事件联用协作呢？一
般情况下没有必要。但假设一种情况，如果按目前流行的方式用插件管理插件从 github
安装插件的话，一般是将每个插件放在独立的目录中，每个插件目录都加入了 <code>&amp;rtp</code>中
。这样如果你真的很狂热地安装了许多插件，你的 <code>&amp;rtp</code> 路径列表将变得很长。<code>&amp;rtp</code>
路径在 vim 运行是至关重要，不仅这里介绍的自动加载函数，其他许多功能都要从
<code>&amp;rtp</code> 中查找。如果某个插件的主要功能只是提供了 <code>autoload/</code> 脚本，或许就可以尝
试合并 <code>&amp;rtp</code>，自己再写一个 <code>FuncUndefined</code> 事件，从其他地方加载脚本。</p>
<p>那么就要注意 <code>#</code> 函数内置的自动加载时机，与 <code>FuncUndefined</code> 事件的触发，先后关
系如何，避免一些可能的冲突。下面做一个试验来探讨之。</p>
<p>首先，在 <code>~/.vim/autoload/delaytwice.vim</code> 脚本末尾加入如下一些输出语句，用以跟
踪该脚本被加载的情况：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">delaytwice#foo</span><span>() abort
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;in delaytwice#foo()&#39;
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#65737e;">&quot; bar: 
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">delaytwice#bar</span><span>() abort
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;in delaytwice#bar()&#39;
</span><span style="color:#b48ead;">endfunction
</span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;autoload/delaytwice.vim loaded&#39;
</span></code></pre>
<p>然后，再自定义一个 <code>FuncUndefined</code> 事件：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#96b5b4;">execute </span><span style="color:#a3be8c;">&#39;autocmd FuncUndefined *#*  call MyAutoFunc()&#39;
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">MyAutoFunc</span><span>() abort
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;in MyAutoFunc()&#39;
</span><span style="color:#65737e;">    &quot; TODO:
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>它也匹配任何中间含 <code>#</code> 符号的函数名，但假设它们（有些）没放在 <code>&amp;rtp</code> 中，所以
需要写个入口函数从其他地方查找并加载定义文件。将该代码放在 <code>plugin/</code> 下某个文
件中，便于在每次启动 vim 时自动执行，保证该事件已定义。</p>
<p>接下来就可以测试了，重启 vim （或打开 vim 的另一个实例会话），在命令行执行如下
命令，其输出也附于其后：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>: call delaytwice#foo()
</span><span>autoload/delaytwice.vim loaded
</span><span>in delaytwice#foo()
</span></code></pre>
<p>这说明只触发了 vim 内置的自动加载机制，它自动加载了 <code>delaytwice.vim</code> 文件，然
后 <code>delaytwice#foo()</code> 函数就是已定义了，就可调用该函数了，不会再触发
<code>FuncUndefined</code> 事件。</p>
<p>再重启一个 vim ，在命令行调用一个在该文件中并不存在的函数，比如将 <code>foo()</code> 小写
误写成了大写 <code>Foo()</code>，其输出如下：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>: call delaytwice#Foo()
</span><span>autoload/delaytwice.vim loaded
</span><span>in MyAutoFunc()
</span><span>autoload/delaytwice.vim loaded
</span><span>E117: Unknown function: delaytwice#Foo
</span></code></pre>
<p>从结果可分析出，vim 仍是先按自动加载机制，找到 <code>delaytwice.vim</code> 并加载，然后再
尝试调用 <code>delaytwice#Foo()</code>，它仍是个未定义函数。这二次调用时，才触发
<code>FuncUndefined</code> 事件。当然我们这里自定义的 <code>MyAutoFunc()</code> 并没做实际工作，并不
能解决函数未定义问题。于是 vim 再按自动加载机制，找到并加载 <code>delaytwice.vim</code>。
加载两次后仍未解决问题，vim 就报错了。</p>
<p>当然了，如果在 <code>&amp;rtp</code> 中并没有找到 <code>delaytwice.vim</code> 或者调用 <code>:call nofile#foo()</code> ，它只出输出 <code>in MyAutoFunc()</code> 这行以及错误行。但它显然是遍历过
一次 <code>&amp;rtp</code> 未找到相应文件，才触发 <code>FuncUndefined</code> 事件的。</p>
<p>现在，又假设不自定义 <code>FuncUndefined</code> 事件与 <code>MyAutoFunc()</code> 处理函数，只按 vim
的自动加载机制，如果调用了在自动加载文件中其实并未定义的函数，会是什么情况呢：</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>: call delaytwice#Foo()
</span><span>autoload/delaytwice.vim loaded
</span><span>autoload/delaytwice.vim loaded
</span><span>E117: Unknown function: delaytwice#Foo
</span><span>
</span><span>: call delaytwice#bar()
</span><span>in delaytwice#bar()
</span><span>
</span><span>: call delaytwice#Bar()
</span><span>autoload/delaytwice.vim loaded
</span><span>E117: Unknown function: delaytwice#Bar
</span></code></pre>
<p>可见，第一次调用 <code>delaytwice#Foo()</code> 时，加载了两次脚本，其内的
<code>delaytwice#foo()</code> 与 <code>delaytwice#bar()</code> 就是已定义的，可正常使用了。然后每次
误用 <code>delaytwice#Foo()</code> 或 <code>delaytwice#Bar()</code> 都会再触发加载一次脚本。</p>
<p>综上，可得到如下结论：</p>
<ul>
<li>vim 会记录已加载的脚本文件，当调用自动加载函数时，若分析自动加载函数所对应的
自动加载脚本并未加载，就会先搜索并加载相应的脚本，再次调用原函数。</li>
<li>在自动加载脚本已加载或未找到相应脚本的情况下，调用未定义的自动加载函数才会触
发 <code>FuncUndefined</code> 事件，会先调用自定义的事件处理函数，若无法触发，再次搜索
加载相应的脚本。</li>
</ul>
<h3 id="zi-dong-han-shu-yu-qi-ta-han-shu-de-bi-jiao">自动函数与其他函数的比较</h3>
<p>首先，要明确一件事，自动加载函数是在全局作用域的。也就是相当于全局函数，可以在
任何地方使用。</p>
<p>但是，它又有某些局部函数的作用。比如，可以在两个自动加载脚本中定义“相同”的函数
，<code>onefile#foo()</code> 与 <code>another#foo()</code>。但实际上它们仍是两个不同的函数，因为包含
<code>#</code> 在内的整个字符串 <code>onefile#foo</code> 与 <code>another#foo</code> 才是它们的函数名。它们只是
名字上包含相同后缀的相似函数而已。仅管如此，能在不同文件（插件）中，利用相同的
词根定义相同（或相似）功能的不同实现，也是很有意义的，增加代码可读性与维护。</p>
<p>在为自动函数定义函数引用时，也要使用其全名。同时，自动加载函数它是函数，不是变
量。所以，在定义 <code>onefile#foo()</code> 的 <code>onefile.vim</code> 文件中，还可以定义 <code>s:foo</code>
变量。但最好不要这样增加混乱，除非将其定义为同名函数的引用，如 <code>:let s:foo = function('onefile#foo')</code>。因为即使在同一个文件中，也必须使用包含 <code>#</code> 的函数全
名，它可能很长，使用不太方便，所以定义一个局部于 <code>s:</code> 的函数引用，是有意义的。</p>
<p>除了函数名可以加 <code>#</code> 符号实现自动加载机制，全局变量名也可以加 <code>#</code> 符号。但是只
有当这个变量用于右值，如 <code>:let default = g:onefile#default</code> 才会触发搜索加载相
应脚本（<code>onefile.vim</code>）。但用于左值，如 <code>:let g:onefile#default = 5</code> 却并不会
触发加载脚本。这个区别其实是为了让用户在触发加载 <code>onefile.vim</code> 之前，就能设置
<code>g:onefile#default</code> 的值，那可作为相关插件的用户配置变量，比之前惯用的
<code>g:onefile_default</code> 变量名似乎更有意义，更像 VimL 风格。</p>
<p>正因为 <code>#</code> 符号也可用于变量名，才千万注意不要将一个函数引用变量保存在 <code>#</code> 变量
名中（包括 lambda 表达式），虽然那是合法的，但非常不建议如此混乱。只有真的有意
设计开放给用户的重要配置才定义为 <code>#</code> 全局变量，并始终加上 <code>g:</code> 前缀。而函数名
是不能加 <code>g:</code> 前缀的，如此容易直观地区分。</p>
<p>总之，自动加载函数是 VimL 中一个极优秀的设计。如果说函数引用是注重从内部管理，
那么自动加载函数则注重从外部管理。善加利用，可极大增强 VimL 代码的健壮性与可维
护性。若说有什么缺点的话，那就是自动加载函数名可能太太太长了。并且要由用户来保
证函数名前缀与文件名路径的一致性，如果脚本文件改名了，或移动了路径层次，手动修
改函数名也是一大问题。非常期望在后续版本中能增加什么语法糖，能使得在本文件中定
义与使用自动加载函数更加简洁些。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch05-viml-function/"><</a>
    

            </div>

            <div class="next-link">
                
    
        
        
        
        
            
            
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
                    
                
            
        
            
            
                <a class="next" href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">></a>
                
                
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
        
            
            
            
        
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
