<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>5.2 函数引用</h1>
    <!-- ## 5.2 函数引用 -->
<p>关于函数引用的帮助文档先给传送门 <code>:h FuncRef</code>（注意大写）。很多函数的高级用法
都在函数引用基础上建立的。</p>
<h3 id="han-shu-yin-yong-de-yi-yi">函数引用的意义</h3>
<p>继续接着上一节的内容引申来讲。例如在 <code>Calculate()</code> 函数中间接调用 <code>Sum()</code> 时须
用如下语法： <code>call('Sum', a:000)</code> ，<code>'Sum'</code> 函数名须用引号括起来当作一个字符串
参数传入。</p>
<p>如果尝试执行 <code>:echo call(Sum, [1,2,3,4])</code> 就会报 <code>E121</code> 的“未定义变量”错误。也
就是说，<code>Sum</code> 是一个自己定义的函数，但函数与变量在 VimL 中有本质的不同，而
<code>call()</code> 要求一个变量作为参数，所以不能直接将函数传入。然而这个变量又要求能代
表函数，所以 VimL 就需要一个“函数引用”的概念。</p>
<p>就这个特殊的 <code>call()</code> 而言，在第一参数中将一个函数名用引号括起的字符串也能达到
引用一个函数的目的，但这显然是不正式不通用的。函数引用也是一个变量，不过是另一
种特殊的变量（值）类型，不应该与简单的字符串变量类型混淆。</p>
<p>在其他一些编程（脚本）语言中，函数是所谓的一等公民，即与变量的地位一样，可以用
变量的地方，也可以用函数。但在 VimL 设计之初，函数与变量就是两个不同次元的东西。只
有在引入了函数引用之后，函数引用与变量才是相同的东西。</p>
<h3 id="han-shu-yin-yong-de-ding-yi">函数引用的定义</h3>
<p>可以内置函数 <code>function()</code> 创建一个函数引用，其参数就是所要引用的函数名（引号字
符串），既可以是内置函数也可以是自定义函数的名字。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> Fnr_Sum = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;Sum&#39;</span><span>)
</span><span>: </span><span style="color:#96b5b4;">echo </span><span style="color:#8fa1b3;">type</span><span>(Fnr_Sum)
</span><span>: </span><span style="color:#96b5b4;">echo </span><span style="color:#8fa1b3;">Fnr_Sum</span><span>(</span><span style="color:#d08770;">1</span><span>,</span><span style="color:#d08770;">2</span><span>,</span><span style="color:#d08770;">3</span><span>,</span><span style="color:#d08770;">4</span><span>)
</span></code></pre>
<p>上例创建一个变量 <code>Fnr_Sum</code>，它引用自定义函数 <code>Sum()</code>。查看这个变量的类型，显示
是 <code>2</code>，这就是函数引用的类型（<code>v:t_func</code>）。然后这个函数引用可以像引用的那个函数
一样调用，也就是后面接括号传入参数列表。</p>
<p>函数引用变量与函数本身的关系，就与之前所述的列表（或字典）变量与列表（或字典）
实体之间的关系。在常规运用场合中，一般可不必理会其中的差异，凡是要求函数调用的
地方，都可以用函数引用代替。而且，函数引用作为一个变量，使用范围将更加灵活。因
为 VimL 的变量是弱类型的，在使用变量时不检查变量类型，所以在任何使用变量的地方
，也都可以使用函数引用代替。当然，你不能试图对函数引用进行加减乘除这样的操作，
那会触发运行时错误，函数引用主要（也许是唯一）支持的操作就是调用。</p>
<p>VimL 的变量名自有其规则（见第二章），而函数引用的变量名在此规则上还有更严格一
点的限制，就是必须也以大写字母开头。这是因为要与函数名的规则吻合。因为从代码
语法上看一个函数调用，无从分辨它是函数引用还是函数本身。主要注意如下几点：</p>
<ul>
<li>函数引用变量也可以加作用域前缀，如果加了 <code>s:</code> <code>w:</code> <code>t:</code> 或 <code>t:</code> 这几个前缀，
则不再要求变量名主体以大写字母开始了，因为这种情况下不会有歧义。参数作用域前
缀 <code>a:</code> 用于函数引用之前，也不必大写字母。</li>
<li>如果在函数引用变量名之前加全局作用域前缀 <code>g:</code> 或局部作用域前缀 <code>l:</code>，仍然要
求其变量名主体以大写字母开头。因为这两种前缀是可以省略的，要保证省略后的等价
的“裸”调用仍然合乎函数调用规则。</li>
<li>函数引用变量名，不能与已有的自定义函数名相同，否则也会发生歧义，vim 将无从分
辨是触发调用函数引用呢，还是触发调用同名函数本身。</li>
<li>函数引用变量名允许与已存在的其他变量名重名，只不过其含义是重定义或覆盖原变量
的意义，虽然语法上合法，但不建议这么做。</li>
</ul>
<p>再次提醒一下，<code>function</code> 这个“关键字”，既是一个命令名，也是一个内置函数名。用
<code>:function</code> 命令是创建或定义一个函数，而 <code>function()</code> 函数则是创建或定义一个函
数引用（其参数须是已由 <code>:function</code> 命令创建的函数名，或内置函数名）。命令与函
数是完全不同空间次元的东西，也与变量互不相关。如果你愿意，甚至也可以自定义一个
叫 <code>function</code> 的变量，但最好不要这样做。</p>
<p>在 VimL 中，有很多内置函数与命令重名，用于实现相似的功能。上节刚用到过的
<code>call()</code> 函数与 <code>:call</code> 命令也是这种情况。在查 vim 帮助文档时，查函数时在后面
加对空括号，查命令时在前面加个冒号。另一方面，VimL 的内置变量名都是以 <code>v:</code> 前
缀的，这倒不必担心混淆。</p>
<h3 id="han-shu-yin-yong-de-shi-yong">函数引用的使用</h3>
<p>下面再讲解函数引用的使用建议与示例。仍以上节末用于实现不定参数连加或连乘的
<code>Calculate()</code> 函数为例。</p>
<h4 id="jiang-han-shu-yin-yong-zuo-wei-can-shu-chuan-di">将函数引用作为参数传递</h4>
<p>首先，不建议使用全局的函数引用变量。因为用 <code>:function</code> 命令定义的函数是全局的
，尽量不要将函数引用也定义在全局作用域中，避免麻烦。例如，可将上节的
<code>Calculate()</code> 函数改为如下使用函数引用的方式（为简便起见，略过参数检测）：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">CalculateR</span><span>(operator, </span><span style="color:#b48ead;">...</span><span>)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>operator </span><span style="color:#b48ead;">==# </span><span style="color:#a3be8c;">&#39;+&#39;
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:Fnr</span><span> = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;Sum&#39;</span><span>)
</span><span>    </span><span style="color:#b48ead;">elseif </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>operator </span><span style="color:#b48ead;">==# </span><span style="color:#a3be8c;">&#39;*&#39;
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:Fnr</span><span> = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;Prod&#39;</span><span>)
</span><span>    </span><span style="color:#b48ead;">endif
</span><span>
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:result</span><span> = </span><span style="color:#8fa1b3;">call</span><span>(</span><span style="color:#bf616a;">l:Fnr</span><span>, </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span style="color:#d08770;">000</span><span>)
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">l:result
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>这里先根据参数创建一个函数引用 <code>Fnr</code>，在函数内定义的变量都是局部变量，<code>l:</code>
前缀可选。然后这个函数引用也可以作为参数传给 <code>call()</code> 函数，它能同时处理作为函
数名的字符串变量类型或函数引用类型，反正都是用以访问实际所调函数的手段；也不妨
认为在之前传入字符串时，<code>call()</code> 函数也会自动先调用 <code>function()</code> 获得函数引用
。</p>
<h4 id="jiao-ben-ju-bu-han-shu-ji-yin-yong">脚本局部函数及引用</h4>
<p>上面改写的 <code>CalculateR()</code> 函数有一处不太好，就是每次调用都要重新创建 <code>l:Fnr</code> 
这个相同的函数引用变量，略显低效。在实践中，函数定义一般是写在单独的脚本中，因
此函数引用也可以定义为 <code>s:</code> 脚本局部变量。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; File: ~/.vim/vimllearn/funcref.vim
</span><span>
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:fnrSum</span><span> = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;Sum&#39;</span><span>)
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:fnrProd</span><span> = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;Prod&#39;</span><span>)
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">CalculateRs</span><span>(operator, </span><span style="color:#b48ead;">...</span><span>)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>operator </span><span style="color:#b48ead;">==# </span><span style="color:#a3be8c;">&#39;+&#39;
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:Fnr</span><span> = </span><span style="color:#bf616a;">s:fnrSum
</span><span>    </span><span style="color:#b48ead;">elseif </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>operator </span><span style="color:#b48ead;">==# </span><span style="color:#a3be8c;">&#39;*&#39;
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:Fnr</span><span> = </span><span style="color:#bf616a;">s:fnrProd
</span><span>    </span><span style="color:#b48ead;">endif
</span><span>
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:result</span><span> = </span><span style="color:#8fa1b3;">call</span><span>(</span><span style="color:#bf616a;">l:Fnr</span><span>, </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span style="color:#d08770;">000</span><span>)
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">l:result
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>注意，如前所述，<code>s:</code> 前缀的函数引用变量可用小写开头，<code>l:</code> 或缺省前缀的函数引用
须大写开头。这里主要为演示不同前缀的函数函数引用变量，其实 <code>l:Fnr</code> 中间变量也
可省去，直接将 <code>call()</code> 调用语用写在 <code>if</code> 分支中。</p>
<p>这样，<code>s:fnrSum</code> 与 <code>s:fnrProd</code> 函数（引用）就是私有的了，只能在该脚本内使用，
而 <code>CalculateRs()</code> 函数仍定义为全局函数，提供为外部公用接口。但是，那两个私有
变量引用的仍是公用的函数 <code>Sum()</code> 与 <code>Prod()</code>。如果想再要隐藏，可以将这两个函数
也定义为 <code>s:</code> 的作用域：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; File: ~/.vim/vimllearn/funcref.vim
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">s:sum</span><span>(</span><span style="color:#b48ead;">...</span><span>)
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:sum</span><span> = </span><span style="color:#d08770;">0
</span><span>    </span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">l:arg </span><span style="color:#b48ead;">in </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span style="color:#d08770;">000
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:sum</span><span> += </span><span style="color:#bf616a;">l:arg
</span><span>    </span><span style="color:#b48ead;">endfor
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">l:sum
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">s:prod</span><span>(</span><span style="color:#b48ead;">...</span><span>)
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:prod</span><span> = </span><span style="color:#d08770;">1
</span><span>    </span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">l:arg </span><span style="color:#b48ead;">in </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span style="color:#d08770;">000
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:prod</span><span> = </span><span style="color:#bf616a;">l:prod </span><span style="color:#b48ead;">* </span><span style="color:#bf616a;">l:arg
</span><span>    </span><span style="color:#b48ead;">endfor
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">l:prod
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:fnrSum</span><span> = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;s:sum&#39;</span><span>)
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:fnrProd</span><span> = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;s:prod&#39;</span><span>)
</span><span>
</span><span style="color:#96b5b4;">echo </span><span style="color:#bf616a;">s:
</span></code></pre>
<p>这里的 <code>s:sum()</code> 函数对比原 <code>Sum()</code> 略有修改，不再强制要求至少两个参数。同时函数
名加上 <code>s:</code> 前缀后，也不再强制要求以大写字母开头。当用 <code>function()</code> 创建函数引
用时，须将 <code>'s:sum'</code> 整个字符串当作该脚本局部数字的“名字”传入为参数。</p>
<p>然后，重点迷惑来了，脚本内的 <code>s:sum()</code> 实际函数名其实并不是 <code>'s:sum'</code>！这只是
语法上规定的书写文法。在 vim 内部，会将 <code>s:</code> 前缀的函数名替换为 <code>&lt;SNR&gt;编号_</code>。
其中编号是指 vim 在加载该文件时对其赋与的编号。可用 <code>:scriptnames</code> 命令查看当
前 vim 所加载过的所有脚本，一般情况下编号为 <code>1</code> 的第一个加载文件就是你的起始配
置文件 <code>vimrc</code>，然后每次加载脚本时顺序编号。所以 <code>s:sum()</code> 脚本私有函数的实际
名字是动态变化的，在不同的 vim 会话中加载时机极可能不一样，其编号中缀也就不一
样了。</p>
<p>如果在脚本末尾加上 <code>echo s:</code> 这个语句（<code>s:</code> 是一个特殊字典，保存着该脚本内定义
的所有以 <code>s:</code> 前缀开始的脚本局部变量），那么在加载该脚本时，将回显如下信息：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>{</span><span style="color:#a3be8c;">&#39;fnrSum&#39;</span><span>: </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;SNR&gt;77_sum&#39;</span><span>), </span><span style="color:#a3be8c;">&#39;fnrProd&#39;</span><span>: </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;&lt;SNR&gt;77_prod&#39;</span><span>)}
</span></code></pre>
<p>表明在这次 vim 会话环境中，<code>s:sum()</code> 函数名实际上是 <code>&lt;SNR&gt;77_sum</code>，也可以直接
用这个名字来调用该函数，如在命令行中输入</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">echo </span><span>&lt;SNR&gt;</span><span style="color:#d08770;">77</span><span style="color:#8fa1b3;">_sum</span><span>(</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">3</span><span>, </span><span style="color:#d08770;">4</span><span>)
</span></code></pre>
<p>是能正常工作中的。</p>
<p>因此，看似脚本局部私有的 <code>s:sum()</code> 实际上是被转化成了 <code>&lt;SNR&gt;77_sum()</code> 全局公有
函数。其中 <code>&lt;SNR&gt;77_</code> 前缀在在某些地方也可用特殊符号 <code>&lt;SID&gt;</code> 表示。当然，任何
正常的人，都不会采用后者来调用函数，况且脚本编号都是临时赋与的不保存一致性，于
是也算达到了作用域隐藏的目的。</p>
<p>另外，还有一点要注意的是，<code>s:sum()</code> 是函数，不是变量，所以它不会被保存在 <code>s:</code>
字典内。只有函数引用变量 <code>s:fnrSum</code> 与 <code>s:fnrProd</code> 才保存在 <code>s:</code> 字典内，其键
就是变量名 <code>fnrSum</code> 与 <code>fnrProd</code>，其值就是相应的函数引用。显然，vim 不能自作主
张地自动为 <code>s:sum()</code> 创建一个名为 <code>s:sum</code> 的函数引用变量，甚至我们自己也不能手
动用 <code>:let ... function()</code> 语句创建名为 <code>s:sum</code> 的函数引用变量，否则在调用
<code>s:sum(1,2,3,4)</code> 是就会发生语法歧义。但是，我们能用它创建其他类型的变量，如在
脚本末尾加入如下代码并重新用 <code>:source</code> 加载：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; File: ~/.vim/vimllearn/funcref.vim
</span><span>
</span><span style="color:#65737e;">&quot; let s:sum = function(&#39;s:sum&#39;) &quot; 错误
</span><span style="color:#65737e;">&quot; let s:prod = function(&#39;s:prod&#39;)
</span><span>
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:sum</span><span> = </span><span style="color:#a3be8c;">&#39;1+2+3+4&#39;
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:prod</span><span> = </span><span style="color:#a3be8c;">&#39;1*2*3*4&#39;
</span><span style="color:#96b5b4;">echo </span><span style="color:#bf616a;">s:
</span><span>
</span><span style="color:#96b5b4;">echo </span><span style="color:#8fa1b3;">s:sum</span><span>(</span><span style="color:#d08770;">1</span><span>,</span><span style="color:#d08770;">2</span><span>,</span><span style="color:#d08770;">3</span><span>,</span><span style="color:#d08770;">4</span><span>)
</span><span style="color:#96b5b4;">echo </span><span style="color:#8fa1b3;">s:prod</span><span>(</span><span style="color:#d08770;">1</span><span>,</span><span style="color:#d08770;">2</span><span>,</span><span style="color:#d08770;">3</span><span>,</span><span style="color:#d08770;">4</span><span>)
</span></code></pre>
<p>可以把 <code>s:sum</code> 赋值为字符串类型变量，然后 <code>s:sum()</code> 函数并未失去定义，仍然可正
常调用。所以，<code>s:</code> 作用域前缀用于变量与函数前有着不同的实现意义。<code>s:sum()</code> 函
数本质上是 <code>&lt;SNR&gt;77_sum()</code> 函数，与 <code>s:sum</code> 变量大有不同。然而，正常的程序猿非
常不建议玩这样的杂耍。</p>
<h4 id="jiang-han-shu-yin-yong-shou-ji-zai-lie-biao-zhong">将函数引用收集在列表中</h4>
<p>在前一示例中，在脚本中创建的 <code>s:</code> 前缀的函数引用变量，被自动地收集保存在一个特
殊字典中。这表明函数引用与普通变量“无差别”的同等地位，可以用在任何需要变量的地
方。比如，我们也可以主动地将函数引用保存在一个列表中，以实现某些特殊功能：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; File: ~/.vim/vimllearn/funcref.vim
</span><span>
</span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">s:operator</span><span> = [</span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;s:sum&#39;</span><span>), </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;s:prod&#39;</span><span>)]
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">CalculateA</span><span>(</span><span style="color:#b48ead;">...</span><span>)
</span><span>    </span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">l:Operator </span><span style="color:#b48ead;">in </span><span style="color:#bf616a;">s:operator
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:result</span><span> = </span><span style="color:#8fa1b3;">call</span><span>(</span><span style="color:#bf616a;">l:Operator</span><span>, </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span style="color:#d08770;">000</span><span>)
</span><span>        </span><span style="color:#96b5b4;">echo </span><span style="color:#bf616a;">l:result
</span><span>    </span><span style="color:#b48ead;">endfor
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>这里，我们定义了一个列表变量 <code>s:operator</code> ，其元素都是能接收不定参数的运算函数
的引用。然后在函数 <code>CalculateA()</code> 中遍历该列表，为每个函数传递参数进行计算。这
是个全局函数，所以加载脚本后，可直接在命令行中执行 <code>:call CalculateA(1,2,3,4)</code>
验看结果。</p>
<p>仍然要注意的是，在 <code>for</code> 循环中，循环变量 <code>l:Operater</code> 仍然要以大写字母开头，
才能接收 <code>s:operator</code> 列表内的函数引用变量。否则，若以小写字母的话，有可能省去
<code>l:</code> 前缀，写出类似 <code>operator(1,2,3,4)</code> 的函数调用，这就有语法错误了，因为小写
字母的函数名调用，都保留给 VimL 的内置函数。</p>
<p>良好的实践是，始终以大写字母开头命名函数引用变量，不管什么作用域前缀；如果不嫌
麻烦，再以 <code>Fnr</code> 为变量名前缀也未尝不可。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch05-viml-function/"><</a>
    

            </div>

            <div class="next-link">
                
    
        <a class="next" href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">></a>
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
