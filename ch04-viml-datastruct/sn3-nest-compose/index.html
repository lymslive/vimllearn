<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>4.3 嵌套组合与扩展</h1>
    <!-- ## 4.3 嵌套组合与扩展 -->
<p>VimL 虽然只提供了列表与字典两种数据结构，但通过列表与字典的合理组合，几乎能表
达任意复杂的数据结构。这与许多其他流行的脚本语言（如 python）的思想如出一辙。
本节就讨论在 VimL 中如何用列表与字典表示常用数据结构。</p>
<h3 id="zhan-yu-dui-lie">栈与队列</h3>
<p>栈是所谓后进先出的结构，队列是先进先出的结构。这可以直接用一个 <code>list</code> 表示，
因为 <code>list</code> 相当于个动态数组，支持随意在两端增删元素。</p>
<p>如果只在列表尾部增删元素，那就实现了栈行为。如果尾部增加而在头部删除，就实现
了队列行为，如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">Push</span><span>(stack, item)
</span><span>:     call </span><span style="color:#8fa1b3;">add</span><span>(stack, item)
</span><span>: </span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>: </span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">Pop</span><span>(stack)
</span><span>:     call </span><span style="color:#8fa1b3;">remove</span><span>(stack, </span><span style="color:#d08770;">-1</span><span>)
</span><span>: </span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>: </span><span style="color:#b48ead;">function </span><span style="color:#8fa1b3;">Shift</span><span>(queue)
</span><span>:     call </span><span style="color:#8fa1b3;">remove</span><span>(stack, </span><span style="color:#d08770;">0</span><span>)
</span><span>: </span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>在这个示例中，用 <code>Push/Pop</code> 表示栈操作，用 <code>Push/Shift</code> 表示队列操作。这只为
简明地说明算法意图，实际应用中最好先检查 <code>stack/queue</code> 是否为 <code>list</code> 类型，以
及检查列表是否为空。</p>
<h3 id="lian-biao">链表</h3>
<p>在脚本语言中，其实根本不用实现链表，因为动态数组本身就可用于需要链表的场合。在
VimL 中，就直接用 <code>list</code> 表示线性链就够了。除非你真的需要很频繁地在一个很长的
<code>list</code> 中部增删元素，那么或可用字典来模拟链表的实现。</p>
<p>例如，以下代码构建了一个有 10 个结点的链表，每个结点是个字典，<code>value</code> 键表示存储
内容，<code>next</code> 表示指向下一个结点：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> head = {}
</span><span>: </span><span style="color:#b48ead;">for</span><span> value </span><span style="color:#b48ead;">in </span><span style="color:#8fa1b3;">range</span><span>(</span><span style="color:#d08770;">10</span><span>)
</span><span>:   </span><span style="color:#96b5b4;">let</span><span> node = {</span><span style="color:#a3be8c;">&#39;value&#39;</span><span>: value, </span><span style="color:#a3be8c;">&#39;next&#39;</span><span>: head}
</span><span>:   </span><span style="color:#96b5b4;">let</span><span> head = node
</span><span>: </span><span style="color:#b48ead;">endfor
</span></code></pre>
<p>其实在上面的循环中，临时变量 <code>node</code> 可以省略。<code>head</code> 始终指向链表的起始结点，
可通过 <code>next</code> 键依次访问剩余结点，末尾结点的 <code>next</code> 键值是空字典。</p>
<p>这里的关键是，字典的值，或列表元素的值，不仅可以存储像数字与字串符的简单标量，
还可以存储另一个列表或字典（的引用）。基于这样的嵌套与组合，就可以表达更复杂的
数据结构了。</p>
<h3 id="er-wei-shu-zu-ju-zhen">二维数组（矩阵）</h3>
<p>如果列表的每个元素都是另一个列表，那就构成了一个二维数组。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> matrix = []
</span><span>: </span><span style="color:#b48ead;">for</span><span> _ </span><span style="color:#b48ead;">in </span><span style="color:#8fa1b3;">range</span><span>(</span><span style="color:#d08770;">10</span><span>)
</span><span>:   </span><span style="color:#96b5b4;">let</span><span> row = </span><span style="color:#8fa1b3;">range</span><span>(</span><span style="color:#d08770;">10</span><span>)
</span><span>:   call </span><span style="color:#8fa1b3;">add</span><span>(matrix, row)
</span><span>: </span><span style="color:#b48ead;">endfor
</span></code></pre>
<p>构建了一个 <code>10x10</code> 大小的矩阵，其中每个行向量由 <code>range(10)</code> 生成。这样快速生成
的矩阵每一行都相同，或许不是很有趣，但是可以用以下两层循环重新赋值：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">for</span><span> i </span><span style="color:#b48ead;">in </span><span style="color:#8fa1b3;">range</span><span>(</span><span style="color:#d08770;">10</span><span>)
</span><span>:   </span><span style="color:#b48ead;">for</span><span> j </span><span style="color:#b48ead;">in </span><span style="color:#8fa1b3;">range</span><span>(</span><span style="color:#d08770;">10</span><span>)
</span><span>:     </span><span style="color:#96b5b4;">let</span><span> matrix[i][j] = i </span><span style="color:#b48ead;">*</span><span> j
</span><span>:   </span><span style="color:#b48ead;">endfor
</span><span>: </span><span style="color:#b48ead;">endfor
</span></code></pre>
<p>从数学意义上的矩阵讲，它应是规整的矩形，即每行的长度是一样的。但当在 VimL 中用
列表的列表表示时，其实并不能保证每一行都等长。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> text = </span><span style="color:#8fa1b3;">getline</span><span>(</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#a3be8c;">&#39;$&#39;</span><span>)
</span><span>: </span><span style="color:#b48ead;">for</span><span> i </span><span style="color:#b48ead;">in </span><span style="color:#8fa1b3;">range</span><span>(</span><span style="color:#8fa1b3;">len</span><span>(text))
</span><span>:   </span><span style="color:#96b5b4;">let</span><span> line = text[i]
</span><span>:   </span><span style="color:#96b5b4;">let</span><span> text[i] = </span><span style="color:#8fa1b3;">split</span><span>(line, </span><span style="color:#a3be8c;">&#39;\s\+&#39;</span><span>)
</span><span>: </span><span style="color:#b48ead;">endfor
</span></code></pre>
<p>在这里，首先用 <code>getline()</code> 获取当前 buffer 的所有行，保存在 <code>text</code> 这个列表变
量中，其中每个元素表示一行文本字符串。在随后的循环中，又将每行文本分隔成一个个
单词（空格分隔的字符串），将标量字符串元素转化为了另一个列表。因此，<code>text</code> 最
终结果就是列表的列表，即二维数组。而一般情况下，每行的单词数量是不等，所以这个
二维数组不是规整的矩阵。</p>
<p>事实上，这个示例的循环可以直接用 <code>map()</code> 函数代替：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> text = </span><span style="color:#8fa1b3;">getline</span><span>(</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#a3be8c;">&#39;$&#39;</span><span>)
</span><span>: call </span><span style="color:#96b5b4;">map</span><span>(text, </span><span style="color:#a3be8c;">&quot;split(v:val, &#39;\\s\\+&#39;)&quot;</span><span>)
</span></code></pre>
<h3 id="shu">树</h3>
<p>以二叉树为例，也可用一个字典来表示树中某结点，除了需要一个键（如 <code>value</code>）来保
存业务数据，还用一个 <code>left</code> 键表示左孩子结点，<code>right</code> 表示右孩子结点，这两个应
该都是另一个具有相同结构的字典引用，如果缺失某个孩子，则可用空字典表示。</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> node = {}
</span><span>: </span><span style="color:#96b5b4;">let</span><span> node</span><span style="color:#b48ead;">.</span><span>value = </span><span style="color:#d08770;">0
</span><span>: </span><span style="color:#96b5b4;">let</span><span> node</span><span style="color:#b48ead;">.</span><span>left = {}
</span><span>: </span><span style="color:#96b5b4;">let</span><span> node</span><span style="color:#b48ead;">.</span><span>right = {}
</span></code></pre>
<p>这样，只要有一个字典变量引用了这样的一个结点（不妨称之为根结点），就相当于引用
这一棵树，沿着结点的 <code>left</code> 与 <code>right</code> 键就能访问整棵树的所有结点。两个子结点
都是空字典时，该结点就是所谓的叶结点。</p>
<p>不过，由于每个结点含有两个方向的子结点，要遍历树可不是那么直观。有兴趣的读者请
参考相应的树算法。本节内容旨在说明 VimL 的字典用法，展示其表达能力。而算法其实
是与语言无关的。</p>
<p>在上述的树结点字典结构中，只能从一个结点访问其子结点，而无法从子结点访问父结点
。如果有这个需求，只要在每个结点字典中再加一个键引用父结点即可，如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> node</span><span style="color:#b48ead;">.</span><span>parent = {}
</span></code></pre>
<p>每个子结点都有父结点，即 <code>parent</code> 键非空。根结点没有父结点，那 <code>parent</code> 键应该
存个什么值呢？可以就用空字典表示，也可以引用它自身，这都可以将根结点与其他非根
结点区分开来。</p>
<p>我们知道，字典或列表变量都只是某个实体的引用。VimL 的自动垃圾回收机制主要是基
于计数引用的。如果某个字典或列表实体没有被任何变量引用了，即引用计数为 0 时，
（在变量离开作用域或显式 <code>:unlet</code> 时会减少引用计数）VimL 就认定该实体无法被访
问了，就会当作垃圾回收其所占用的内存。在大部分简单场合中，这套机制很好用。不过
考虑这里讨论的包含 <code>parent</code> 与 <code>left</code> <code>right</code> 键的树结点，在父、子结点之间形成
了环引用，它们的引用计数始终不会降到 0 。然而 VimL 另外也有一个算法检测环引用
，所以也尽可放心使用这个树结构，不必担心内存泄漏。只不过存在环引用时，垃圾回收
的时机可能相对滞后而已。</p>
<p>现在，让我们再考虑一种有任意多个孩子的树（任意叉树）。这种结构在实际应用中是存
在的，比如目录树，每个目录（结点）可以有很多个不确实数量的子目录或文件（叶结点
）。为表示这种结构，我们可以将所有子结点放在一个列表中，然后用一个键引用这个列
表，如下定义每个结点的字典结构：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> node = {}
</span><span>: </span><span style="color:#96b5b4;">let</span><span> node</span><span style="color:#b48ead;">.</span><span>value = </span><span style="color:#d08770;">0
</span><span>: </span><span style="color:#96b5b4;">let</span><span> node</span><span style="color:#b48ead;">.</span><span>parent = {}
</span><span>: </span><span style="color:#96b5b4;">let</span><span> node</span><span style="color:#b48ead;">.</span><span>child = []
</span></code></pre>
<p>与原来的二叉树相比，取消 <code>left</code> 与 <code>right</code> 键，而以统一的 <code>child</code> 键代替。每当
增加一个子结点时，就添加到 <code>child</code> 列表中，同时维护该子结点的 <code>parent</code> 键。如
果 <code>child</code> 键为空列表，就表示该结点为叶结点。</p>
<h3 id="tu">图</h3>
<p>图是一些顶点与边的集合，常用 <code>G(V, E)</code> 表示，其中 <code>V</code> 是顶点集合，<code>E</code> 是边集合
，每条边连接着 <code>V</code> 中两个顶点。一般用 <code>|V|</code> 表示顶点的个数，<code>|E|</code> 表示边数。</p>
<p>用程序表示图，有两种常用的方式，邻接矩阵与邻接表。这里讨论一下如何用 VimL 的数
据结构表示图。</p>
<p>邻接矩阵很简单，就是一个 <code>|V| x |V|</code> 大小的矩阵，假设就用变量名 <code>graph</code> 表示这
个矩阵。前面小节已介绍，矩阵在 VimL 中就是列表的列表。如果顶点 <code>i</code> 与 <code>j</code> 之间
有一条边，就 <code>:let graph[i][j] = 1</code>，否则就用一个特殊值来表示这两个顶点之间没
有边，比如在很多情况下用 <code>0</code> 表示无边是可行的，<code>:let grapsh[i][j] = 0</code>。如果是
有权边，则可把边的权重保存在相应的矩阵位置中，如 <code>:let graph[i][j] = w</code>。如果
是无向图，则再对称赋值 <code>:let graph[j][i] = graph[i][j]</code>。</p>
<p>由于矩阵元素支持随机访问，用邻接矩阵表示图在某些应用中非常高效简便，尤其在边数
非常稠密的情况下（极限情况是每两个顶点之间都有边的完全连通图）。不过在边数很少
的情况下，这将是个稀疏矩阵，在内存空间使用上比较低效。</p>
<p>邻接表，首先它是包含所有顶点的列表；每个顶点是一个字典结构，它至少有个键 <code>edge</code>
来保存所有与本顶点相关的边，这应是一个边结构的列表；在边结构字典中则保存着权重
<code>weight</code>，以及它所连接的顶点（字典引用）。大致结构如下所示：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> graph = [] </span><span style="color:#65737e;">&quot; a list of vertex
</span><span>: </span><span style="color:#96b5b4;">let</span><span> vertex = {</span><span style="color:#a3be8c;">&#39;edge&#39;</span><span>: [], </span><span style="color:#a3be8c;">&#39;id&#39;</span><span>:</span><span style="color:#d08770;">0</span><span>, </span><span style="color:#a3be8c;">&#39;data&#39;</span><span>: {}}
</span><span>: </span><span style="color:#96b5b4;">let</span><span> edge = {</span><span style="color:#a3be8c;">&#39;weight&#39;</span><span>:</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#a3be8c;">&#39;target&#39;</span><span>: {}, </span><span style="color:#a3be8c;">&#39;source&#39;</span><span>: {}}
</span></code></pre>
<p>如果只要求自上而下访问边结构，那这个字典中可以只保存一个顶点，另一个顶点就是它
被保存的顶点（由它的 <code>edge</code> 键访问到这个边）。这可以减少一些存储空间，不过顶点
也只是字典引用，保存双端点也浪费不了太多空间。</p>
<p>在实际的图应用中，肯定还会有具体的业务数据，这些数据一般是保存顶点结构中。比如
可以给每个顶点给个 <code>id</code> 编号或名字，如果有大量复杂的数据，可单独保存在另一个字
典引用中。</p>
<p>所以，邻接表虽然复杂，但灵活度高，易扩展业务数据。而邻接矩阵在矩阵元素中只能保
存一个值，扩展有些不方便。除非是业务数据是保存在边结构中，那么在矩阵中可以保存
另一个字典引用，而不是简单的权重数值。</p>
<h3 id="json">JSON</h3>
<p>如果你了解 JSON，就会发现 VimL 的列表与字典的语法表示，正好也是符合 JSON 标准
的。一个有效的 JSON 字符串也是合适的 VimL 的表达式，可以直接用于 <code>:let</code> 命
令的赋值。</p>
<p>当然这有一个小小的限制，JSON 字符串不能有换行，因为 VimL 语言是按行解析的，且
续行符比较特殊（在下一行开头使用反斜杠）。如果是不太复杂的 JSON，在 Vim 编辑中
可以将普通命令 <code>J</code> 将多行字符串合并为一行，我不认为你会用其他编辑器写 VimL 脚
本。</p>
<p>此外，有个内置函数 <code>jsondecode()</code> 可将一个合法的 JSON 字符串（允许多行）解析为
VimL 值，以及反函数 <code>jsonencode()</code> 将一个 VimL 表达式转换为 JSON 字符串。</p>
<h3 id="zong-jie">总结</h3>
<p>在 VimL 中，用列表与字典的组合，可以表达很复杂很精妙的数据结构，几乎只有想不到
没有做不到。其实这也不必奇怪，因为目前大部分作为高级语言的动态脚本，其思想是相
通的。虽然 VimL 似乎只能用于 Vim，但它与其他流行的外部脚本语言，在某种程序上是
极其相似的。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/"><</a>
    

            </div>

            <div class="next-link">
                
    
        <a class="next" href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">></a>
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
