<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>1.4 自动加载脚本机制</h1>
    <!-- ## 1.4\* 自动加载脚本机制 -->
<p>前文已提及，vim 脚本主要用 <code>:source</code> 命令加载，然而很多情况下又不需要手动执行
该命令。只要将脚本放在特定的目录下，vim 就有个机制能自动搜寻并加载。</p>
<h3 id="vim-cha-jian-sou-suo-mu-lu">Vim 插件搜索目录</h3>
<p>首先要知道有 <code>&amp;runtimepath</code> （常简写为 <code>&amp;rtp</code>）这个选项。它与系统的环境变量
<code>$PATH</code> 有点类似，就是一组有序的目录名称，用于 Vim 在许多不同情况下搜寻 <code>*.vim</code> 
脚本文件的。你可以在命令行输入 <code>:echo &amp;rtp</code> 查看当前运行的 vim 有哪些“运行时目
录”，一般都会包含 <code>~/.vim</code> 这个目录。</p>
<ul>
<li>除了 vim 启动时的第一个配置文件 <code>vimrc</code>，运行时需要加载的脚本，一般都是从
<code>&amp;rtp</code> 目录列表中搜索的。</li>
<li>vim 启动时，会在所有 <code>&amp;rtp</code> 目录下的 <code>plugin/</code> 搜索 <code>*.vim</code> 文件，并加载所有
找到的脚本文件。需要注意的是在 <code>plugin/</code> 子目录下的所有脚本也会自动加载。除
非你先在 vimrc 中用选项禁用加载插件这个行为。</li>
<li>当一个文件类型 <code>&amp;filetype</code> 被识别时，Vim 会从所有 <code>&amp;rtp</code> 目录下的 <code>ftplugin/</code> 
子目录中搜索以文件类型开始的脚本文件，然后加载执行。比如编辑一个 <code>cpp</code> 文件
时，<code>ftplugin/</code> 目录下的 <code>cpp.vim</code> <code>cpp_*.vim</code> <code>cpp/*.vim</code> 都会被加载。</li>
</ul>
<p>所以，我们自己写的脚本，如果想让它在 vim 启动时自动生效，就扔到
<code>~/.vim/plugin/</code> 目录下，想只针对某种文件类型生效，就扔到 <code>~/.vim/ftplugin/</code>
目录下。</p>
<p>目前主流的第三方插件，也会遵循这种子目录规范，然后安装时一般会将整个目录添加到
<code>&amp;rpt</code> 中，以便让 Vim 找到对应的脚本。</p>
<h3 id="viml-de-zi-dong-jia-zai-han-shu-yan-shi-jia-zai">VimL 的自动加载函数（延时加载）</h3>
<p>Vim 一直有个追求的目标是启动快。当插件越来越多时，vim 启动时要解析大量的脚本文
件，就会被拖慢了。这时就出现了一个 <code>autoload</code> 自动加载函数的机制，这个巧妙的方
法可算是 VimL 发展的一个里程碑吧。而在这之前，须由用户在 <code>plugin/*.vim</code> 的复杂
脚本中用极具巧妙的编程技巧，才好实现延时加载。</p>
<p>虽然还没有讲到 VimL 的函数，但也可以在这里解释自动加载函数的原理与过程，毕竟这
不需要涉及到函数的具体实现。</p>
<p>例如，有一个 <code>~/.vim/autoload/foo.vim</code> 脚本（或在其他任一个 <code>&amp;rtp</code> 目录下的 
<code>autoload/</code> 子目录也行），该脚本内定义一个函数 <code>foo#bar()</code>，其中 <code>#</code> 之前的部
分必须与脚本文件名 <code>foo.vim</code> 相同。将有以下故事发生：</p>
<ul>
<li>在 vim 启动时，完全不会读取 <code>foo.vim</code> 文件，也不知道它里面可能定义了什么复杂
的脚本内容。</li>
<li>当 <code>foo#bar()</code> 第一次被调用时，比如从命令行中执行 <code>:call foo#bar()</code>，vim 发
现 <code>foo#bar</code> 这个函数未定义，就会试图从这个函数名分析出它可能定义于 <code>foo.vim</code>
文件中。然后就从 <code>&amp;rtp</code> 目录列表中，依次寻找其中 <code>autoload/</code> 子目录的
<code>foo.vim</code> 文件。将所找到的第一个 <code>foo.vim</code> 脚本加载，并停止继续寻找。如果在
所有 <code>&amp;rtp</code> 目录下都找不到，那就是个错误了。</li>
<li>加载（即 <code>:source</code>）完 <code>foo.vim</code> ，再次响应 <code>:call foo#bar()</code> 的函数调用，就
能正常执行了。</li>
<li>如果 <code>foo.vim</code> 文件中其实并没有定义 <code>foo#bar()</code> 这个函数，比如手误把函数名写
错了，写成了 <code>foo#Bar()</code>，则 vim 在二次尝试执行 <code>:call foo#bar()</code> 时依然报错
说“函数未定义”。</li>
<li>如果此后再次调用 <code>:call foo#bar()</code>，由于文件已加载，该函数是已定义的了，vim
就不需要再次寻找 <code>foo.vim</code> 文件了，直接执行就是。</li>
<li>如果 <code>foo.vim</code> 文件中还定义了一个 <code>foo#bar2()</code> 函数，由于之前是加载整个文件
，<code>foo#bar2()</code> 也是个已定义函数，也就可以直接调用到 <code>:call foo#bar2()</code>。</li>
<li>如果尝试调用一个 <code>foo.vim</code> 文件中根本不存在函数，如 <code>:call foo#nobar()</code>。即
使之前已经加载过 <code>foo.vim</code> 一次，由于这个 <code>foo#nobar</code> 函数未定义，vim 会再次
从 <code>&amp;rtp</code> 目录找到这个 <code>foo.vim</code> 文件再加载一次，然后再尝试 <code>:call foo#nobar()</code> 依然出错报错。</li>
</ul>
<p>各种细节过程可能很复杂，但总体思想还是很简单，就是延时加载，只有在必要时才额外
加载脚本。从用户使用角度，只要注意几点：</p>
<ul>
<li>函数名 <code>foo#bar()</code> 必须与文件名 <code>foo.vim</code> 完全一致（大小写也最好一致）。如果
脚本是在 <code>autoload</code> 的深层子目录下，那函数名也必须是相对于 <code>autoload</code> 的路径
名，把路径分隔符 <code>/</code> 替换为 <code>#</code> 就是。即在 <code>autoload/path/to/foo.vim</code> 文件中
定义的函数名应该是 <code>path#to#foo#bar()</code>。</li>
<li>从使用便利性上，一般是会定义快捷键或命令来调用 <code>#</code> 函数，并在首次使用时触发
相关脚本的加载。</li>
<li><code>#</code> 函数是全局作用域的，也可以认为各层 <code>#</code> 是完整的命名空间，当然从任何地方
访问时都须使用路径全名，即使从相同的脚本内访问也须用全名。</li>
<li>全局变量也可以用 <code>#</code> 命名，如 <code>g:path#to#foo#varname</code> 也能触发相应脚本文件的
自动（延时）加载，不过一般没有函数应用那么广泛。</li>
<li>尽量将复杂业务逻辑代码写在 <code>#</code> 自动加载函数中，有时要注意不同 <code>&amp;rtp</code> 目录下
同名文件的屏蔽效应。</li>
</ul>
<p>利用 VimL 的这个自动加载机制，还有效地避免了全局变量（函数）名的冲突问题，因为
函数名包含了路径名，而一般文件系统下是不会有重名文件的。唯一的问题是，这个函数
名有点长。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch01-viml-feature/"><</a>
    

            </div>

            <div class="next-link">
                
    
        
        
        
        
            
            
            
        
            
            
            
                
            
                
            
                
            
                
                    
                
            
        
            
            
                <a class="next" href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">></a>
                
                
            
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
        
            
            
            
                
            
                
            
                
            
        
            
            
            
        
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
