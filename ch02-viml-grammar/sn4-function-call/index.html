<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>2.4 函数定义与使用</h1>
    <!-- ## 2.4 函数定义与使用 -->
<p>函数是可重复调用的一段程序单元。在用程序解决一个比较大的功能时，知道如何拆分多
个小功能，尤其是多次用到的辅助小功能，并将它们独立为一个个函数，是编程的基本素
养吧。</p>
<h3 id="viml-han-shu-yu-fa">VimL 函数语法</h3>
<p>在 VimL 中定义函数的语法结构如下：（另参考 <code>:help :function</code>）</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>[!] 函数名(参数列表) 附加属性
</span><span>    函数体
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>在其他地方调用函数时一般用 <code>:call</code> 命令，这能触发目标函数的函数体开始执行，以
产生它所设计的功效。如果要接收函数的返回值，则不宜用 <code>:call</code> 命令，可用 <code>:echo</code> 
观察函数的返回结果，或者用 <code>:let</code> 定义一个变量保存函数的返回结果。实际上，函数
调用是一个表达式，任何需要表达式的地方，都可植入函数调用。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>call 函数名(参数)
</span><span style="color:#96b5b4;">echo</span><span> 函数名(参数)
</span><span style="color:#96b5b4;">let</span><span> 返回值 = 函数名(参数)
</span></code></pre>
<p>注：这里为了阐述方便，除了关键命令，直接用中文名字描述了。因而不是有效代码，在
每行的前面也就不加 <code>:</code> 了。</p>
<h3 id="han-shu-ming">函数名</h3>
<p>函数名的命令规则，除了要遵循普通变量的命令规则外，还有条特殊规定。如果函数是在
全局作用域，则只能以大写字母开头。</p>
<p>因为 vim 内建的命令与函数都以小写字母开始，而且随着版本提升，增加新命令与函数
也是司空见惯的事。所以为了方便避免用户自定义命令与函数的冲突，它规定了用户定义
命令与函数时必须以大写字母开头。从可操作 Vim 的角度，函数与命令在很大程度上是
有些相似功能的。当然，如果将 VimL 视为一种纯粹的脚本语言，那函数也可以做些与
Vim 无关的事情。</p>
<p>习惯上，脚本中全局变量时会加 <code>g:</code> 前缀，但全局函数一般不加 <code>g:</code> 前缀。全局函数
是期望用户可以直接从命令行用 <code>:call</code> 命令调用的，因而省略 <code>g:</code> 前缀是有意义的
。当然更常见的是将函数调用再重映射为自定义命令或快捷键。</p>
<p>除了接口需要定义在全局作用域的函数外，其他一些辅助与实现函数更适合定义为脚本作
用域的函数，即以 <code>s:</code> 前缀的函数，此时函数名不强制要求以大写字母开头。毕竟脚
本作用域的函数，不可能与全局作用域的内建函数冲突了。</p>
<h3 id="han-shu-fan-hui-zhi">函数返回值</h3>
<p>函数体内可以用 <code>:return</code> 返回一个值，如果没有 <code>:return</code> 语句，在函数结束后默认
返回 <code>0</code>。请看以下示例：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">Foo</span><span>()
</span><span>:     </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;I am in Foo()&#39;
</span><span>: </span><span style="color:#b48ead;">endfunction
</span><span>:
</span><span>: </span><span style="color:#96b5b4;">let</span><span> ret = </span><span style="color:#8fa1b3;">Foo</span><span>()
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> ret
</span></code></pre>
<p>你可以将这段代码保存在一个 <code>.vim</code> 脚本文件中，然后用 <code>:source</code> 加载执行它。如
果你也正在用 vim 读该文档，可以用 <code>V</code> 选择所有代码行再按 <code>y</code> 复制，然后在命令
行执行 <code>:@&quot;</code>，这是 Vim 的寄存器用法，这里不准备展开详述。如果你在用其他工具读
文档，原则上也可以将代码复制粘贴至 vim 的命令行中执行，但从外部程序复制内容至
vim 有时会有点麻烦，可能还涉及你的 <code>vimrc</code> 配置。因此还是复制保存为 <code>.vim</code> 文
件再 <code>:source</code> 比较通用。</p>
<p>这段示例代码执行后，会显示两行，第一行输出表示它进到了函数 <code>Foo()</code> 内执行了，
第二行输出表明它的默认返回值是 <code>0</code>。这个默认返回值的设定，可以想像为错误码，当
函数正常结束时，返回 <code>0</code> 是很正常的事。</p>
<p>当然，根据函数的设计需求，可以显式地返回任何表达式或值。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">Foo</span><span>()
</span><span>:     </span><span style="color:#b48ead;">return </span><span style="color:#8fa1b3;">range</span><span>(</span><span style="color:#d08770;">10</span><span>)
</span><span>: </span><span style="color:#b48ead;">endfunction
</span><span>:
</span><span>: </span><span style="color:#96b5b4;">let</span><span> ret = </span><span style="color:#8fa1b3;">Foo</span><span>()
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> ret
</span></code></pre>
<p>执行此例将打印出一个列表，这个列表是由函数 <code>Foo()</code> 生成并返回的。</p>
<p>注意一个细节，这里的 <code>:function!</code> 命令必须加 <code>!</code> 符号，因为它正在重定义原来存
在的 <code>Foo()</code> 函数。如果没有 <code>!</code> ，vim 会阻止你重定义覆盖原有的函数，这也是一种
保护机制吧。用户加上 <code>!</code> 后，就认为用户明白自己的行为就是期望重定义同名函数。</p>
<p>一般在写脚本时，在脚本内定义的函数，建议始终加上 <code>!</code> 强制符号。因为你在调试时
可能经常要改一点代码后重新加载脚本，若没有 <code>!</code> 覆盖指令，则会出错。然后在脚本
调试完毕后，函数定义已定稿的情况下，假使由于什么原因也重新加载了脚本，也不外是
将函数重定义为与原来一样的函数而已，大部分情况下这不是问题。（最好是在正常使用
脚本时，能避免脚本的重新加载，这需要一些技巧）</p>
<p>不过这需要注意的是，避免不同脚本定义相同的全局函数名。</p>
<h3 id="han-shu-can-shu">函数参数</h3>
<p>在函数定义时可以在参数表中加入若干参数，然后在调用时也须使用相同数量的参数：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">Sum</span><span>(x, y)
</span><span>:     </span><span style="color:#b48ead;">return </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>x + </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>y
</span><span>: </span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>: </span><span style="color:#96b5b4;">let</span><span> x = </span><span style="color:#d08770;">2
</span><span>: </span><span style="color:#96b5b4;">let</span><span> y = </span><span style="color:#d08770;">3
</span><span>: </span><span style="color:#96b5b4;">let</span><span> ret = </span><span style="color:#8fa1b3;">Sum</span><span>(x, y)
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> ret
</span></code></pre>
<p>在本例中定义了一个简单的求和函数，接收两个参数；然后调用者也传入两个参数，运行
结果毫无惊喜地得到了结果 <code>5</code> 。</p>
<p>这里必须要指出的是，在函数体内使用参数 <code>x</code> 时，必须加上参数作用域前缀 <code>a:</code>，即
用 <code>a:x</code> 才是参数中的 <code>x</code> 形参变量。<code>a:x</code> 与函数之外的 <code>x</code> 变量（实则是 <code>g:x</code>
）毫无关系，如果在函数内也创建了个 <code>x</code> 变量（实则是 <code>l:x</code>），<code>a:x</code>与之也无关系
，他们三者是互不冲突相扰的变量。</p>
<p>参数还有个特性，就是在函数体内是只读的，不能被重新赋值。其实由于函数传参是按值
传递的。比如在上例中，调用 <code>Sum(x, y)</code> 时，是把 <code>g:x</code> 与 <code>g:y</code> 的值分别拷贝给
参数 <code>a:x</code> 与 <code>a:y</code> ，你即使能对 <code>a:x</code> <code>a:y</code> 作修改，也不会影响外面的 <code>g:x</code>
<code>g:y</code>，函数调用结束后，这种修改毫无影响。然而，VimL 从语法上保证了参数不被修改
，使形参始终保存着当前调用时实参的值，那是更加安全的做法。</p>
<p>为了更好地理解参数作用域，改写上面的代码如下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">Sum</span><span>(x, y)
</span><span>:     </span><span style="color:#96b5b4;">let</span><span> x = </span><span style="color:#a3be8c;">&#39;not used x&#39;
</span><span>:     </span><span style="color:#96b5b4;">let</span><span> y = </span><span style="color:#a3be8c;">&#39;not used y&#39;
</span><span>:
</span><span>:     </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;g:x = &#39; </span><span style="color:#b48ead;">. </span><span style="color:#bf616a;">g:x
</span><span>:     </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;l:x = &#39; </span><span style="color:#b48ead;">. </span><span style="color:#bf616a;">l:x
</span><span>:     </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;a:x = &#39; </span><span style="color:#b48ead;">. </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>x
</span><span>:     </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;x = &#39; </span><span style="color:#b48ead;">.</span><span> x
</span><span>:
</span><span>:     </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:sum</span><span> = </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>x + </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>y
</span><span>:     </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">l:sum
</span><span>: </span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>: </span><span style="color:#96b5b4;">let</span><span> x = </span><span style="color:#d08770;">2
</span><span>: </span><span style="color:#96b5b4;">let</span><span> y = </span><span style="color:#d08770;">3
</span><span>: </span><span style="color:#96b5b4;">let</span><span> ret = </span><span style="color:#8fa1b3;">Sum</span><span>(</span><span style="color:#d08770;">-2</span><span>, </span><span style="color:#d08770;">-3</span><span>)
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> ret
</span></code></pre>
<p>在这个例子中，调用函数 <code>Sum()</code> 时，不再传入全局作用域的 <code>x</code> <code>y</code> 了，另外传入两
个常量，然后在函数体内查看各个作用域的 <code>x</code> 变量值。</p>
<p>结果表明，在函数体内，直接使用 <code>x</code> 代表的是 <code>l:x</code>，如果在函数内没定义局部变量
<code>x</code>，则使用 <code>x</code> 是个错误，它也不会扩展到全局作用域去取 <code>g:x</code> 的值。如果要在函
数内使用全局变量，必须指定 <code>g:</code> 前缀，同样要使用参数也必须使用 <code>a:</code> 前缀。</p>
<p>虽然在函数体内默认的变量作用域就是 <code>l:</code> ，但我还是建议在定义局部变量时显式地
写上 <code>l:</code>，就如定义 <code>l:sum</code> 这般。虽然略显麻烦，但语义更清晰，更像 VimL 的风格
。函数定义一般写在脚本文件，只用输入一次，多写两字符不多的。</p>
<p>至于脚本作用域变量，读者可自行将示例保存在文件中，然后也创建 <code>s:x</code> <code>s:y</code> 变量
试试。当然了，在正常的编程脚本中，请不要故意在不同作用域创建同名变量，以避免不
必要的麻烦。（除非在某些特定情境下，按设计意图有必要用同名变量，那也始终注意加
上作用域前缀加以区分）</p>
<h3 id="han-shu-shu-xing-abort">函数属性：abort</h3>
<p>VimL 在定义函数时，在参数表括号之后，还可以选择指定几个属性。虽然在帮助文档
<code>:help :function</code> 中也称之为 <code>argument</code>，不过这与在调用时要传入的参数是完全不
同的东西。所以在这我称之为函数属性。文档中称之为 <code>argument</code> 是指它作为
<code>:function</code> 这个 <code>ex 命令</code> 的参数，就像我们要定义的函数名、参数表也是这个命令
的 “参数”。</p>
<p>至 Vim8.0 ，函数支持以下几个特殊属性：</p>
<ul>
<li><code>abort</code>，中断性，在函数体执行时，一旦发现错误，立即中断运行。</li>
<li><code>range</code>，范围性，函数可隐式地接收两个行地址参数。</li>
<li><code>dict</code>， 字典性，该函数必须通过字典键来调用。</li>
<li><code>closure</code>，闭包性，内嵌函数可作为闭包。</li>
</ul>
<p>其中后面两个函数属性涉及相对高深的话题，留待第五章的函数进阶继续讨论。这里先只
讨论前两个属性。</p>
<p>为理解 <code>abort</code> 属性，我们先来看一下，vim 在执行命令时，遇到错误会怎么办？</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: echomsg </span><span style="color:#a3be8c;">&#39;before error&#39;
</span><span>: echomsg error
</span><span>: echomsg </span><span style="color:#a3be8c;">&#39;after error&#39;
</span></code></pre>
<p>在这个例子中，第二行是个错误，因为 <code>echo</code> 要求表达式参数，但 <code>error</code> 这个词是
未定义变量。这里用 <code>echomsg</code> 代替 <code>echo</code> 是因为 <code>echomsg</code> 命令的输出会保存在
vim 的消息区，此后可以用 <code>:message</code> 命令重新查看；而 <code>echo</code> 只是临时查看。</p>
<p>将这几行语句写入一个临时脚本，比较 <code>~/.vim/vimllearn/cmd.vim</code> ，然后用命令加载
<code>:source ~/.vim/vimllearn/cmd.vim</code> 。结果表明，虽然第二行报错了，但第三行仍然
执行了。</p>
<p>不过，如果在 vim 下查看该文档，将这几行复制到寄存器中，再用 <code>:@&quot;</code> 运行，第三行
语句就似乎不能被执行到了。然而这不是主流用法，可先不管这个差异。</p>
<p>然后，我们将错误语句放在一个函数中，看看怎样？</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">Foo</span><span>()
</span><span>:     echomsg </span><span style="color:#a3be8c;">&#39;before error&#39;
</span><span>:     echomsg error
</span><span>:     echomsg </span><span style="color:#a3be8c;">&#39;after error&#39;
</span><span>: </span><span style="color:#b48ead;">endfunction
</span><span>:
</span><span>: echomsg </span><span style="color:#a3be8c;">&#39;before call Foo()&#39;
</span><span>: call </span><span style="color:#8fa1b3;">Foo</span><span>()
</span><span>: echomsg </span><span style="color:#a3be8c;">&#39;after call Foo()&#39;
</span></code></pre>
<p>将这个示例保存在 <code>~/.vim/vimllearn/t_abort1.vim</code>，然后 <code>:source</code> 运行。结果错
误之后的语句也都将继续执行。</p>
<p>在函数定义行末加上 <code>abort</code> 参数，改为：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">Foo</span><span>() abort
</span></code></pre>
<p>重新 <code>:source</code> 执行。结果表明，在函数体内错误之后的语句不再执行，但是调用这个
出错函数之后的语句仍然执行。</p>
<p>现在你应该明白 <code>abort</code> 这个函数属性的意义了。一个良好的编程习惯是，始终在定义函数时
加上这个属性。因为一个函数我们期望它执行一件相对完整独立的工作，如果中间出错了
，为何还有必要继续执行下去。立即终止这个函数，一方面便于跟踪调试，另一方面避免
在错误的状态下继续执行可能造成的数据损失。</p>
<p>那为什么 vim 的默认行为是容忍错误呢？想想你的 <code>vimrc</code> ，如果中间某行不慎出错了
，如果直接终止运行脚本，那你的初始配置可能加载很不全了。Vim 在最初提供函数功能
，可能也只是作为简单的命令包装重用，所以延续了这种默认行为。但是当 VimL 的函数
功能可以写得越来越复杂时，为了安全性与调试，立即终止的 <code>abort</code> 行为就很有必要
了。</p>
<p>如果你写的某个函数，确实有必要利用容忍错误这个默认特性，当然你可以选择不加
<code>abort</code> 这个属性。不过最好还是重新想想你的函数设计，如果真有这需求，是否直接写
在脚本中而不要写在函数中更合适些。</p>
<h3 id="han-shu-shu-xing-range">*函数属性：range</h3>
<p>函数的 <code>range</code> 属性，表明它很好地继承了 Vim 风格，因为很多命令之前都支持带行地
址（或数字）参数的。不过 <code>range</code> 只影响一些特定功能的函数与函数使用方式，而在
其他情况下，有没有 <code>range</code> 属性影响似乎都不大。</p>
<p>首先，只有在用 <code>:call Fun()</code> 调用函数时，在 <code>:call</code> 之前有行地址（也叫行范围）
参数时，<code>Fun()</code> 函数的 <code>range</code> 属性才有可能影响。</p>
<p>那么，什么又是行地址参数呢。举个例子，你在 Vim 普通模式下按 <code>V</code> 进入选择模式，
选了几行之后，按冒号 <code>:</code>，然后输入 <code>call Fun()</code>。你会发现，在选择模式下按冒号
进入 ex 命令行时，vim 会自动在命令行加上 <code>'&lt;,'&gt;</code>。所以你实际将要运行的命令是
<code>:'&lt;,'&gt;call Fun()</code>。<code>'&lt;</code> 与 <code>'&gt;</code> 是两个特殊的 <code>mark</code> 位置，分别表示最近选区的
第一行与最后一行。你也可以手动输入地址参数，比如 <code>1,5call Fun()</code> 或 <code>1,$call Fun()</code>，其中 <code>$</code> 是个特殊地址，表示最后一行，当前行用 <code>.</code> 表示，还支持 <code>+</code> 与
<code>-</code> 表示相对当前行的相对地址。</p>
<p>总之，当用带行地址参数的 <code>:{range}call</code> 命令调用函数时，其含义是要在这些行范围
内调用一个函数。如果该函数恰好指定了 <code>range</code> 属性，那么就会隐式地额外传两个参数
给这个函数，<code>a:firstline</code> 表示第一行，<code>a:lastline</code> 表示最后一行。</p>
<p>比如若用 <code>:1,5call Fun()</code> 调用已指定 <code>range</code> 属性的函数 <code>Fun()</code> ，那么在
<code>Fun()</code> 函数体内就能直接使用 <code>a:firstline</code> 与 <code>a:lastline</code> 这两个参数了，其值
分别为 <code>1</code> 与 <code>5</code>。如果用 <code>:'&lt;,'&gt;call Fun()</code> 调用，vim 也会自动从标记中计算出
实际数字地址来传给 <code>a:firstline</code> 与 <code>a:lastline</code> 参数。函数调用结束后，光标回
到指定范围的第 1 行，也就是 <code>a:firstline</code> 那行。</p>
<p>如果用 <code>:1,5call Fun()</code> 调用时，<code>Fun()</code> 却没指定 <code>range</code> 属性时。那又该怎办，
<code>Fun()</code> 函数内没有 <code>a:firstline</code> 与 <code>a:lastline</code> 参数来接收地址啊？此时，vim
会采用另一种策略，在指定的行范围内的每一行调一次目标函数。按这个实例，vim 会调
用 5 次 <code>Fun()</code> 函数，每次调用时分别将当前光标置于 1 至 5 行，如此在 <code>Fun()</code>
函数内就可直接操作 “当前行” 了。整个调用结束后，光标停留在范围内的最后一行。</p>
<p>函数的 <code>range</code> 属性的工作原理就是这样，然则它有什么用呢？如果函数在操作 vim 中
的当前 buffer 是极有用的。举个例子：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#65737e;">&quot; File: ~/.vim/vimllearn/frange.vim
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">NumberLine</span><span>() abort
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:sLine</span><span> = </span><span style="color:#8fa1b3;">getline</span><span>(</span><span style="color:#a3be8c;">&#39;.&#39;</span><span>)
</span><span>    </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:sLine</span><span> = </span><span style="color:#8fa1b3;">line</span><span>(</span><span style="color:#a3be8c;">&#39;.&#39;</span><span>) </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39; &#39; </span><span style="color:#b48ead;">. </span><span style="color:#bf616a;">l:sLine
</span><span>    call </span><span style="color:#8fa1b3;">setline</span><span>(</span><span style="color:#a3be8c;">&#39;.&#39;</span><span>, </span><span style="color:#bf616a;">l:sLine</span><span>)
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">NumberLine2</span><span>() abort range
</span><span>    </span><span style="color:#b48ead;">for </span><span style="color:#bf616a;">l:line </span><span style="color:#b48ead;">in </span><span style="color:#8fa1b3;">range</span><span>(</span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>firstline, </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>lastline)
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:sLine</span><span> = </span><span style="color:#8fa1b3;">getline</span><span>(</span><span style="color:#bf616a;">l:line</span><span>)
</span><span>        </span><span style="color:#96b5b4;">let </span><span style="color:#bf616a;">l:sLine</span><span> = </span><span style="color:#bf616a;">l:line </span><span style="color:#b48ead;">. </span><span style="color:#a3be8c;">&#39; &#39; </span><span style="color:#b48ead;">. </span><span style="color:#bf616a;">l:sLine
</span><span>        call </span><span style="color:#8fa1b3;">setline</span><span>(</span><span style="color:#bf616a;">l:line</span><span>, </span><span style="color:#bf616a;">l:sLine</span><span>)
</span><span>    </span><span style="color:#b48ead;">endfor
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>finish
</span><span>
</span><span>测试行
</span><span>测试行
</span><span>测试行
</span><span>测试行
</span><span>测试行
</span></code></pre>
<p>在这个脚本中，定义了一个 <code>NumberLine()</code> 不带 <code>range</code> 属性的函数，与一个带
<code>range</code> 属性的 <code>NumberLine2()</code> 函数。它们的功能差不多，就是给当前 buffer 内的
行编号，类似 <code>set number</code> 效果，只不过把行号写在文本行之前。</p>
<p>这里用到的几个内建函数稍作解释下，<code>getline()</code> 与 <code>setline()</code> 分别表示获取与设定
文本行，它们的第一个参数都是行号，当前行号用 <code>'.'</code>表示。 <code>line('.')</code> 也表示获取
当前行号。</p>
<p>如果你正用 vim 编辑这个脚本，直接用 <code>:source %</code> 加载脚本，然后将光标移到
<code>finish</code> 之后，选定几行，按冒号进入命令行，调用 <code>:'&lt;,'&gt;call NumberLine()</code> 或
<code>:'&lt;,'&gt;call NumberLine2()</code> 看看效果。可用 <code>u</code> 撤销修改。然后可将光标移到其他地
方，手动输入数字行号代替自动添加的 <code>'&lt;,'&gt;</code> 试试看。</p>
<p>最后，关于使用 <code>range</code> 属性的几点建议：</p>
<ul>
<li>如果函数实现的功能，不涉及读取或修改当前 buffer 的文本行，完全不用管 <code>range</code>
属性。但在调用函数时，也请避免在 <code>:call</code> 之前加行地址参数，那样既无意义，还
导致重复调用函数，影响效率。</li>
<li>如果函数功能就是要操作当前 buffer 的文本行，则根据自己的需求决定是否添加
<code>range</code> 属性。有这属性时，函数只调用一次，效率高些，但要自己编码控制行号，略
复杂些。</li>
<li>综合建议就是，如果你懂 <code>range</code> 就用，不懂就不用。</li>
</ul>
<h3 id="han-shu-ming-ling">*函数命令</h3>
<p><code>:function</code> 命令不仅可用来（在脚本中）定义函数，也可以用来（在命令行中）查看函
数，这个特性就如 <code>:command</code> <code>:map</code> 一样的设计。</p>
<ul>
<li><code>:function</code> 不带参数，列出所有当前 vim 会话已定义的函数（包括参数）。</li>
<li><code>:function {name}</code> 带一个函数名参数，必须是已定义的函数全名，则打印出该函数
的定义。由此可见，vim 似乎通过函数名保存了一份函数定义代码的拷贝。</li>
<li><code>:function /{pattern}</code> 不需要全名，按正则表达式搜索函数，因为不带参数的
<code>:function</code> 可能列出太多的函数，如此可用这个命令过滤一下，但是也只会打印函数
头，不包括函数体的实现代码，即使只匹配了一个函数。</li>
<li><code>:function {name}()</code> 请不要在命令行中使用这种方式，在函数名之后再加小括号，
因为这就是定义一个函数的语法！</li>
</ul>
<h3 id="han-shu-ding-yi-snip">*函数定义 snip</h3>
<p>在实际写 vim 脚本中，函数应该是最常用的结构单元了。然后函数定义的细节还挺多，
<code>endfunction</code> 这词也有点长（脚本中不建议缩写）。如果你用过 <code>ultisnips</code> 或其他
类似的 snip 插件，则可考虑将常用函数定义的写法归纳为一个 snip。</p>
<p>作为参考示例，我将 <code>fs</code> 定义为写 <code>s:函数</code> 的代码片断模板：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>snippet fs </span><span style="color:#a3be8c;">&quot;script local function&quot;</span><span> b
</span><span style="color:#65737e;">&quot; $1: 
</span><span style="color:#b48ead;">function</span><span>! </span><span style="color:#bf616a;">s:</span><span>${</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">:</span><span>function_name}(${</span><span style="color:#d08770;">2</span><span>}) abort &quot;{{{
</span><span>	${</span><span style="color:#d08770;">3</span><span>:</span><span style="color:#65737e;">&quot; code}
</span><span style="color:#b48ead;">endfunction </span><span style="color:#65737e;">&quot;}}}
</span><span>endsnippet
</span></code></pre>
<p>关于 ultisnips 这插件的用法，请参考：https://github.com/SirVer/ultisnips</p>
<h3 id="xiao-jie">小结</h3>
<p>函数是构建复杂程序的基本单元，请一定要掌握。函数必须先定义，再调用，通过参数与
返回值与调用者交互。本节只讲了 VimL 函数的基础部分，函数的进阶用法后面另有章节
专门讨论。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/"><</a>
    

            </div>

            <div class="next-link">
                
    
        <a class="next" href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">></a>
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
