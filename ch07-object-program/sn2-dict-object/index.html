<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title></title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href="https://lymslive.github.io/vimllearn/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch00-prefcace/">
                                    
                                    前言
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/">
                                    
                                    第一章 VimL 语言主要特点
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn1-hello-world/">
                                                    
                                                    1.1 Hello World 的四种写法
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn2-from-ex-command/">
                                                    
                                                    1.2 同源 ex 命令行
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn3-week-type-strong-scope/">
                                                    
                                                    1.3 弱类型强作用域
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch01-viml-feature/sn4-autoload-schema/">
                                                    
                                                    1.4 自动加载脚本机制
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/">
                                    
                                    第二章 VimL 语言基本语法
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn1-variable-type/">
                                                    
                                                    2.1 变量与类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn2-comapare-condition/">
                                                    
                                                    2.2 选择与比较
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn3-loop-iterate/">
                                                    
                                                    2.3 循环与迭代
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn4-function-call/">
                                                    
                                                    2.4 函数定义与使用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch02-viml-grammar/sn5-exception-error/">
                                                    
                                                    2.5 异常处理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/">
                                    
                                    第三章 Vim 常用命令
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn1-option-set/">
                                                    
                                                    3.1 选项设置
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn2-key-remap/">
                                                    
                                                    3.2 快捷键重映射
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn3-custom-command/">
                                                    
                                                    3.3 自定义命令
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn4-execute-normal/">
                                                    
                                                    3.4 execute 与 normal
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn5-autocmd-event/">
                                                    
                                                    3.5 自动命令与事件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch03-viml-command/sn6-debug-command/">
                                                    
                                                    3.6 调试命令
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/">
                                    
                                    第四章 VimL 数据结构进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn1-list-string/">
                                                    
                                                    4.1 再谈列表与字符串
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn2-dictionary/">
                                                    
                                                    4.2 通用的字典结构
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn3-nest-compose/">
                                                    
                                                    4.3 嵌套组合与扩展
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch04-viml-datastruct/sn4-regex-apply/">
                                                    
                                                    4.4 正则表达式
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/">
                                    
                                    第五章 VimL 函数进阶
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn1-variable-argument/">
                                                    
                                                    5.1 可变参数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn2-function-refer/">
                                                    
                                                    5.2 函数引用
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn3-dict-function/">
                                                    
                                                    5.3 字典函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn4-closure-lambda/">
                                                    
                                                    5.4 闭包函数
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch05-viml-function/sn5-autoload-function/">
                                                    
                                                    5.5 自动函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/">
                                    
                                    第六章 VimL 内建函数使用
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn1-operate-datatype/">
                                                    
                                                    6.1 操作数据类型
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn2-operate-edit-object/">
                                                    
                                                    6.2 操作编辑对象
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn3-operate-filesystem/">
                                                    
                                                    6.3 操作系统文件
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch06-builtin-function/sn4-other-utility/">
                                                    
                                                    6.4 其他实用函数
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/">
                                    
                                    第七章 VimL 面向对象编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn1-object-intro/">
                                                    
                                                    7.1 面向对象的简介
                                                </a>
                                            </li>
                                        
                                            <li class="active">
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn2-dict-object/">
                                                    
                                                    7.2 字典即对象 
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">
                                                    
                                                    7.3 自定义类的组织管理
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/">
                                    
                                    第八章 VimL 异步编程特性
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn1-asynchronous-intro/">
                                                    
                                                    8.1 异步工作简介
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn2-asynchronous-job/">
                                                    
                                                    8.2 使用异步任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn3-channle-job/">
                                                    
                                                    8.3 使用通道控制任务
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch08-viml-asynchronous/sn4-internal-terminal/">
                                                    
                                                    8.4 使用配置内置终端
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/">
                                    
                                    第九章 VimL 混合编程
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn1-extern-filter/">
                                                    
                                                    9.1 用外部语言写过滤器
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn2-extern-interface/">
                                                    
                                                    9.2 外部语言接口编程
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch09-viml-mix-program/sn3-perl-interface/">
                                                    
                                                    9.3 Perl 语言接口开发
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/">
                                    
                                    第十章 Vim 插件管理与开发
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn1-plugin-directory/">
                                                    
                                                    10.1 典型插件的目录规范
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn2-plugin-manager/">
                                                    
                                                    10.2 插件管理器插件介绍
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href="https://lymslive.github.io/vimllearn/ch10-viml-plugin-develop/sn3-plugin-devflow/">
                                                    
                                                    10.3 插件开发流程指引
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href="https://lymslive.github.io/vimllearn/chA1-postfcace/">
                                    
                                    结语
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>7.2 字典即对象 </h1>
    <!-- ## 7.2 字典即对象 -->
<p>字典是 VimL 中最复杂全能的数据结构，基于字典，几乎就能实现面向对象风格的编程。
在本章中，我们提到 VimL 中的一个对象时，其实就是指一个字典结构变量。</p>
<h3 id="an-dui-xiang-shu-xing-fang-shi-fang-wen-zi-dian-jian">按对象属性方式访问字典键</h3>
<p>首先要了解的是一个语法糖。一般来说，访问字典某一元素的索引方法与列表是类似的，
用中括号 <code>[]</code> 表示。只不过列表是用整数索引，字典是用字符串（称为字典的键）索引
。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">echo</span><span> aList[</span><span style="color:#d08770;">0</span><span>]
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> aDict[</span><span style="color:#a3be8c;">&#39;str&#39;</span><span>]
</span></code></pre>
<p>（这里假设 <code>aList</code> 与 <code>aDict</code> 分别是已经定义的列表与字典变量）</p>
<p>如果字典的键是常量字符串，则在中括号中还得加引号，这写起来略麻烦。所以如果字典
键是简单字符串，则可以不用中括号与引号，而只用一个点号代替。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">echo</span><span> aDict</span><span style="color:#b48ead;">.</span><span>str
</span></code></pre>
<p>这就很像常规面向对象语言中访问对象属性的语法了。所谓简单字符串，就是指可作为标
识符的字符串（比如变量名）。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> aDict = {}
</span><span>: </span><span style="color:#96b5b4;">let</span><span> aDict[</span><span style="color:#a3be8c;">&#39;*any_key*&#39;</span><span>] = </span><span style="color:#d08770;">1
</span><span>: </span><span style="color:#96b5b4;">let</span><span> aDict</span><span style="color:#b48ead;">.</span><span>_plain_key_ = </span><span style="color:#d08770;">1
</span><span>: </span><span style="color:#96b5b4;">let</span><span> aDict</span><span style="color:#b48ead;">.*</span><span>any_key</span><span style="color:#b48ead;">*</span><span> = </span><span style="color:#d08770;">0</span><span>     |</span><span style="color:#65737e;">&quot; 肯定语法错误
</span></code></pre>
<p>然后要提醒的是，字典键索引也可用字符串变量，那就不能在中括号内用引号了。当要索
引的键是变量时，中括号索引语法是正统，用点号索引则不能达到类似效果，因为点号索
引只是常量键的语法糖。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> str_var = </span><span style="color:#a3be8c;">&#39;some_key&#39;
</span><span>: </span><span style="color:#96b5b4;">let</span><span> aDict[str_var] = </span><span style="color:#a3be8c;">&#39;some value&#39;
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> aDict[str_var]   |</span><span style="color:#65737e;">&quot; --&gt; some value
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> aDict</span><span style="color:#b48ead;">.</span><span>some_key   |</span><span style="color:#65737e;">&quot; --&gt; some value
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> aDict</span><span style="color:#b48ead;">.</span><span>str_var    |</span><span style="color:#65737e;">&quot; 未定义键，相当于 aDict[&#39;str_var&#39;]
</span><span>
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> aDict</span><span style="color:#b48ead;">.</span><span>{str_var}   |</span><span style="color:#65737e;">&quot; 语法错误
</span><span>: </span><span style="color:#96b5b4;">let</span><span> prefix = </span><span style="color:#a3be8c;">&#39;some_&#39;
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> aDict</span><span style="color:#b48ead;">.</span><span>{prefix}key   |</span><span style="color:#65737e;">&quot; 语法错误
</span><span>: </span><span style="color:#96b5b4;">let</span><span> prefix = </span><span style="color:#a3be8c;">&#39;a&#39;
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> {prefix}Dict</span><span style="color:#b48ead;">.</span><span>some_key |</span><span style="color:#65737e;">&quot; --&gt; some value
</span><span>: </span><span style="color:#96b5b4;">let</span><span> midfix = </span><span style="color:#a3be8c;">&#39;_&#39;
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> aDict</span><span style="color:#b48ead;">.</span><span>some{midfix}key   |</span><span style="color:#65737e;">&quot; 语法错误
</span></code></pre>
<p>上例的后半部分还演示了 VimL 的另一个比较隐晦（但或许有时算灵活有用）的语法，就
是可以用大括号 <code>{}</code> 括住字符串变量内插拼接变量名，这可以达到使用动态变量名的效果。
但是，这种拼接语法也只能用于普通变量名，并不能用于字典的键名。键名毕竟与变量名
不是同种概念。（关于大括号内插变量名的语法，请参阅 <code>:h curly-braces-names</code>）</p>
<p>总之，将字典当作对象来使用时，建议先创建一个空字典，再用点索引语法逐个添加属性
。可以在用到时动态添加属性，不过从设计清晰的角度看，尽可能集中地在一开始初始化
主要的属性，通过赋初值，还可揭示各属性应保存的值类型。例如，我们创建如下一个对
象：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> object = {}
</span><span>: </span><span style="color:#96b5b4;">let</span><span> object</span><span style="color:#b48ead;">.</span><span>name = </span><span style="color:#a3be8c;">&#39;bob&#39;
</span><span>: </span><span style="color:#96b5b4;">let</span><span> object</span><span style="color:#b48ead;">.</span><span>desc = </span><span style="color:#a3be8c;">&#39;a sample object&#39;
</span><span>: </span><span style="color:#96b5b4;">let</span><span> object</span><span style="color:#b48ead;">.</span><span>value = </span><span style="color:#d08770;">0
</span><span>: </span><span style="color:#96b5b4;">let</span><span> object</span><span style="color:#b48ead;">.</span><span style="color:#96b5b4;">data</span><span> = {}
</span></code></pre>
<p>从上例中便可望文生义，知道 <code>object</code> 有几个属性，其中 <code>name</code> 与 <code>desc</code> 是字符串
类型，<code>value</code> 是一个数字，可能用于保存一个特征值，其他一些复杂数据就暂存 <code>data</code> 
属性中吧，这是另一个字典，或也可称之为成员对象。当然了，VimL 是动态类型的语言
，在运行中可以改变保存在这些属性中的值的类型，然而为了对程序员友好，避免这样做
。</p>
<h3 id="zi-dian-jian-zhong-bao-cun-dui-xiang-fang-fa">字典键中保存对象方法</h3>
<p>如果在字典中只保存数据，那并不是很有趣。关键是在字典中也能保存函数，实际保存的
是函数引用，因为函数引用才是变量，才能保存在字典的键中，但在用户层面，函数引用
与函数的使用方式几乎一样。</p>
<p>保存在同一个字典内的数据与函数也不是孤立的，而应是有所联系。在函数内可以使用在
同一个字典中的数据。用形象的话，就是保存在字典内的函数可以操作字典本身。这就是
面向对象的封装特性。字典键中的函数引用，就是该对象的方法。</p>
<p>在 VimL 中，定义对象的方法也有专门的语法（糖），例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! object</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>() abort </span><span style="color:#65737e;">&quot; dict
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;Hello &#39; </span><span style="color:#b48ead;">.</span><span> self</span><span style="color:#b48ead;">.</span><span>name
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>: call object</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello bob
</span></code></pre>
<p>在上例中，<code>object</code> 就是已经定义的字典对象，这段代码为该对象定义了一个名为
<code>Hello</code> 的方法，也即属性键，保存的是一个匿名函数的引用；在该方法函数体内，关键
字 <code>self</code> 代表着调用时（不是定义时）的对象本身。然后就可以直接调用 <code>:call object.Hello()</code> 了，在执行该调用语句时，<code>self</code> 就是 <code>object</code> 。</p>
<p>按这种语法定义对象方法时，可以像定义其他函数一样附加函数属性，其中 <code>dict</code> 属性
是可选的，即使不指定该属性，也隐含了该属性。之所以说这也像是一个“语法糖”，是因
为这个示例相当于以下写法：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! </span><span style="color:#8fa1b3;">DF_object_Hello</span><span>() abort dict
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;Hello&#39; </span><span style="color:#b48ead;">.</span><span> self</span><span style="color:#b48ead;">.</span><span>name
</span><span style="color:#b48ead;">endfunction
</span><span style="color:#96b5b4;">let</span><span> object</span><span style="color:#b48ead;">.</span><span>Hello = </span><span style="color:#8fa1b3;">function</span><span>(</span><span style="color:#a3be8c;">&#39;DF_object_Hello&#39;</span><span>)
</span></code></pre>
<p>这里函数定义的 <code>dict</code> 属性不能省略，否则在函数体内不能用 <code>self</code>。不过这仍是伪
语法糖，因为这两者并不完全等效，后者还新增了一个全局函数，污染了函数命名空间。
而上节介绍的点索引属性，<code>object.name</code> 才是与 <code>object['name']</code> 完全等效的真语法
糖。</p>
<p>从 VimL 的语法上讲，在字典键中保存的函数引用，可以是相关的或无关的函数。但从面
向对象设计的角度看，若往对象中添加并无关联的函数，就很匪夷所思了。例如下面这个
方法：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! object</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">HellowWorld</span><span>() abort dict
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;Hello World&#39;
</span><span style="color:#b48ead;">endfunction
</span></code></pre>
<p>在这个方法内并未用到 <code>self</code>，也就是说不需要对象数据的支持，那强行放在对象中就很
没必要了。要实现这个功能，直接定义一个名为 <code>HelloWorld</code> 的全局函数（或脚本局部
函数）就可以了。</p>
<p>然而，一个函数方法是否与对象有关，这是一种抽象分析的判断，并非是从语法上函数体
内有无用到 <code>self</code> 来判断。假如上面这个 <code>object</code> 的用于打招呼的 <code>Hello()</code> 方法
另增需求，除了打印自身的名字外，还想附加一些语气符号。我们也将这个附加的需求抽
象为函数，修改如下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! object</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">EndHi</span><span>() abort dict
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#a3be8c;">&#39;!!!&#39;
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#b48ead;">function</span><span>! object</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>() abort dict
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;Hello &#39; </span><span style="color:#b48ead;">.</span><span> self</span><span style="color:#b48ead;">.</span><span>name </span><span style="color:#b48ead;">.</span><span> self</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">EndHi</span><span>()
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>: call object</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello bob!!!
</span></code></pre>
<p>这里的 <code>EndHi()</code> 方法也不需要用到 <code>self</code>，不过从它的意途上似乎与对象相关，所以
也存在字典对象的键中，也未尝不可。</p>
<p>在一些面向对象的语言中（如 C++），这种用不到对象数据的方法可设计为静态方法，它
是属于类的方法，而不是对象的方法。那么，在 VimL 中，可以如何理解类与对象的区别
呢？</p>
<h3 id="fu-zhi-lei-zi-dian-wei-dui-xiang-shi-li">复制类字典为对象实例</h3>
<p>事实上，VimL 只提供了字典这种数据结构，并没有什么特殊的对象。所以类与对象都只
能由字典来表示，从语法上无从分辨类与对象，这只能是由人（程序员）来管理。通过某
种设计约定把某个字典当作类使用，而把另一些字典当作对象来使用。</p>
<p>这首先是要理解类与对象的关系。类就是一种类型，描叙某类事物所具有的数据属性与操
作方法。对象是某类事物的具体实例，它实体拥有特定的数据，且能对其进行特定的操作
。从代码上看，类是对象的模板，通过这个模板可以创建许多相似的对象。</p>
<p>在上节的示例中，我们只创建了一个对象，名为 <code>object</code>。可以调用其 <code>Hello()</code> 方法
，效果是根据其名字打印一条欢迎致辞。如果要表达另一个对象，一个笨办法是修改其属
性的值。例如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: call object</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello bob!!!
</span><span>: </span><span style="color:#96b5b4;">let</span><span> object</span><span style="color:#b48ead;">.</span><span>name = </span><span style="color:#a3be8c;">&#39;ann&#39;
</span><span>: call object</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello ann!!!
</span></code></pre>
<p>但是，这仍然只实际存在了一个对象。如果在程序中要求同时存在两个相似的对象，那该
如何？也很容易想到，只要克隆一个对象，再修改有差异的数据即可。当然了，你不用在
源代码上复制粘贴一遍对 <code>object</code> 的定义，只要调用内置函数 <code>copy()</code>。因为有关该
对象的所有东西都已经在 <code>object</code> 中了，在 VimL 看来它就是一个字典变量而已。如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> another_object = </span><span style="color:#8fa1b3;">copy</span><span>(object)    |</span><span style="color:#65737e;">&quot; 或 deepcopy(object)
</span><span>: </span><span style="color:#96b5b4;">let</span><span> another_object</span><span style="color:#b48ead;">.</span><span>name = </span><span style="color:#a3be8c;">&#39;ann&#39;
</span><span>: call another_object</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello ann!!!
</span></code></pre>
<p>不过要注意的是，由于当初在定义 <code>object</code> 时，预设了一个字典成员属性 <code>data</code>。如
果用 <code>copy(object)</code> 浅拷贝，则新对象 <code>another_object</code> 与原对象 <code>object</code> 将共享
一份 <code>data</code> 数据，即如果改变了一个对象的 <code>data</code> 属性，另一个对象的 <code>data</code> 属性
也将改变。如果设计需求要求它们相互独立，则应该用 <code>deepcopy(object)</code> 深拷贝方法
。</p>
<p>以上用法可行，但不尽合理。因为在实际程序运行中，<code>object</code> 的状态经常变化，在一
个时刻由 <code>object</code> 复制出来的对象与另一个时刻复制的结果不尽相同，且不可预期。那
么就换一种思路。可以先定义一个特殊的字典对象，其主要作用只是用来“生孩子”，克隆
出其他对象。即它只预定义（设计）必要的属性名称，及提供通用的初值。当在程序中实
际有使用对象的需求时，再复制它创建一个新对象。于是，这个特殊的字典，就可充当类
的作用。类也是一个对象，不妨称之为类对象。</p>
<p>于是，可修改上节的代码如下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#96b5b4;">let</span><span> class = {}
</span><span style="color:#96b5b4;">let</span><span> class</span><span style="color:#b48ead;">.</span><span>name = </span><span style="color:#a3be8c;">&#39;&#39;
</span><span style="color:#96b5b4;">let</span><span> class</span><span style="color:#b48ead;">.</span><span>desc = </span><span style="color:#a3be8c;">&#39;a sample class&#39;
</span><span style="color:#96b5b4;">let</span><span> class</span><span style="color:#b48ead;">.</span><span>value = </span><span style="color:#d08770;">0
</span><span style="color:#96b5b4;">let</span><span> class</span><span style="color:#b48ead;">.</span><span style="color:#96b5b4;">data</span><span> = {}
</span><span>
</span><span style="color:#b48ead;">function</span><span>! class</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">EndHi</span><span>() abort dict
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#a3be8c;">&#39;!!!&#39;
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#b48ead;">function</span><span>! class</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>() abort dict
</span><span>    </span><span style="color:#96b5b4;">echo </span><span style="color:#a3be8c;">&#39;Hello &#39; </span><span style="color:#b48ead;">.</span><span> self</span><span style="color:#b48ead;">.</span><span>name </span><span style="color:#b48ead;">.</span><span> self</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">EndHi</span><span>()
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>: </span><span style="color:#96b5b4;">let</span><span> obj</span><span style="color:#d08770;">1</span><span> = </span><span style="color:#8fa1b3;">deepcopy</span><span>(class)
</span><span>: </span><span style="color:#96b5b4;">let</span><span> obj</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">.</span><span>name = </span><span style="color:#a3be8c;">&#39;ann&#39;
</span><span>: call obj</span><span style="color:#d08770;">1</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello ann!!!
</span><span>: </span><span style="color:#96b5b4;">let</span><span> obj</span><span style="color:#d08770;">2</span><span> = </span><span style="color:#8fa1b3;">deepcopy</span><span>(class)
</span><span>: </span><span style="color:#96b5b4;">let</span><span> obj</span><span style="color:#d08770;">2</span><span style="color:#b48ead;">.</span><span>name = </span><span style="color:#a3be8c;">&#39;bob&#39;
</span><span>: call obj</span><span style="color:#d08770;">2</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello bob!!!
</span></code></pre>
<p>这里，先定义了一个类对象，取名为 <code>class</code>。其数据属性与方法函数定义与上节的
<code>object</code> 几乎一样，不过是换了字典变量名而已。另外，既然 <code>class</code> 字典是被设计为
当作类的，不是实际的对象实例，那它的 <code>name</code> 属性最好留空。当然了，取名为
<code>noname</code> 之类的特殊字符串也许也可以，不过用空字符串当作初值足够了，且节省空间
。然后，使用这个类的代码就简单了，由 <code>deepcopy()</code> 创建新对象，然后通过对象访问
属性，调用方法。</p>
<p>这就是 VimL 所能提供的面对象支持，用很简单的模型也几乎能模拟类与对象的行为。当
然了，它并不十分完美，毕竟 VimL 设计之初就没打算（似乎也没必要）设计为面向对象
的语言。如果在命令输入以下命令查看这几个字典对象的内部结构：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">echo</span><span> class
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> obj</span><span style="color:#d08770;">1
</span><span>: </span><span style="color:#96b5b4;">echo</span><span> obj</span><span style="color:#d08770;">2
</span></code></pre>
<p>可以发现，对象 <code>obj1</code> <code>obj2</code> 与类 <code>class</code> 具有完全一样的键数量（当然了，因为是
用 <code>copy</code> 复制的呀）。VimL 本身就没有在对象 <code>obj1</code> 与类 <code>class</code> 之间建立任何联
系，是我们（程序员）自己用全复制的方式使每个对象获得类中的属性与方法。每个对象
应该有自己独立的数据，这很容易理解与接受。但是，每个对象都仍然保存着应该是通用
的方法，这似乎就有些浪费了。幸好，这只是保存函数引用，不管方法函数定义得多复杂
，每个函数引用都固定在占用很少的空间。不过，蚊子再小也是肉，如果一个类中定义了
很多方法，然后要创建（复制）很多对象，那这些函数引用的冗余也是很可观的浪费了。</p>
<p>另外，直接裸用 <code>copy()</code> 或 <code>deepcopy()</code> 创建新对象，似乎还是太粗糙了。如果数据
属性较多，还得逐一赋上自己的值，这写起来就比较麻烦。因此，可以再提炼一下，封装
一个创建新对象的方法，如：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#b48ead;">function</span><span>! class</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">new</span><span>(name) abort dict
</span><span>    </span><span style="color:#96b5b4;">let</span><span> object = </span><span style="color:#8fa1b3;">deepcopy</span><span>(self)
</span><span>    </span><span style="color:#96b5b4;">let</span><span> object</span><span style="color:#b48ead;">.</span><span>name = </span><span style="color:#96b5b4;">a</span><span style="color:#b48ead;">:</span><span>name
</span><span>    </span><span style="color:#b48ead;">return</span><span> object
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>: </span><span style="color:#96b5b4;">let</span><span> obj</span><span style="color:#d08770;">3</span><span> = class</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#a3be8c;">&#39;Ann&#39;</span><span>)
</span><span>: call obj</span><span style="color:#d08770;">3</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello Ann!!!
</span><span>: </span><span style="color:#96b5b4;">let</span><span> obj</span><span style="color:#d08770;">4</span><span> = class</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#a3be8c;">&#39;Bob&#39;</span><span>)
</span><span>: call obj</span><span style="color:#d08770;">4</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello Bob!!!
</span></code></pre>
<p>不过，仍然有上面提及的小问题，<code>class</code> 中的 <code>new()</code> 方法也会被复制到每个新建的
对象如 <code>obj3</code> 与 <code>obj4</code> 中。若说在类中提供一个 <code>new()</code> 方法很有意义，那在对象
实例中也混入 <code>new()</code> 方法就颇有点奇葩了，只能选择性忽略，不用它就假装它不存在
。当然了，如果只是想封装“创建对象”这个功能，也可用其他方式回避，这在后文再叙。</p>
<p>这里要再提醒一点是，由于 <code>new()</code> 方法是后来添加进去 <code>class</code> 类对象中的。在这之
前创建的 <code>obj1</code> <code>obj2</code> 对象是基于原来的类定义复制的，所以它并不会有 <code>new()</code> 方
法，在这之后创建的 <code>obj3</code> <code>obj4</code> 才有该方法。如果在之后给类对象添加新的属性或
（实用）方法，也将呈现这种行为，原来的旧对象实例并不能自动获得新属性或方法。有
时固然可以有意利用这种动态修改类定义的灵活特性，但更多的时候应该是注意避免这种
无意的陷阱。这也再次说明了，VimL 语法本身并不能保证对象与类之间的任何联系，其
间的联系都是“人为的假想”，或者说是程序员的设计。</p>
<h3 id="fu-zhi-zi-dian-ye-shi-ji-cheng">复制字典也是继承</h3>
<p>上文已经讲了，通过在字典中同时保存数据与函数（引用），就基本能实现（模拟）面向
对象的封装特征。然后，面向对象的另一个重要特征，继承，该如何实现呢？其实一句话
点破也很简单，也就是用 <code>copy()</code> 复制，复制，再复制。</p>
<p>接上节的例子，我们打算从 <code>class</code> 类中继承两个子类 <code>CSubA</code> 与 <code>CSubB</code> ，示例代
码如下：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span style="color:#96b5b4;">let</span><span> CSubA = </span><span style="color:#8fa1b3;">deepcopy</span><span>(class)
</span><span style="color:#b48ead;">function</span><span>! CSubA</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">EndHi</span><span>() abort dict
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#a3be8c;">&#39;$$$&#39;
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span style="color:#96b5b4;">let</span><span> CSubB = </span><span style="color:#8fa1b3;">deepcopy</span><span>(class)
</span><span style="color:#b48ead;">function</span><span>! CSubB</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">EndHi</span><span>() abort dict
</span><span>    </span><span style="color:#b48ead;">return </span><span style="color:#a3be8c;">&#39;###&#39;
</span><span style="color:#b48ead;">endfunction
</span><span>
</span><span>: </span><span style="color:#96b5b4;">let</span><span> obj</span><span style="color:#d08770;">5</span><span> = CSubA</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#a3be8c;">&#39;Ann&#39;</span><span>)
</span><span>: call obj</span><span style="color:#d08770;">5</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello Ann$$$
</span><span>: </span><span style="color:#96b5b4;">let</span><span> obj</span><span style="color:#d08770;">6</span><span> = CSubB</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">new</span><span>(</span><span style="color:#a3be8c;">&#39;Bob&#39;</span><span>)
</span><span>: call obj</span><span style="color:#d08770;">6</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()    |</span><span style="color:#65737e;">&quot; --&gt; Hello Bob###
</span></code></pre>
<p>在这两个子类中，我们只重写覆盖了 <code>EndHi()</code> 方法，让每个子类使用不同的语气符号
后缀。而基类 <code>class</code> 中的 <code>new()</code> 方法与 <code>Hello()</code> 方法，自动被继承（就是复制
啦）。其实 <code>EndHi()</code> 方法也是先复制继承了，只是立刻被覆盖了（所以必须用
<code>:function!</code> 命令，加叹号）。在使用时，也就可以直接用子类调用 <code>new()</code> 方法创建
子类对象，再子类对象调用 <code>Hello()</code> 方法。</p>
<p>至于面向对象的多态特征，对于弱类型脚本语言而言，只要实现了继承的差异化与特例化
，是天然支持多态的。例如上面的 <code>obj5</code> 与 <code>obj6</code> 虽属于不同类型，但可直接放在
一个集合（如列表）中，然后调用统一的方法：</p>
<pre data-lang="vim" style="background-color:#2b303b;color:#c0c5ce;" class="language-vim "><code class="language-vim" data-lang="vim"><span>: </span><span style="color:#96b5b4;">let</span><span> lsObject = [obj</span><span style="color:#d08770;">5</span><span>, obj</span><span style="color:#d08770;">6</span><span>]
</span><span>: </span><span style="color:#b48ead;">for</span><span> obj </span><span style="color:#b48ead;">in</span><span> lsObject
</span><span>:     call obj</span><span style="color:#b48ead;">.</span><span style="color:#8fa1b3;">Hello</span><span>()
</span><span>: </span><span style="color:#b48ead;">endfor
</span></code></pre>
<p>但是对于其他强类型语言（如 C++），却不能直接将不同类型的 <code>obj5</code> 与 <code>obj6</code> 放在
同一个数组中，才需要其他语法细节来支持多态的用法。</p>
<h3 id="xiao-jie">小结</h3>
<p>VimL 提供的字典数据结构，允许程序员写出面向对象风格的程序代码。在字典内，可同
时保存数据与函数（引用），并且在这种函数中可以用关键字 <code>self</code> 访问字典本身，因
而可以将字典视为一个对象。类、继承子类与实例化对象，都可以简单通过复制字典来达
成。只是这种全复制的方式，效率未必高，因为会将类中的方法即函数引用都复制到子类
与实例中，即使函数引用所占空间很小，也会造成一定的浪费。然而，从另一方面想，光
脚的不怕穿鞋的，VimL 本来就不讲究效率，这也不必太纠结。几乎所有的语言，面向对
象设计在给程序员带来友好的同时，都会有一定的实现效率的代价交换。</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href="https://lymslive.github.io/vimllearn/ch07-object-program/"><</a>
    

            </div>

            <div class="next-link">
                
    
        <a class="next" href="https://lymslive.github.io/vimllearn/ch07-object-program/sn3-object-organize/">></a>
    

            </div>
        </div>

        
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/elasticlunr.min.js"></script>
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/search_index.en.js"></script>
            
            <script type="text/javascript" src="https://lymslive.github.io/vimllearn/book.js"></script>
        
    </body>

</html>
